
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PHA Process Optimizer – Pro v2</title>
<style>
  :root{
    --primary:#2563eb;--primary-dark:#1e40af;--secondary:#10b981;--danger:#ef4444;--warning:#f59e0b;
    --dark:#1f2937;--light:#f9fafb;--border:#e5e7eb;--radius:12px;--shadow:0 20px 25px -5px rgba(0,0,0,.1)
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,system-ui,sans-serif;
       background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#111827;-webkit-text-size-adjust:100%}
  .container{max-width:1400px;margin:0 auto;background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;background:#111827;color:#fff;padding:18px}
  .header h1{font-size:20px;font-weight:700}
  .header-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  select#language{padding:8px 12px;border-radius:6px;border:1px solid rgba(255,255,255,.35);background:rgba(255,255,255,.12);color:#fff}
  .view-toggle{display:flex;gap:8px;background:rgba(255,255,255,.12);padding:4px;border-radius:8px}
  .view-toggle button{border:0;background:transparent;color:#fff;padding:8px 14px;border-radius:6px;cursor:pointer;font-weight:600}
  .view-toggle button.active{background:var(--primary);box-shadow:0 2px 8px rgba(37,99,235,.3)}
  .main{padding:24px}
  .tabs{display:flex;gap:8px;border-bottom:2px solid var(--border);overflow-x:auto;padding-bottom:8px}
  .tab{border:0;background:transparent;padding:10px 16px;font-weight:600;color:#374151;border-bottom:3px solid transparent;cursor:pointer;white-space:nowrap}
  .tab.active{color:var(--primary);border-bottom-color:var(--primary)}
  .tabpage{display:none;animation:fade .25s}.tabpage.active{display:block}
  @keyframes fade{from{opacity:.0;transform:translateY(6px)} to{opacity:1;transform:none}}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin:16px 0 24px}
  .group label{display:block;font-weight:700;margin:0 0 6px;color:#111827;font-size:14px}
  .group input,.group select,.group textarea{width:100%;padding:12px;border:2px solid var(--border);border-radius:8px;background:#fff;color:#212529;font-size:15px;transition:.2s}
  .group input:focus,.group select:focus,.group textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.15)}
  .group textarea{min-height:100px;resize:vertical}
  .hint{color:#6b7280;font-size:12px;margin-top:4px}
  .tablewrap{overflow:auto;border:1px solid var(--border);border-radius:8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
  th{background:var(--light);position:sticky;top:0}
  tr:hover{background:#f5f7ff}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;font-size:12px}
  .ok{background:#d1fae5;color:#065f46}.warn{background:#fee7c2;color:#92400e}.crit{background:#ffe1e1;color:#9b1c1c}
  .card{background:#f9fafb;border:1px solid var(--border);border-left:4px solid var(--warning);border-radius:10px;padding:16px;margin:12px 0}
  .photos{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
  .photo{position:relative;border-radius:8px;overflow:hidden;aspect-ratio:1;background:#eef2ff}
  .photo img{width:100%;height:100%;object-fit:cover}
  .photo button{position:absolute;top:6px;right:6px;width:28px;height:28px;border-radius:50%;border:0;background:var(--danger);color:#fff;font-weight:900;cursor:pointer}
  .btn{border:0;padding:12px 18px;border-radius:8px;font-weight:800;cursor:pointer}
  .btn.primary{background:var(--primary);color:#fff}.btn.secondary{background:#f3f4f6;border:2px solid var(--border)}
  .actions{display:flex;gap:12px;flex-wrap:wrap}
  .fab{position:fixed;right:18px;bottom:18px;width:56px;height:56px;border-radius:50%;border:0;background:var(--primary);color:#fff;font-size:22px;display:flex;align-items:center;justify-content:center;box-shadow:0 12px 25px rgba(37,99,235,.35);cursor:pointer}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .row .group{flex:1 1 220px}
  .muted{color:#6b7280}
  @media (max-width:768px){body{padding:0}.container{border-radius:0}.main{padding:16px}.group input,.group select,.group textarea{font-size:16px;min-height:44px}}
  /* Flash Control Guide Styles */
  .flash-tabs{display:flex;flex-wrap:wrap;gap:8px;border-bottom:2px solid #dee2e6;padding-bottom:8px;margin:16px 0}
  .flash-tab{border:0;background:#f8f9fa;padding:8px 12px;font-weight:600;color:#495057;border-radius:6px 6px 0 0;cursor:pointer;white-space:nowrap;transition:.2s;font-size:14px}
  .flash-tab.active{background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff}
  .flash-tab:hover:not(.active){background:#e9ecef}
  .flash-content{display:none;animation:fade .25s}.flash-content.active{display:block}
  .machine-screen{background:linear-gradient(to bottom,#1a1a1a,#0d0d0d);border-radius:10px;padding:25px;margin:25px 0;box-shadow:0 8px 25px rgba(0,0,0,.5);border:4px solid #333}
  .screen-header{background:linear-gradient(to right,#2d2d2d,#1a1a1a);color:#00ff00;padding:12px 20px;border-radius:5px;margin-bottom:20px;font-family:'Courier New',monospace;font-size:1.2em;font-weight:bold;border:2px solid #00ff00;box-shadow:0 0 15px rgba(0,255,0,.3);display:flex;justify-content:space-between;align-items:center}
  .screen-time{font-size:.9em;opacity:.8}
  .parameter-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:15px;margin-top:20px}
  .parameter{background:#2d2d2d;padding:18px;border-radius:8px;border:2px solid #444;transition:all .3s}
  .parameter:hover{border-color:#00ff00;box-shadow:0 0 10px rgba(0,255,0,.2)}
  .parameter-label{color:#00bfff;font-size:.9em;margin-bottom:8px;font-weight:bold;text-transform:uppercase;letter-spacing:.5px}
  .parameter-value{color:#fff;font-size:1.4em;font-weight:bold;font-family:'Courier New',monospace;margin-bottom:5px}
  .parameter-unit{color:#ffaa00;font-size:.85em;margin-left:5px}
  .parameter-note{color:#999;font-size:.8em;margin-top:5px;font-style:italic}
  .stage-indicator{background:#1a1a1a;border:2px solid #ffaa00;border-radius:8px;padding:15px;margin:20px 0;color:#ffaa00;font-weight:bold}
  .process-flow{display:flex;flex-direction:column;gap:15px;margin:20px 0}
  .flow-step{display:flex;align-items:center;background:white;padding:20px;border-radius:8px;border-left:5px solid #1e3c72;box-shadow:0 2px 8px rgba(0,0,0,.1);transition:transform .3s}
  .flow-step:hover{transform:translateX(10px);box-shadow:0 4px 12px rgba(0,0,0,.15)}
  .flow-number{background:linear-gradient(135deg,#1e3c72,#2a5298);color:white;width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5em;font-weight:bold;margin-right:20px;flex-shrink:0}
  .flow-content{flex:1}
  .flow-title{font-size:1.2em;font-weight:bold;color:#1e3c72;margin-bottom:8px}
  .flow-description{color:#666;line-height:1.6}
  .checklist{background:#f8f9fa;padding:20px;border-radius:8px;margin:20px 0}
  .checklist-item{display:flex;align-items:flex-start;padding:12px;margin:8px 0;background:white;border-radius:5px;border:1px solid #dee2e6;transition:all .3s}
  .checklist-item:hover{border-color:#1e3c72;box-shadow:0 2px 8px rgba(30,60,114,.1)}
  .checklist-checkbox{width:24px;height:24px;margin-right:15px;cursor:pointer;flex-shrink:0}
  .checklist-text{flex:1;line-height:1.6}
  .diagram{background:white;padding:30px;border-radius:10px;margin:20px 0;border:2px solid #dee2e6}
  .diagram svg{width:100%;height:auto}
  .print-button{background:#28a745;color:white;padding:12px 25px;border:none;border-radius:5px;font-size:1em;font-weight:bold;cursor:pointer;margin:10px 5px;transition:background .3s}
  .print-button:hover{background:#218838}
  .success-box{background:linear-gradient(135deg,#11998e,#38ef7d);color:white;padding:20px;border-radius:8px;margin:20px 0;border-left:5px solid #099268}
  .success-box h3{margin-bottom:10px;font-size:1.3em}
  .emphasis{color:#1e3c72;font-weight:bold}
  .calculator{background:#f8f9fa;padding:25px;border-radius:10px;margin:20px 0;border:2px solid #dee2e6}
  .calc-input-group{margin:15px 0}
  .calc-input-group label{display:block;font-weight:bold;margin-bottom:8px;color:#495057}
  .calc-input-group input{width:100%;padding:12px;border:2px solid #ced4da;border-radius:5px;font-size:1em;transition:border-color .3s;color:#212529;background:#fff}
  .calc-input-group input:focus{outline:none;border-color:#1e3c72}
  .calc-button{background:linear-gradient(135deg,#1e3c72,#2a5298);color:white;padding:12px 30px;border:none;border-radius:5px;font-size:1.1em;font-weight:bold;cursor:pointer;transition:transform .2s;margin:10px 5px}
  .calc-button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(30,60,114,.3)}
  .calc-result{background:white;padding:20px;border-radius:8px;margin-top:20px;border:2px solid #1e3c72}
  .calc-result h4{color:#1e3c72;margin-bottom:10px}
  .calc-result-value{font-size:1.8em;font-weight:bold;color:#2a5298;margin:10px 0}
  .formula{background:#f0f0f0;padding:15px;border-radius:5px;margin:15px 0;font-family:'Courier New',monospace;font-size:1.1em;border-left:4px solid #1e3c72}
  /* Process Log Styles */
  .log-container{background:#f8f9fa;padding:20px;border-radius:10px;margin:20px 0}
  .log-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px}
  .log-table{width:100%;border-collapse:collapse;background:white;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.1)}
  .log-table thead{background:linear-gradient(135deg,#1e3c72,#2a5298);color:white}
  .log-table th{padding:12px 8px;text-align:center;font-weight:bold;font-size:.9em;border-right:1px solid rgba(255,255,255,.2)}
  .log-table th:last-child{border-right:none}
  .log-table td{padding:8px 4px;text-align:center;border-bottom:1px solid #dee2e6;border-right:1px solid #dee2e6;color:#212529}
  .log-table td:last-child{border-right:none}
  .log-table tbody tr:hover{background:#f8f9fa}
  .log-table tbody tr:nth-child(even){background:#f9fafb}
  .number-input-group{display:flex;align-items:center;justify-content:center;gap:4px;min-width:100px}
  .number-input-group input{width:70px;padding:8px 4px;border:2px solid #ced4da;border-radius:4px;text-align:center;font-size:14px;-moz-appearance:textfield;color:#212529;background:#fff}
  .number-input-group input::-webkit-outer-spin-button,.number-input-group input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  .number-input-group input:focus{outline:none;border-color:#1e3c72;box-shadow:0 0 0 2px rgba(30,60,114,.1)}
  .btn-increment{width:28px;height:28px;border:none;background:linear-gradient(135deg,#2a5298,#1e3c72);color:white;border-radius:4px;cursor:pointer;font-weight:bold;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .2s}
  .btn-increment:hover{transform:scale(1.1);box-shadow:0 2px 8px rgba(30,60,114,.3)}
  .btn-increment:active{transform:scale(.95)}
  .log-note-input{width:100%;padding:8px;border:2px solid #ced4da;border-radius:4px;font-size:13px;resize:vertical;min-height:40px;color:#212529;background:#fff}
  .log-note-input:focus{outline:none;border-color:#1e3c72;box-shadow:0 0 0 2px rgba(30,60,114,.1)}
  .btn-log-action{padding:10px 20px;border:none;border-radius:5px;font-weight:bold;cursor:pointer;transition:all .2s;font-size:14px}
  .btn-add-log{background:linear-gradient(135deg,#11998e,#38ef7d);color:white}
  .btn-add-log:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(17,153,142,.3)}
  .btn-delete-log{background:#ef4444;color:white;padding:6px 12px;font-size:12px;border-radius:4px}
  .btn-delete-log:hover{background:#dc2626}
  .btn-export-log{background:#f59e0b;color:white}
  .btn-export-log:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(245,158,11,.3)}
  .btn-clear-log{background:#6b7280;color:white}
  .btn-clear-log:hover{background:#4b5563}
  .log-empty{text-align:center;padding:40px;color:#6b7280;font-style:italic}
  .log-timestamp{color:#6b7280;font-size:12px;font-style:italic}
  /* Search/Filter Styles */
  .filter-container{background:white;padding:15px;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
  .filter-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .filter-input{flex:1;min-width:200px;padding:10px;border:2px solid #ced4da;border-radius:5px;font-size:14px;color:#212529;background:#fff}
  .filter-input:focus{outline:none;border-color:#1e3c72;box-shadow:0 0 0 2px rgba(30,60,114,.1)}
  .btn-filter{padding:10px 20px;background:#1e3c72;color:white;border:none;border-radius:5px;cursor:pointer;font-weight:bold}
  .btn-filter:hover{background:#2a5298}
  /* Template Styles */
  .template-container{background:#f0f7ff;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #1e3c72}
  .template-buttons{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn-template{padding:8px 16px;background:#3b82f6;color:white;border:none;border-radius:5px;cursor:pointer;font-size:13px;font-weight:600}
  .btn-template:hover{background:#2563eb}
  .btn-template.load{background:#10b981}
  .btn-template.load:hover{background:#059669}
  .btn-template.delete{background:#ef4444}
  .btn-template.delete:hover{background:#dc2626}
  /* Photo Attachment Styles */
  .photo-upload-area{background:#f9fafb;border:2px dashed #cbd5e1;border-radius:8px;padding:20px;text-align:center;cursor:pointer;transition:all .3s;margin:10px 0}
  .photo-upload-area:hover{border-color:#1e3c72;background:#f0f7ff}
  .photo-upload-area.dragover{border-color:#1e3c72;background:#e0f2fe;transform:scale(1.02)}
  .photo-preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-top:10px}
  .photo-preview-item{position:relative;aspect-ratio:1;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.1)}
  .photo-preview-item img{width:100%;height:100%;object-fit:cover}
  .photo-remove-btn{position:absolute;top:4px;right:4px;width:24px;height:24px;background:#ef4444;color:white;border:none;border-radius:50%;cursor:pointer;font-size:16px;line-height:1;font-weight:bold}
  .photo-remove-btn:hover{background:#dc2626}
  /* Calculator/Recommendation Styles */
  .calc-recommendation{background:linear-gradient(135deg,#fef3c7,#fde68a);padding:20px;border-radius:10px;margin:20px 0;border-left:5px solid #f59e0b;box-shadow:0 4px 12px rgba(245,158,11,.2)}
  .calc-recommendation h4{color:#92400e;margin-bottom:15px;font-size:1.2em}
  .recommendation-item{background:white;padding:15px;border-radius:8px;margin:10px 0;border-left:4px solid #10b981}
  .recommendation-item.warning{border-left-color:#ef4444}
  .recommendation-item.caution{border-left-color:#f59e0b}
  .weight-calc-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:15px 0}
  .weight-input-box{background:white;padding:15px;border-radius:8px;border:2px solid #dee2e6}
  .weight-input-box label{display:block;font-weight:bold;margin-bottom:8px;color:#495057;font-size:14px}
  .weight-input-box input{width:100%;padding:10px;border:2px solid #ced4da;border-radius:5px;font-size:14px;color:#212529;background:#fff}
  .weight-input-box input:focus{outline:none;border-color:#1e3c72}
  .density-display{background:linear-gradient(135deg,#e0f2fe,#bae6fd);padding:15px;border-radius:8px;text-align:center;font-size:18px;font-weight:bold;color:#0c4a6e}
  /* Chart Container Styles */
  .chart-container{background:white;padding:20px;border-radius:10px;margin:20px 0;box-shadow:0 2px 8px rgba(0,0,0,.1)}
  .chart-controls{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
  .chart-toggle-btn{padding:8px 16px;border:2px solid #1e3c72;background:white;color:#1e3c72;border-radius:5px;cursor:pointer;font-weight:600;transition:all .2s}
  .chart-toggle-btn.active{background:#1e3c72;color:white}
  .chart-toggle-btn:hover:not(.active){background:#f0f7ff}
  @media (max-width:768px){
    .log-table{font-size:12px}
    .log-table th,.log-table td{padding:6px 3px}
    .number-input-group{min-width:80px;gap:2px}
    .number-input-group input{width:50px;font-size:12px;padding:6px 2px}
    .btn-increment{width:24px;height:24px;font-size:14px}
    .log-note-input{font-size:12px;min-height:35px}
    .btn-log-action{padding:8px 16px;font-size:13px}
    .log-header{flex-direction:column;align-items:stretch}
  }
</style>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>🔬 <span data-i18n="title">PHA Process Optimizer</span></h1>
    <div class="header-controls">
      <select id="language"><option value="ko">한국어</option><option value="en">English</option></select>
      <div class="view-toggle"><button id="btnDesktop" class="active" onclick="setView('desktop')">PC</button><button id="btnMobile" onclick="setView('mobile')">📱</button></div>
    </div>
  </div>

  <div class="main">
    <div class="tabs">
      <button class="tab active" data-tab="proc" data-i18n="tab_proc">공정 조건</button>
      <button class="tab" data-tab="ts" data-i18n="tab_ts">트러블슈팅</button>
      <button class="tab" data-tab="hist" data-i18n="tab_hist">이력 관리</button>
      <button class="tab" data-tab="ana" data-i18n="tab_ana">데이터 분석</button>
      <button class="tab" data-tab="calc" data-i18n="tab_calc">계산기</button>
      <button class="tab" data-tab="props" data-i18n="tab_props">물성 DB</button>
      <button class="tab" data-tab="photos" data-i18n="tab_photos">사진</button>
      <button class="tab" data-tab="flash" data-i18n="tab_flash">플래시 제어</button>
    </div>

    <!-- Process Conditions -->
    <section id="proc" class="tabpage active">
      <div class="grid">
        <div class="group">
          <label data-i18n="series">샘플 시리즈</label>
          <select id="grade" onchange="rebuildForm()"></select>
        </div>
        <div class="group">
          <label data-i18n="process">가공 유형</label>
          <select id="process" onchange="rebuildForm()">
            <option value="sheet">시트 압출 (Sheet)</option>
            <option value="extrusion">프로파일/일반 압출 (Extrusion)</option>
            <option value="injection">사출 성형 (Injection)</option>
            <option value="blownfilm">블로운 필름 (Blown Film)</option>
            <option value="blowmolding">블로우 몰딩 (Blow Molding)</option>
            <option value="castfilm">캐스트 필름 (Cast Film)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="group">
          <button class="btn secondary" onclick="openRecoEditor()">🛠 권장 가이드 수정</button>
          <div class="hint">현재 선택한 <b>프로파일×공정</b>에 한해 min/max를 편집합니다. ‘초기화’로 원복 가능.</div>
        </div>
      </div>

      <div id="dynamicFields" class="grid"></div>

      <div class="group">
        <label data-i18n="notes">📝 특이사항 메모</label>
        <textarea id="notes" placeholder=""></textarea>
        <div class="hint" id="tsHint"></div>
      </div>

      <div class="row">
        <input id="importCSV" type="file" accept=".csv" style="display:none" />
        <input id="importJSON" type="file" accept=".json,application/json" style="display:none" />
        <button class="btn primary" onclick="saveEntry()" data-i18n="save">저장 및 분석</button>
        <button class="btn secondary" onclick="exportHistory()" data-i18n="export">데이터 내보내기</button>
        <button class="btn secondary" onclick="triggerImport('csv')">CSV 가져오기</button>
        <button class="btn secondary" onclick="triggerImport('json')">JSON 가져오기</button>
        <button class="btn secondary" onclick="resetForm()" data-i18n="reset">초기화</button>
      </div>

      <div class="tablewrap" style="margin-top:18px">
        <table>
          <thead><tr>
            <th data-i18n="param">파라미터</th><th data-i18n="current">현재값</th>
            <th data-i18n="range">권장 범위</th><th data-i18n="status">상태</th>
          </tr></thead>
          <tbody id="paramTable"></tbody>
        </table>
      </div>
    </section>

    <!-- Troubleshooting -->
    <section id="ts" class="tabpage">
      <div id="tsContainer"></div>
    </section>

    <!-- History -->
    <section id="hist" class="tabpage">
      <div class="tablewrap">
        <table>
          <thead><tr>
            <th data-i18n="when">날짜/시간</th><th data-i18n="h_grade">샘플</th><th data-i18n="h_proc">공정</th>
            <th data-i18n="h_key">주요 파라미터</th><th data-i18n="h_result">결과</th><th data-i18n="h_note">메모</th>
          </tr></thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Analysis -->
    <section id="ana" class="tabpage" style="text-align:center">
      <div style="margin:24px 0"><h3>📊 <span data-i18n="ana_head">데이터 분석</span></h3></div>
      <div class="card" id="anaCard"><div id="anaText" class="hint">분석 데이터 로딩 중...</div></div>
    </section>

    <!-- Calculators -->
    <section id="calc" class="tabpage">
      <h3 style="margin:8px 0">🧮 공정 KPI 계산기</h3>
      <div class="card">
        <h4>① 체류시간 (Residence Time)</h4>
        <div class="row">
          <div class="group"><label>재료 밀도 (용융, kg/m³)</label><input id="kpi_rho" type="number" placeholder="900~1250"></div>
          <div class="group"><label>홀드업 용적 (L)</label><input id="kpi_holdVol" type="number" placeholder="예: 2.5"></div>
          <div class="group"><label>홀드업 질량 (kg)</label><input id="kpi_holdMass" type="number" placeholder="미입력 시 밀도×용적으로 계산"></div>
          <div class="group"><label>스루풋 (kg/h)</label><input id="kpi_rate" type="number" placeholder="예: 15"></div>
        </div>
        <div class="hint">※ 홀드업 질량 미입력 시 <b>질량 = 밀도×용적/1000</b>로 추정.</div>
        <div class="row"><div class="group"><button class="btn primary" onclick="calcResidence()">계산</button></div><div class="group"><div id="kpi_res_out" class="muted">결과: -</div></div></div>
      </div>

      <div class="card">
        <h4>② 사출품 냉각시간 예측</h4>
        <div class="row">
          <div class="group"><label>두께 t (mm)</label><input id="cool_t" type="number" placeholder="예: 2.0"></div>
          <div class="group"><label>열확산율 α (mm²/s)</label><input id="cool_alpha" type="number" placeholder="예: 0.12"></div>
          <div class="group"><label>용융온도 Tm (°C)</label><input id="cool_Tm" type="number" placeholder="예: 170"></div>
          <div class="group"><label>금형온도 Tmold (°C)</label><input id="cool_Tmold" type="number" placeholder="예: 30"></div>
          <div class="group"><label>이젝온도 Teject (°C)</label><input id="cool_Te" type="number" placeholder="예: 60"></div>
        </div>
        <div class="hint">모델: 1D 평판 냉각 근사치 <code>t_c ≈ (t²/(π²α))·ln[(T_m−T_mold)/(T_e−T_mold)]</code></div>
        <div class="row"><div class="group"><button class="btn primary" onclick="calcCooling()">계산</button></div><div class="group"><div id="cool_out" class="muted">결과: -</div></div></div>
      </div>

      <div class="card">
        <h4>③ 블로운 필름 두께</h4>
        <div class="row">
          <div class="group"><label>토출량 Q (kg/h)</label><input id="bf_Q" type="number" placeholder="예: 20"></div>
          <div class="group"><label>용융 밀도 ρ (kg/m³)</label><input id="bf_rho" type="number" placeholder="예: 950"></div>
          <div class="group"><label>금형 직경 D_die (mm)</label><input id="bf_D" type="number" placeholder="예: 80"></div>
          <div class="group"><label>BUR</label><input id="bf_BUR" type="number" step="0.1" placeholder="예: 2.5"></div>
          <div class="group"><label>테이크업 속도 v (m/min)</label><input id="bf_v" type="number" placeholder="예: 30"></div>
          <div class="group"><label>다이 갭 g (mm, 선택)</label><input id="bf_gap" type="number" placeholder="예: 1.0"></div>
        </div>
        <div class="hint">기본식: <code>t ≈ (Q/ρ) / (π·D_die·BUR·v)</code> (µm 변환 포함). 선택적으로 갭 기반 <code>t0=g/2</code>, <code>DDR=v / v_exit</code> 사용.</div>
        <div class="row"><div class="group"><button class="btn primary" onclick="calcBlownFilm()">계산</button></div><div class="group"><div id="bf_out" class="muted">결과: -</div></div></div>
      </div>
    </section>

    <!-- Materials DB -->
    <section id="props" class="tabpage">
      <div class="row">
        <div class="group">
          <label>Grade</label>
          <select id="mat_grade"></select>
        </div>
        <div class="group">
          <label>동작</label>
          <div class="row">
            <button class="btn secondary" onclick="importMatJSON()">JSON 가져오기</button>
            <button class="btn secondary" onclick="exportMatJSON()">JSON 내보내기</button>
            <button class="btn secondary" onclick="editMat()">편집</button>
          </div>
        </div>
      </div>
      <div class="tablewrap">
        <table>
          <thead><tr><th>항목</th><th>값</th><th>단위/조건</th></tr></thead>
          <tbody id="mat_tbody"></tbody>
        </table>
      </div>
      <div class="hint">※ 웹에서 직접 TDS URL을 불러오려면 CORS 제약이 있어, 간단한 로컬 서버 사용 또는 JSON 업로드 방식 권장.</div>
      <input id="mat_file" type="file" accept="application/json,.json" style="display:none">
    </section>

    <!-- Photos Tab -->
    <section id="photos" class="tabpage">
      <h3 style="margin:8px 0">📷 <span data-i18n="photos_head">Photo Manager</span></h3>
      <div class="group">
        <button class="btn primary" onclick="triggerPhotoUpload()">사진 업로드</button>
        <input id="photoUpload" type="file" accept="image/*" multiple style="display:none">
      </div>
      <div id="photoGrid" class="photos"></div>
    </section>

    <!-- Flash Control Tab -->
    <section id="flash" class="tabpage">
      <h2 style="color:#1e3c72;margin-bottom:20px">🔧 PHA 36-캐비티 플래시 제어 현장 가이드</h2>
      <p style="font-size:1.1em;color:#666;margin-bottom:20px">압력-동기형 4단 제어 + 러너 보호 통합 솔루션 (P3HB4: S1000P/A1000P | 36-캐비티 | 플래시 ≤0.02mm)</p>

      <!-- Flash Control Sub-tabs -->
      <div class="flash-tabs">
        <button class="flash-tab active" onclick="showFlashTab(0)">📋 전체 개요</button>
        <button class="flash-tab" onclick="showFlashTab(1)">⚙️ 기계 설정</button>
        <button class="flash-tab" onclick="showFlashTab(2)">🧮 계산기</button>
        <button class="flash-tab" onclick="showFlashTab(3)">📊 프로세스 플로우</button>
        <button class="flash-tab" onclick="showFlashTab(4)">✅ 체크리스트</button>
        <button class="flash-tab" onclick="showFlashTab(5)">🔧 문제 해결</button>
        <button class="flash-tab" onclick="showFlashTab(6)">📝 공정 로그</button>
        <button class="flash-tab" onclick="showFlashTab(7)">📖 사용 설명서</button>
      </div>

      <!-- Flash Tab 0: Overview -->
      <div class="flash-content active" id="flash-tab-0">
        <h3 style="color:#1e3c72;margin-bottom:20px">제어 전략 핵심 개요</h3>

        <div class="success-box">
          <h3>🎯 제어 원칙</h3>
          <p><strong>"러너가 대부분 찰 때까지는 압력 제한으로 보호하고, 캐비티 충전 이후는 캐비티압 기반으로 달린다"</strong></p>
          <p>플래시의 근본 원인은 금형 손상 또는 캐비티압이 클램프 한계를 초과하는 것입니다. 이 전략은 두 가지 원인을 모두 구조적으로 차단합니다.</p>
        </div>

        <h3 style="color:#1e3c72;margin:30px 0 15px 0">4단 제어 로직</h3>

        <div class="process-flow">
          <div class="flow-step">
            <div class="flow-number">V0</div>
            <div class="flow-content">
              <div class="flow-title">Runner-Protect (압력 제한 속도 제어)</div>
              <div class="flow-description">
                러너 체적의 약 90%까지는 <span class="emphasis">압력 상한을 걸어 중속</span>으로 채웁니다.
                상한은 클램프 대비 80% 이내로 설정하여 스프루 플래시와 전단발열을 차단합니다.
                러너에서의 과전단과 전단발열을 근본적으로 억제하는 단계입니다.
              </div>
            </div>
          </div>

          <div class="flow-step">
            <div class="flow-number">V1</div>
            <div class="flow-content">
              <div class="flow-title">캐비티 충전 고속 (92-96%)</div>
              <div class="flow-description">
                게이트 돌입 이후에는 얇은벽 충전성 확보를 위해 <span class="emphasis">고속</span>을 사용합니다.
                단, 노즐/사출압 상한을 설정해 압력 폭주를 억제합니다.
                v/p 전환은 마지막 충전 캐비티의 압력 급상승점을 트리거로 사용합니다.
              </div>
            </div>
          </div>

          <div class="flow-step">
            <div class="flow-number">V2</div>
            <div class="flow-content">
              <div class="flow-title">EoF 브레이크 (종단 감속)</div>
              <div class="flow-description">
                충전 끝(End of Fill) 4-8mm 구간에서 <span class="emphasis">선형 감속</span>으로
                압력 오버슈트를 제거합니다. 급격한 압력 상승을 방지하여 플래시 발생 위험을 낮춥니다.
              </div>
            </div>
          </div>

          <div class="flow-step">
            <div class="flow-number">V3</div>
            <div class="flow-content">
              <div class="flow-title">보압 램프-인/조기 종료</div>
              <div class="flow-description">
                게이트 동결 시점을 산정하고 <span class="emphasis">P1(짧게) → P2(낮게)</span> 2단 램프로 유지한 뒤
                동결 직후 즉시 종료합니다. 멀티 캐비티의 비동시 동결에 대응하기 위해
                최악 경로(최후 동결 캐비티) 기준으로 보압을 종료합니다.
              </div>
            </div>
          </div>
        </div>

        <h3 style="color:#1e3c72;margin:30px 0 15px 0">보조 제어 요소</h3>

        <table>
          <thead>
            <tr>
              <th>구분</th>
              <th>제어 방법</th>
              <th>목적</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>러너 전단 관리</strong></td>
              <td>러너 R 증대 또는 V0 속도 하향</td>
              <td>전단률 억제로 전단발열·점도붕괴 방지</td>
            </tr>
            <tr>
              <td><strong>스프루 국부 냉각</strong></td>
              <td>스프루/1차 분기에 -2~-5°C 저온 인서트</td>
              <td>파팅 라인에 씰링 스킨 조기 형성</td>
            </tr>
            <tr>
              <td><strong>게이트 동결 균질화</strong></td>
              <td>게이트 구경 ±0.02mm 미세 조정</td>
              <td>동결 시간 편차 ≤0.1s로 균질화</td>
            </tr>
            <tr>
              <td><strong>용융 안정성</strong></td>
              <td>최저 용융온도, 체류시간·rpm·백프레셔 저감</td>
              <td>PHA β-elimination 열분해 억제, MW 보존</td>
            </tr>
            <tr>
              <td><strong>결정화 가속</strong></td>
              <td>BN·탈크 0.05-0.20 wt% 저농도 첨가</td>
              <td>Tc 상승·t½ 단축으로 스킨 조기 형성</td>
            </tr>
          </tbody>
        </table>

        <div class="warning-box">
          <h3>⚠️ PHA 재료 특성 주의사항</h3>
          <p><strong>β-elimination 열분해:</strong> PHB 계열은 약 190°C 이상에서 급속 열분해가 발생하며 분자량이 하락합니다.
          가능한 최저 용융온도로 가공하고 체류시간을 최소화해야 합니다.</p>
          <p><strong>좁은 가공창:</strong> 융점 근처에서 가공해야 하며 과열 시 가스 발생과 점도 하락이 동반됩니다.</p>
          <p><strong>느린 결정화:</strong> 일반 PE/PP 대비 결정화 속도가 느려 게이트 동결 시간이 길어질 수 있습니다.</p>
        </div>
      </div>

      <!-- Flash Tab 1: Machine Settings -->
      <div class="flash-content" id="flash-tab-1">
        <h3 style="color:#1e3c72;margin-bottom:20px">기계 설정 화면</h3>
        <button class="print-button" onclick="window.print()">🖨️ 설정값 인쇄</button>

        <!-- V0 Stage -->
        <div class="machine-screen">
          <div class="screen-header">
            <span>V0 STAGE: RUNNER PROTECTION</span>
            <span class="screen-time">러너 보호 구간</span>
          </div>
          <div class="stage-indicator">▶ 설정 목적: 러너 체적 90%까지 압력 제한 중속 충전 - 스프루 플래시 방지</div>
          <div class="parameter-grid">
            <div class="parameter">
              <div class="parameter-label">Injection Velocity V0</div>
              <div class="parameter-value">30-50<span class="parameter-unit">mm/s</span></div>
              <div class="parameter-note">중속 설정 (러너 충전용)</div>
            </div>
            <div class="parameter">
              <div class="parameter-label">Pressure Limit</div>
              <div class="parameter-value">0.8 × F_clamp/A_proj<span class="parameter-unit">bar</span></div>
              <div class="parameter-note">클램프 한계의 80% 이내</div>
            </div>
            <div class="parameter">
              <div class="parameter-label">Switchover Position</div>
              <div class="parameter-value">0.9 × V_runner<span class="parameter-unit">mm</span></div>
              <div class="parameter-note">러너 체적의 90% 지점</div>
            </div>
            <div class="parameter">
              <div class="parameter-label">Shear Rate Control</div>
              <div class="parameter-value">γ̇ = 4Q/(πR³)<span class="parameter-unit">s⁻¹</span></div>
              <div class="parameter-note">러너 전단률 모니터링</div>
            </div>
          </div>
        </div>

        <!-- V1 Stage -->
        <div class="machine-screen">
          <div class="screen-header">
            <span>V1 STAGE: HIGH-SPEED CAVITY FILL</span>
            <span class="screen-time">캐비티 고속 충전</span>
          </div>
          <div class="stage-indicator">▶ 설정 목적: 얇은벽 충전성 확보 - 게이트 돌입 후 고속 충전</div>
          <div class="parameter-grid">
            <div class="parameter">
              <div class="parameter-label">Injection Velocity V1</div>
              <div class="parameter-value">80-150<span class="parameter-unit">mm/s</span></div>
              <div class="parameter-note">얇은벽 충전용 고속</div>
            </div>
            <div class="parameter">
              <div class="parameter-label">Injection Pressure Limit</div>
              <div class="parameter-value">설정 유지<span class="parameter-unit">bar</span></div>
              <div class="parameter-note">압력 폭주 방지</div>
            </div>
            <div class="parameter">
              <div class="parameter-label">Fill Range</div>
              <div class="parameter-value">92-96<span class="parameter-unit">%</span></div>
              <div class="parameter-note">V1 작동 구간</div>
            </div>
            <div class="parameter">
              <div class="parameter-label">Cavity Pressure Sensor</div>
              <div class="parameter-value">dP/dt Peak<span class="parameter-unit">감지</span></div>
              <div class="parameter-note">마지막 충전 캐비티 기준</div>
            </div>
          </div>
        </div>

        <!-- V2 Stage -->
        <div class="machine-screen">
          <div class="screen-header">
            <span>V2 STAGE: END-OF-FILL DECELERATION</span>
            <span class="screen-time">충전 끝 감속</span>
          </div>
          <div class="stage-indicator">▶ 설정 목적: 압력 오버슈트 제거 - EoF 구간 선형 감속</div>
          <div class="parameter-grid">
            <div class="parameter">
              <div class="parameter-label">Injection Velocity V2</div>
              <div class="parameter-value">20-40<span class="parameter-unit">mm/s</span></div>
              <div class="parameter-note">선형 감속 목표 속도</div>
            </div>
            <div class="parameter">
              <div class="parameter-label">Deceleration Start Point</div>
              <div class="parameter-value">EoF -4~-8<span class="parameter-unit">mm</span></div>
              <div class="parameter-note">충전 끝 4-8mm 전</div>
            </div>
            <div class="parameter">
              <div class="parameter-label">Ramp Type</div>
              <div class="parameter-value">Linear<span class="parameter-unit">Ramp-down</span></div>
              <div class="parameter-note">선형 감속 프로파일</div>
            </div>
            <div class="parameter">
              <div class="parameter-label">Pressure Monitoring</div>
              <div class="parameter-value">실시간<span class="parameter-unit">모니터링</span></div>
              <div class="parameter-note">압력 스파이크 감지</div>
            </div>
          </div>
        </div>

        <!-- V3/Packing Stage -->
        <div class="machine-screen">
          <div class="screen-header">
            <span>V3 STAGE: PACKING PRESSURE CONTROL</span>
            <span class="screen-time">보압 제어</span>
          </div>
          <div class="stage-indicator">▶ 설정 목적: 게이트 동결까지만 보압 유지 - 과보압 방지</div>
          <div class="parameter-grid">
            <div class="parameter">
              <div class="parameter-label">Packing Pressure P1</div>
              <div class="parameter-value">30-45% × P_inj_peak<span class="parameter-unit">bar</span></div>
              <div class="parameter-note">1단 보압 (짧게)</div>
            </div>
            <div class="parameter">
              <div class="parameter-label">Packing Time P1</div>
              <div class="parameter-value">0.1-0.3<span class="parameter-unit">s</span></div>
              <div class="parameter-note">1단 보압 시간</div>
            </div>
            <div class="parameter">
              <div class="parameter-label">Packing Pressure P2</div>
              <div class="parameter-value">15-30% × P_inj_peak<span class="parameter-unit">bar</span></div>
              <div class="parameter-note">2단 보압 (낮게)</div>
            </div>
            <div class="parameter">
              <div class="parameter-label">Packing Time P2</div>
              <div class="parameter-value">게이트 동결까지<span class="parameter-unit">s</span></div>
              <div class="parameter-note">중량-시간 곡선으로 결정</div>
            </div>
          </div>
          <div class="info-box">
            <h3>📌 게이트 동결(Gate Seal) 시험 방법</h3>
            <p><strong>1단계:</strong> 보압 시간을 0.5초부터 시작하여 0.5초씩 증가시키면서 샷을 진행합니다.</p>
            <p><strong>2단계:</strong> 각 샷마다 제품 무게를 정밀하게 측정합니다.</p>
            <p><strong>3단계:</strong> 무게가 더 이상 증가하지 않는 시점이 게이트 동결 시점입니다.</p>
            <p><strong>4단계:</strong> 최후 동결 캐비티 기준으로 보압 종료 시간을 설정합니다.</p>
          </div>
        </div>

        <!-- Temperature Control -->
        <div class="machine-screen">
          <div class="screen-header">
            <span>TEMPERATURE CONTROL</span>
            <span class="screen-time">온도 제어</span>
          </div>
          <div class="stage-indicator">▶ 설정 목적: 스프루 국부 냉각 + 용융 안정성 확보</div>
          <div class="parameter-grid">
            <div class="parameter">
              <div class="parameter-label">Mold Temp (Cavity)</div>
              <div class="parameter-value">T_base<span class="parameter-unit">°C</span></div>
              <div class="parameter-note">캐비티 기준 온도</div>
            </div>
            <div class="parameter">
              <div class="parameter-label">Mold Temp (Sprue/Parting)</div>
              <div class="parameter-value">T_base -2~-5<span class="parameter-unit">°C</span></div>
              <div class="parameter-note">스프루/파팅라인 저온대</div>
            </div>
            <div class="parameter">
              <div class="parameter-label">Barrel Temp (Rear Zone)</div>
              <div class="parameter-value">최저 가공온도<span class="parameter-unit">°C</span></div>
              <div class="parameter-note">PHA 열분해 억제</div>
            </div>
            <div class="parameter">
              <div class="parameter-label">Material Drying</div>
              <div class="parameter-value">65-80°C, 6-24h<span class="parameter-unit"></span></div>
              <div class="parameter-note">수분 제거 필수</div>
            </div>
            <div class="parameter">
              <div class="parameter-label">Residence Time</div>
              <div class="parameter-value">최소화<span class="parameter-unit">min</span></div>
              <div class="parameter-note">열분해 방지</div>
            </div>
            <div class="parameter">
              <div class="parameter-label">Screw RPM</div>
              <div class="parameter-value">저감<span class="parameter-unit">rpm</span></div>
              <div class="parameter-note">전단발열 억제</div>
            </div>
            <div class="parameter">
              <div class="parameter-label">Back Pressure</div>
              <div class="parameter-value">최소<span class="parameter-unit">bar</span></div>
              <div class="parameter-note">과도한 전단 방지</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Flash Tab 2: Calculator -->
      <div class="flash-content" id="flash-tab-2">
        <h3 style="color:#1e3c72;margin-bottom:20px">설정값 계산기</h3>

        <!-- Clamp Tonnage Calculator -->
        <div class="calculator">
          <h3 style="color:#1e3c72;margin-bottom:20px">1. 클램프 톤수 계산기</h3>
          <div class="calc-input-group">
            <label>캐비티 평균 압력 P_avg (bar):</label>
            <input type="number" id="flash-p-avg" placeholder="예: 500" value="500">
          </div>
          <div class="calc-input-group">
            <label>제품 투영 면적 A_proj (cm²):</label>
            <input type="number" id="flash-a-proj" placeholder="예: 2000" value="2000">
          </div>
          <button class="calc-button" onclick="calculateFlashClampTonnage()">계산하기</button>
          <button class="calc-button" onclick="clearFlashInputs('clamp')">초기화</button>
          <div class="calc-result" id="flash-clamp-result" style="display:none;">
            <h4>계산 결과</h4>
            <div class="calc-result-value" id="flash-clamp-value"></div>
            <p id="flash-clamp-recommendation"></p>
          </div>
        </div>

        <!-- Pressure Limit Calculator -->
        <div class="calculator">
          <h3 style="color:#1e3c72;margin-bottom:20px">2. V0 압력 리밋 계산기</h3>
          <div class="calc-input-group">
            <label>클램프 한계 (ton-force):</label>
            <input type="number" id="flash-f-clamp" placeholder="예: 1200" value="1200">
          </div>
          <div class="calc-input-group">
            <label>제품 투영 면적 A_proj (cm²):</label>
            <input type="number" id="flash-a-proj-2" placeholder="예: 2000" value="2000">
          </div>
          <div class="calc-input-group">
            <label>안전 계수 (권장: 0.8):</label>
            <input type="number" id="flash-safety-factor" placeholder="0.8" value="0.8" step="0.05">
          </div>
          <button class="calc-button" onclick="calculateFlashPressureLimit()">계산하기</button>
          <button class="calc-button" onclick="clearFlashInputs('pressure')">초기화</button>
          <div class="calc-result" id="flash-pressure-result" style="display:none;">
            <h4>V0 압력 리밋 설정값</h4>
            <div class="calc-result-value" id="flash-pressure-value"></div>
            <p id="flash-pressure-recommendation"></p>
          </div>
        </div>

        <!-- Shear Rate Calculator -->
        <div class="calculator">
          <h3 style="color:#1e3c72;margin-bottom:20px">3. 러너 전단률 계산기</h3>
          <div class="calc-input-group">
            <label>체적 유량 Q (cm³/s):</label>
            <input type="number" id="flash-flow-rate" placeholder="예: 50" value="50">
          </div>
          <div class="calc-input-group">
            <label>러너 반경 R (cm):</label>
            <input type="number" id="flash-runner-radius" placeholder="예: 0.4" value="0.4" step="0.1">
          </div>
          <button class="calc-button" onclick="calculateFlashShearRate()">계산하기</button>
          <button class="calc-button" onclick="clearFlashInputs('shear')">초기화</button>
          <div class="calc-result" id="flash-shear-result" style="display:none;">
            <h4>러너 벽면 전단률</h4>
            <div class="calc-result-value" id="flash-shear-value"></div>
            <p id="flash-shear-recommendation"></p>
          </div>
        </div>

        <!-- Packing Pressure Calculator -->
        <div class="calculator">
          <h3 style="color:#1e3c72;margin-bottom:20px">4. 보압 설정값 계산기</h3>
          <div class="calc-input-group">
            <label>최대 사출압 P_inj_peak (bar):</label>
            <input type="number" id="flash-p-inj-peak" placeholder="예: 1500" value="1500">
          </div>
          <button class="calc-button" onclick="calculateFlashPackingPressure()">계산하기</button>
          <button class="calc-button" onclick="clearFlashInputs('packing')">초기화</button>
          <div class="calc-result" id="flash-packing-result" style="display:none;">
            <h4>보압 설정 권장값</h4>
            <div class="calc-result-value" id="flash-packing-value"></div>
            <p id="flash-packing-recommendation"></p>
          </div>
        </div>
      </div>

      <!-- Flash Tab 3: Process Flow -->
      <div class="flash-content" id="flash-tab-3">
        <h3 style="color:#1e3c72;margin-bottom:20px">프로세스 플로우 다이어그램</h3>

        <div class="diagram">
          <h3 style="text-align:center;color:#1e3c72;margin-bottom:20px">4단 제어 프로세스 흐름도</h3>
          <svg viewBox="0 0 800 1200" xmlns="http://www.w3.org/2000/svg">
            <rect x="50" y="50" width="700" height="200" fill="#e3f2fd" stroke="#1e3c72" stroke-width="3" rx="10"/>
            <text x="400" y="90" text-anchor="middle" font-size="24" font-weight="bold" fill="#1e3c72">V0: Runner Protection</text>
            <text x="400" y="120" text-anchor="middle" font-size="16" fill="#333">압력 제한 중속 (0-90% 러너)</text>
            <text x="400" y="145" text-anchor="middle" font-size="14" fill="#666">속도: 30-50 mm/s</text>
            <text x="400" y="170" text-anchor="middle" font-size="14" fill="#666">압력: 0.8 × F_clamp/A_proj</text>
            <text x="400" y="195" text-anchor="middle" font-size="14" fill="#666">목적: 스프루 플래시 방지</text>
            <text x="400" y="220" text-anchor="middle" font-size="14" fill="#666">전단발열·점도붕괴 차단</text>

            <path d="M 400 250 L 400 290" stroke="#1e3c72" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <rect x="50" y="290" width="700" height="200" fill="#fff3e0" stroke="#ff6f00" stroke-width="3" rx="10"/>
            <text x="400" y="330" text-anchor="middle" font-size="24" font-weight="bold" fill="#ff6f00">V1: High-Speed Cavity Fill</text>
            <text x="400" y="360" text-anchor="middle" font-size="16" fill="#333">캐비티 고속 충전 (90-96%)</text>
            <text x="400" y="385" text-anchor="middle" font-size="14" fill="#666">속도: 80-150 mm/s</text>
            <text x="400" y="410" text-anchor="middle" font-size="14" fill="#666">전환: 캐비티압 dP/dt 피크</text>
            <text x="400" y="435" text-anchor="middle" font-size="14" fill="#666">목적: 얇은벽 충전성 확보</text>
            <text x="400" y="460" text-anchor="middle" font-size="14" fill="#666">압력 상한 유지</text>

            <path d="M 400 490 L 400 530" stroke="#1e3c72" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <rect x="50" y="530" width="700" height="200" fill="#f3e5f5" stroke="#7b1fa2" stroke-width="3" rx="10"/>
            <text x="400" y="570" text-anchor="middle" font-size="24" font-weight="bold" fill="#7b1fa2">V2: End-of-Fill Deceleration</text>
            <text x="400" y="600" text-anchor="middle" font-size="16" fill="#333">충전 끝 감속 (96-100%)</text>
            <text x="400" y="625" text-anchor="middle" font-size="14" fill="#666">속도: 20-40 mm/s (선형 감속)</text>
            <text x="400" y="650" text-anchor="middle" font-size="14" fill="#666">시작: EoF -4~-8 mm</text>
            <text x="400" y="675" text-anchor="middle" font-size="14" fill="#666">목적: 압력 오버슈트 제거</text>
            <text x="400" y="700" text-anchor="middle" font-size="14" fill="#666">플래시 방지</text>

            <path d="M 400 730 L 400 770" stroke="#1e3c72" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

            <rect x="50" y="770" width="700" height="240" fill="#e8f5e9" stroke="#2e7d32" stroke-width="3" rx="10"/>
            <text x="400" y="810" text-anchor="middle" font-size="24" font-weight="bold" fill="#2e7d32">V3: Packing Pressure Control</text>
            <text x="400" y="840" text-anchor="middle" font-size="16" fill="#333">보압 램프-인/조기 종료</text>
            <text x="400" y="865" text-anchor="middle" font-size="14" fill="#666">P1: 30-45% × P_peak (0.1-0.3초)</text>
            <text x="400" y="890" text-anchor="middle" font-size="14" fill="#666">P2: 15-30% × P_peak (게이트 동결까지)</text>
            <text x="400" y="915" text-anchor="middle" font-size="14" fill="#666">종료: 최후 동결 캐비티 기준</text>
            <text x="400" y="940" text-anchor="middle" font-size="14" fill="#666">목적: 과보압 방지</text>
            <text x="400" y="965" text-anchor="middle" font-size="14" fill="#666">게이트 시일 시험으로 최적화</text>
            <text x="400" y="990" text-anchor="middle" font-size="14" fill="#666">중량-시간 곡선 활용</text>

            <defs>
              <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
                <polygon points="0 0, 10 5, 0 10" fill="#1e3c72"/>
              </marker>
            </defs>
          </svg>
        </div>

        <div class="info-box">
          <h3>📊 그래프 해석</h3>
          <p><strong>V0 구간:</strong> 압력이 리밋 아래에서 완만하게 상승합니다. 러너 보호 단계로 과압을 구조적으로 차단합니다.</p>
          <p><strong>V1 구간:</strong> 고속 충전으로 압력이 급상승하지만 여전히 리밋 이내를 유지합니다.</p>
          <p><strong>V2 구간:</strong> 감속으로 압력 스파이크가 제어되며 완만하게 피크에 도달합니다.</p>
          <p><strong>V3 구간:</strong> 보압 단계로 압력이 점진적으로 감소하며 게이트 동결 후 종료됩니다.</p>
        </div>
      </div>

      <!-- Flash Tab 4: Checklist -->
      <div class="flash-content" id="flash-tab-4">
        <h3 style="color:#1e3c72;margin-bottom:20px">현장 작업 체크리스트</h3>
        <button class="print-button" onclick="window.print()">🖨️ 체크리스트 인쇄</button>

        <div class="checklist">
          <h3 style="color:#1e3c72;margin-bottom:15px">준비 단계 (Pre-Setup)</h3>
          <div class="checklist-item">
            <input type="checkbox" class="checklist-checkbox">
            <div class="checklist-text"><strong>재료 건조 확인:</strong> PHA 펠렛을 65-80°C에서 6-24시간 건조했는지 확인합니다.</div>
          </div>
          <div class="checklist-item">
            <input type="checkbox" class="checklist-checkbox">
            <div class="checklist-text"><strong>러너 체적 계산:</strong> CAD 또는 금형 도면에서 러너 총 체적(V_runner)을 계산하고 90% 지점을 스크류 위치로 환산합니다.</div>
          </div>
          <div class="checklist-item">
            <input type="checkbox" class="checklist-checkbox">
            <div class="checklist-text"><strong>투영 면적 측정:</strong> 36개 캐비티의 총 투영 면적(A_proj)을 계산합니다.</div>
          </div>
          <div class="checklist-item">
            <input type="checkbox" class="checklist-checkbox">
            <div class="checklist-text"><strong>클램프 톤수 확인:</strong> 계산기를 이용해 필요 톤수를 산출하고 현재 기계 사양과 비교합니다.</div>
          </div>
        </div>

        <div class="checklist">
          <h3 style="color:#1e3c72;margin-bottom:15px">V0 단계 설정 (Runner Protection)</h3>
          <div class="checklist-item">
            <input type="checkbox" class="checklist-checkbox">
            <div class="checklist-text"><strong>V0 속도 설정:</strong> 30-50 mm/s 범위에서 중속으로 설정합니다.</div>
          </div>
          <div class="checklist-item">
            <input type="checkbox" class="checklist-checkbox">
            <div class="checklist-text"><strong>압력 리밋 설정:</strong> 계산기에서 산출한 값(0.8 × F_clamp/A_proj)을 기계에 입력합니다.</div>
          </div>
          <div class="checklist-item">
            <input type="checkbox" class="checklist-checkbox">
            <div class="checklist-text"><strong>V0→V1 전환점 설정:</strong> 러너 체적의 90% 지점을 스크류 위치로 설정합니다.</div>
          </div>
        </div>

        <div class="checklist">
          <h3 style="color:#1e3c72;margin-bottom:15px">V1 단계 설정 (High-Speed Fill)</h3>
          <div class="checklist-item">
            <input type="checkbox" class="checklist-checkbox">
            <div class="checklist-text"><strong>V1 속도 설정:</strong> 얇은벽 충전을 위해 80-150 mm/s 범위에서 고속으로 설정합니다.</div>
          </div>
          <div class="checklist-item">
            <input type="checkbox" class="checklist-checkbox">
            <div class="checklist-text"><strong>사출압 상한 유지:</strong> V0에서 설정한 압력 리밋이 V1에서도 적용되는지 확인합니다.</div>
          </div>
        </div>

        <div class="checklist">
          <h3 style="color:#1e3c72;margin-bottom:15px">검증 단계 (Verification)</h3>
          <div class="checklist-item">
            <input type="checkbox" class="checklist-checkbox">
            <div class="checklist-text"><strong>플래시 측정:</strong> 파팅라인과 스프루 주변에서 플래시 높이를 측정합니다. 목표는 0.02mm 이하입니다.</div>
          </div>
          <div class="checklist-item">
            <input type="checkbox" class="checklist-checkbox">
            <div class="checklist-text"><strong>제품 무게 확인:</strong> 36개 캐비티의 제품 무게를 측정하고 변동이 ±1% 이내인지 확인합니다.</div>
          </div>
          <div class="checklist-item">
            <input type="checkbox" class="checklist-checkbox">
            <div class="checklist-text"><strong>치수 측정:</strong> 핵심 치수를 측정하고 규격 내에 있는지 확인합니다.</div>
          </div>
        </div>
      </div>

      <!-- Flash Tab 5: Troubleshooting -->
      <div class="flash-content" id="flash-tab-5">
        <h3 style="color:#1e3c72;margin-bottom:20px">문제 해결 가이드</h3>

        <div class="warning-box">
          <h3>🔴 문제: 스프루/러너 근처에 플래시 발생</h3>
          <p><strong>가능 원인과 해결책:</strong></p>
          <ul style="margin-left:20px;margin-top:10px">
            <li><strong>V0 압력 리밋이 너무 높음</strong> → 압력 리밋을 70%로 낮추고 재시험합니다</li>
            <li><strong>클램프 톤수 부족</strong> → 계산기로 재확인하고 더 큰 기계로 전환 검토합니다</li>
            <li><strong>스프루 부싱 마모/손상</strong> → 스프루 부싱을 교체하고 시트 형상을 점검합니다</li>
            <li><strong>파팅라인 온도가 높음</strong> → 국부 냉각을 -5°C까지 강화합니다</li>
            <li><strong>러너 전단발열</strong> → V0 속도를 낮추거나 러너 직경을 증대합니다</li>
          </ul>
        </div>

        <div class="warning-box">
          <h3>🟠 문제: 캐비티 충전 불완전 (Short Shot)</h3>
          <p><strong>가능 원인과 해결책:</strong></p>
          <ul style="margin-left:20px;margin-top:10px">
            <li><strong>V1 속도가 너무 낮음</strong> → V1 속도를 단계적으로 증가시킵니다</li>
            <li><strong>V0 구간이 너무 길음</strong> → V0→V1 전환점을 85%로 앞당깁니다</li>
            <li><strong>재료 온도가 너무 낮음</strong> → 실린더 온도를 5-10°C 상승시킵니다</li>
            <li><strong>금형 온도가 너무 낮음</strong> → 캐비티 온도를 상승시킵니다(단, 스프루는 저온 유지)</li>
            <li><strong>게이트 크기 부족</strong> → 게이트 직경을 0.1-0.2mm 증대 검토합니다</li>
          </ul>
        </div>

        <div class="warning-box">
          <h3>🟡 문제: EoF에서 압력 스파이크 발생</h3>
          <p><strong>가능 원인과 해결책:</strong></p>
          <ul style="margin-left:20px;margin-top:10px">
            <li><strong>V2 감속이 없거나 불충분</strong> → V2 감속 구간을 8mm로 연장합니다</li>
            <li><strong>감속 프로파일이 급격함</strong> → 선형 램프가 아닌 경우 설정을 변경합니다</li>
            <li><strong>V1 속도가 과도하게 높음</strong> → V1 속도를 10-20% 감소시킵니다</li>
            <li><strong>공기 포획(Air Trap)</strong> → 벤트 위치와 크기를 점검합니다</li>
          </ul>
        </div>

        <div class="warning-box">
          <h3>🟢 문제: 캐비티 간 무게 편차가 큼</h3>
          <p><strong>가능 원인과 해결책:</strong></p>
          <ul style="margin-left:20px;margin-top:10px">
            <li><strong>러너 밸런싱 불량</strong> → 러너 설계를 재검토하거나 게이트 구경을 미세 조정합니다</li>
            <li><strong>게이트 동결 시간 편차</strong> → 게이트 구경을 ±0.02mm 단위로 조정하여 동결 시간을 균질화합니다</li>
            <li><strong>금형 온도 불균일</strong> → 각 구역의 실제 온도를 측정하고 균일화합니다</li>
            <li><strong>보압 시간이 최후 동결 캐비티 기준이 아님</strong> → 게이트 시일 시험을 재수행합니다</li>
          </ul>
        </div>

        <div class="warning-box">
          <h3>🔵 문제: PHA 재료 열화 징후 (변색, 가스 발생)</h3>
          <p><strong>가능 원인과 해결책:</strong></p>
          <ul style="margin-left:20px;margin-top:10px">
            <li><strong>실린더 온도가 과도함</strong> → 후방대 온도를 5-10°C 낮춥니다</li>
            <li><strong>체류시간이 길음</strong> → 샷 크기를 증대하거나 사이클 타임을 단축합니다</li>
            <li><strong>스크류 rpm이 높음</strong> → rpm을 30-50% 감소시킵니다</li>
            <li><strong>배압이 과도함</strong> → 배압을 최소(5-10 bar)로 낮춥니다</li>
            <li><strong>재료 건조 불충분</strong> → 건조 시간을 연장하고 온도를 확인합니다</li>
          </ul>
        </div>

        <div class="info-box">
          <h3>💡 예방 조치 (Preventive Actions)</h3>
          <p><strong>정기적으로 수행해야 할 작업:</strong></p>
          <ul style="margin-left:20px;margin-top:10px">
            <li>주 1회: 스프루 부싱과 파팅라인의 마모/손상 점검</li>
            <li>주 1회: 타이바 변형 측정 및 클램프 톤수 재확인</li>
            <li>일 2회: 제품 무게와 치수 샘플링 (시작/종료 시)</li>
            <li>일 1회: 캐비티 압력 데이터 검토 및 트렌드 분석</li>
            <li>교대 시: 금형 온도 실측값 확인</li>
            <li>로트 변경 시: 재료 건조 상태 재확인</li>
          </ul>
        </div>
      </div>

      <!-- Flash Tab 6: Process Log -->
      <div class="flash-content" id="flash-tab-6">
        <h3 style="color:#1e3c72;margin-bottom:20px">공정 조건 현장 기록 로그</h3>

        <div class="success-box">
          <h3>📋 현장 평가 및 조건 기록</h3>
          <p><strong>공정 조건과 현상을 실시간으로 기록하여 문제 해결과 최적화에 활용하세요.</strong></p>
          <p>각 파라미터는 직접 입력하거나 +/- 버튼으로 조정할 수 있으며, 모든 데이터는 자동으로 저장됩니다.</p>
        </div>

        <!-- Search and Filter -->
        <div class="filter-container">
          <h4 style="color:#1e3c72;margin-bottom:10px">🔍 검색 및 필터</h4>
          <div class="filter-row">
            <input type="text" id="filterKeyword" class="filter-input" placeholder="비고란 키워드 검색..." onkeyup="filterProcessLog()">
            <input type="date" id="filterDateFrom" class="filter-input" style="max-width:180px" onchange="filterProcessLog()">
            <span style="white-space:nowrap">~</span>
            <input type="date" id="filterDateTo" class="filter-input" style="max-width:180px" onchange="filterProcessLog()">
            <button class="btn-filter" onclick="clearFilter()">필터 초기화</button>
          </div>
        </div>

        <!-- Template Management -->
        <div class="template-container">
          <h4 style="color:#1e3c72;margin-bottom:5px">📋 템플릿 관리</h4>
          <p style="font-size:13px;color:#6b7280;margin-bottom:10px">자주 사용하는 공정 조건을 템플릿으로 저장하여 빠르게 불러올 수 있습니다.</p>
          <div class="template-buttons">
            <button class="btn-template" onclick="saveTemplate()">💾 현재 조건 템플릿 저장</button>
            <button class="btn-template load" onclick="loadTemplate()">📥 템플릿 불러오기</button>
            <button class="btn-template delete" onclick="manageTemplates()">🗑️ 템플릿 관리</button>
          </div>
        </div>

        <!-- Weight Measurement and Shot Calculator -->
        <div class="calc-recommendation">
          <h4>⚖️ 무게 측정 및 계량 계산기</h4>
          <p style="font-size:14px;margin-bottom:15px">제품과 러너 무게를 측정하여 샷 계량양과 플래시 저감 조건을 자동 산출합니다.</p>

          <div class="weight-calc-grid">
            <div class="weight-input-box">
              <label>제품 1개 무게 (g)</label>
              <input type="number" id="partWeight" step="0.01" placeholder="0.00" onchange="calculateShotWeight()">
            </div>
            <div class="weight-input-box">
              <label>러너 무게 (g)</label>
              <input type="number" id="runnerWeight" step="0.01" placeholder="0.00" onchange="calculateShotWeight()">
            </div>
            <div class="weight-input-box">
              <label>캐비티 수</label>
              <input type="number" id="cavityCount" value="36" step="1" onchange="calculateShotWeight()">
            </div>
            <div class="weight-input-box">
              <label>재료 밀도 (g/cm³)</label>
              <input type="number" id="materialDensity" value="1.25" step="0.01" placeholder="1.25" onchange="calculateShotWeight()">
              <button class="btn-filter" style="margin-top:8px;width:100%;padding:6px" onclick="loadDensityFromGrade()">Grade에서 불러오기</button>
            </div>
          </div>

          <div id="shotWeightResult" style="display:none;margin-top:15px">
            <div class="density-display">
              총 샷 계량: <span id="totalShotWeight">0.00</span> g (<span id="shotVolume">0.00</span> cm³)
            </div>
            <button class="btn-log-action btn-add-log" style="width:100%;margin-top:10px" onclick="applyWeightToLog()">
              ⬇️ 최신 로그에 무게 적용
            </button>
          </div>
        </div>

        <!-- Flash Reduction Recommendations -->
        <div id="flashRecommendations" style="display:none">
          <div class="calc-recommendation">
            <h4>💡 플래시 저감 공정 조건 추천</h4>
            <p style="font-size:14px;margin-bottom:15px">현재 공정 조건을 분석하여 플래시 발생을 줄이기 위한 최적화 방안을 제시합니다.</p>
            <div id="recommendationContent"></div>
          </div>
        </div>

        <!-- Chart Visualization -->
        <div class="chart-container">
          <div class="chart-controls">
            <h4 style="color:#1e3c72;margin:0;flex:1">📊 공정 조건 트렌드 차트</h4>
            <button class="chart-toggle-btn active" onclick="showChart('temp')" id="chartBtnTemp">온도</button>
            <button class="chart-toggle-btn" onclick="showChart('pressure')" id="chartBtnPressure">압력</button>
            <button class="chart-toggle-btn" onclick="showChart('weight')" id="chartBtnWeight">무게</button>
            <button class="chart-toggle-btn" onclick="showChart('time')" id="chartBtnTime">시간</button>
          </div>
          <div style="position:relative;height:300px">
            <canvas id="processChart"></canvas>
          </div>
          <p style="font-size:12px;color:#6b7280;margin-top:10px;text-align:center">
            최근 20개 로그 데이터를 기준으로 트렌드를 표시합니다. 로그가 추가될수록 자동 업데이트됩니다.
          </p>
        </div>

        <div class="log-container">
          <div class="log-header">
            <h4 style="color:#1e3c72;margin:0">📝 공정 조건 로그</h4>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn-log-action btn-add-log" onclick="addProcessLogEntry()">➕ 로그 추가</button>
              <button class="btn-log-action btn-export-log" onclick="exportProcessLog()">📥 CSV 내보내기</button>
              <button class="btn-log-action btn-clear-log" onclick="clearProcessLog()">🗑️ 전체 삭제</button>
            </div>
          </div>

          <div style="overflow-x:auto">
            <table class="log-table" id="processLogTable">
              <thead>
                <tr>
                  <th style="min-width:140px">일시</th>
                  <th style="min-width:120px">실린더 온도 (°C)</th>
                  <th style="min-width:120px">금형 온도 (°C)</th>
                  <th style="min-width:130px">사출속도 (mm/s)</th>
                  <th style="min-width:120px">사출압력 (bar)</th>
                  <th style="min-width:120px">보압 (bar)</th>
                  <th style="min-width:130px">보압시간 (s)</th>
                  <th style="min-width:130px">냉각시간 (s)</th>
                  <th style="min-width:120px">제품 무게 (g)</th>
                  <th style="min-width:120px">러너 무게 (g)</th>
                  <th style="min-width:130px">총 무게 (g)</th>
                  <th style="min-width:200px">비고/현상</th>
                  <th style="min-width:100px">사진</th>
                  <th style="min-width:80px">동작</th>
                </tr>
              </thead>
              <tbody id="processLogBody">
                <tr>
                  <td colspan="14" class="log-empty">로그가 없습니다. "➕ 로그 추가" 버튼을 눌러 첫 기록을 시작하세요.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="info-box" style="margin-top:30px">
          <h3>💡 사용 안내</h3>
          <ul style="margin-left:20px;margin-top:10px">
            <li><strong>로그 추가:</strong> "➕ 로그 추가" 버튼을 클릭하면 새로운 기록 행이 추가됩니다</li>
            <li><strong>값 입력:</strong> 숫자를 직접 입력하거나 +/- 버튼으로 조정할 수 있습니다</li>
            <li><strong>무게 측정:</strong> 제품과 러너 무게를 입력하면 샷 계량과 플래시 저감 조건이 자동 계산됩니다</li>
            <li><strong>검색/필터:</strong> 날짜 범위와 키워드로 원하는 로그를 빠르게 찾을 수 있습니다</li>
            <li><strong>템플릿:</strong> 자주 사용하는 공정 조건을 저장하여 빠르게 재사용할 수 있습니다</li>
            <li><strong>사진 첨부:</strong> 각 로그에 불량품 또는 제품 사진을 첨부하여 시각적으로 관리할 수 있습니다</li>
            <li><strong>차트 뷰:</strong> 온도, 압력, 무게, 시간 파라미터의 트렌드를 실시간 차트로 확인하세요</li>
            <li><strong>모바일 사용:</strong> PC와 휴대폰 모두에서 편리하게 사용할 수 있도록 최적화되어 있습니다</li>
            <li><strong>자동 저장:</strong> 입력한 값은 자동으로 브라우저에 저장됩니다</li>
            <li><strong>CSV 내보내기:</strong> 기록한 데이터를 CSV 파일로 다운로드할 수 있습니다</li>
            <li><strong>비고란 활용:</strong> 현상, 불량 유형, 특이사항 등을 자유롭게 기록하세요</li>
          </ul>
        </div>

        <div class="warning-box" style="margin-top:20px">
          <h3>⚠️ 주의사항</h3>
          <ul style="margin-left:20px;margin-top:10px">
            <li>데이터는 브라우저에 저장되므로 <strong>브라우저 캐시를 삭제하면 데이터가 손실</strong>됩니다</li>
            <li>중요한 데이터는 정기적으로 <strong>CSV 내보내기</strong>를 통해 백업하세요</li>
            <li>다른 기기나 브라우저에서는 데이터가 공유되지 않습니다</li>
          </ul>
        </div>
      </div>

      <!-- Flash Tab 7: Documentation -->
      <div class="flash-content" id="flash-tab-7">
        <h3 style="color:#1e3c72;margin-bottom:20px">📖 PHA Process Optimizer & Convertor - 사용 설명서</h3>

        <div class="success-box">
          <h3>🎯 애플리케이션 개요</h3>
          <p><strong>PHA Process Optimizer & Convertor</strong>는 PHA(Polyhydroxyalkanoate) 바이오플라스틱 사출 성형 공정의 현장 엔지니어와 품질 관리자를 위한 종합 도구입니다.</p>
          <p style="margin-top:10px"><strong>버전:</strong> 1.0.0 | <strong>유형:</strong> 정적 웹 애플리케이션 (서버 불필요) | <strong>저장:</strong> 브라우저 로컬 저장소</p>
        </div>

        <h4 style="color:#1e3c72;margin-top:30px;margin-bottom:15px">📋 주요 기능</h4>

        <table>
          <thead>
            <tr>
              <th style="min-width:150px">기능</th>
              <th>설명</th>
              <th style="min-width:120px">위치</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>단위 변환기</strong></td>
              <td>압력(bar/MPa/psi), 온도(°C/°F/K), 길이, 속도 단위 실시간 변환</td>
              <td>메인 탭 1</td>
            </tr>
            <tr>
              <td><strong>클램프 톤수 계산</strong></td>
              <td>36 캐비티 금형의 최적 클램프 톤수 자동 산출 (안전계수 1.2 포함)</td>
              <td>메인 탭 2</td>
            </tr>
            <tr>
              <td><strong>플래시 저감 가이드</strong></td>
              <td>체계적인 사출속도, 압력, 온도 최적화 방법론 (6개 서브탭)</td>
              <td>메인 탭 3</td>
            </tr>
            <tr>
              <td><strong>공정 조건 로그</strong></td>
              <td>실시간 공정 기록, 차트 시각화, 검색/필터, 템플릿, 사진 첨부</td>
              <td>플래시 탭 6</td>
            </tr>
            <tr>
              <td><strong>플래시 저감 추천</strong></td>
              <td>현재 공정 조건 분석 및 최적화 방안 자동 제시</td>
              <td>플래시 탭 6</td>
            </tr>
            <tr>
              <td><strong>무게 계산기</strong></td>
              <td>제품/러너 무게 기반 샷 계량 및 용적 계산</td>
              <td>플래시 탭 6</td>
            </tr>
          </tbody>
        </table>

        <h4 style="color:#1e3c72;margin-top:30px;margin-bottom:15px">🔍 플래시 저감 추천 엔진 상세</h4>

        <div class="info-box">
          <h3>💡 분석 기준 및 추천 로직</h3>
          <p>최신 로그 데이터를 실시간으로 분석하여 5가지 주요 파라미터에 대한 플래시 저감 방안을 자동 제시합니다.</p>
        </div>

        <table style="margin-top:15px">
          <thead>
            <tr>
              <th>파라미터</th>
              <th>기준값</th>
              <th>추천 조치</th>
              <th>기술적 근거</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>사출압력</strong></td>
              <td>&gt; 900 bar</td>
              <td>-50 bar 감소</td>
              <td>과도한 압력 → 파팅라인 벌어짐 → 플래시 발생</td>
            </tr>
            <tr>
              <td><strong>실린더 온도</strong></td>
              <td>&gt; 185°C</td>
              <td>-5°C 감소</td>
              <td>고온 → 점도 감소 → 미세 틈새 침투 증가</td>
            </tr>
            <tr>
              <td><strong>사출속도</strong></td>
              <td>&gt; 180 mm/s</td>
              <td>-20 mm/s 감소</td>
              <td>고속 → 압력 스파이크 → 플래시 위험 증가</td>
            </tr>
            <tr>
              <td><strong>보압</strong></td>
              <td>&gt; 700 bar</td>
              <td>-50 bar 감소</td>
              <td>과도한 보압 → 지속적 압력 → 플래시 악화</td>
            </tr>
            <tr>
              <td><strong>냉각시간</strong></td>
              <td>&lt; 12초</td>
              <td>+2초 증가</td>
              <td>불충분한 냉각 → 취출 시 변형 → 치수 불안정</td>
            </tr>
          </tbody>
        </table>

        <div class="warning-box" style="margin-top:15px">
          <h3>🔴 추천 심각도 구분</h3>
          <ul style="margin-left:20px;margin-top:10px">
            <li><strong>🔴 warning (빨간색):</strong> 즉시 조치 필요 - 사출압력 과다</li>
            <li><strong>🟡 caution (노란색):</strong> 주의 및 개선 권장 - 온도/속도/보압 과다</li>
            <li><strong>🟢 suggestion (녹색):</strong> 품질 향상 제안 - 냉각시간 증가</li>
          </ul>
        </div>

        <h4 style="color:#1e3c72;margin-top:30px;margin-bottom:15px">📊 차트 시각화 기능</h4>

        <div class="info-box">
          <h3>📈 4가지 차트 유형 (Chart.js 4.4.0 기반)</h3>
          <table style="margin-top:10px">
            <thead>
              <tr>
                <th>차트 유형</th>
                <th>표시 항목</th>
                <th>활용</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>온도 차트</strong></td>
                <td>실린더 온도 + 금형 온도</td>
                <td>온도 트렌드 분석, 열 관리 최적화</td>
              </tr>
              <tr>
                <td><strong>압력 차트</strong></td>
                <td>사출압력 + 보압</td>
                <td>압력 프로파일 분석, 플래시 발생 상관관계</td>
              </tr>
              <tr>
                <td><strong>무게 차트</strong></td>
                <td>제품 무게 + 러너 무게 + 총 무게</td>
                <td>샷 간 변동성 분석, 공정 안정성 평가</td>
              </tr>
              <tr>
                <td><strong>시간 차트</strong></td>
                <td>보압시간 + 냉각시간</td>
                <td>사이클 타임 최적화, 생산성 향상</td>
              </tr>
            </tbody>
          </table>
          <p style="margin-top:10px"><strong>특징:</strong> 최근 20개 데이터 표시 | 실시간 업데이트 | 인터랙티브 줌/팬 | 반응형 디자인</p>
        </div>

        <h4 style="color:#1e3c72;margin-top:30px;margin-bottom:15px">⚖️ 무게 측정 계산기 사용법</h4>

        <div class="success-box">
          <h3>계산 프로세스</h3>
          <ol style="margin-left:20px;margin-top:10px">
            <li><strong>제품 1개 무게 측정:</strong> 저울로 단일 캐비티 제품 무게 측정 (g 단위)</li>
            <li><strong>러너 무게 측정:</strong> 러너 시스템 전체 무게 측정 (g 단위)</li>
            <li><strong>캐비티 수 확인:</strong> 기본값 36 (필요 시 수정 가능)</li>
            <li><strong>재료 밀도 입력:</strong> "Grade에서 불러오기" 버튼으로 자동 조회 또는 수동 입력</li>
            <li><strong>자동 계산:</strong> 총 샷 계량(g) 및 샷 용적(cm³) 자동 표시</li>
            <li><strong>로그 적용:</strong> "⬇️ 최신 로그에 무게 적용" 버튼 클릭</li>
          </ol>
        </div>

        <h4 style="color:#1e3c72;margin-top:30px;margin-bottom:15px">📋 PHA 재료 밀도 데이터베이스</h4>

        <table>
          <thead>
            <tr>
              <th>Grade</th>
              <th>밀도 (g/cm³)</th>
              <th>특징</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>CA1180P</strong></td>
              <td>1.25</td>
              <td>범용 등급</td>
            </tr>
            <tr>
              <td><strong>S1000P</strong></td>
              <td>1.24</td>
              <td>표준 등급</td>
            </tr>
            <tr>
              <td><strong>A1000P</strong></td>
              <td>1.23</td>
              <td>개선 등급</td>
            </tr>
            <tr>
              <td><strong>P3HB</strong></td>
              <td>1.25</td>
              <td>순수 PHB</td>
            </tr>
            <tr>
              <td><strong>P3HB4HB</strong></td>
              <td>1.22</td>
              <td>코폴리머</td>
            </tr>
            <tr>
              <td><strong>PHB</strong></td>
              <td>1.26</td>
              <td>고밀도 등급</td>
            </tr>
            <tr>
              <td><strong>기본값</strong></td>
              <td>1.25</td>
              <td>Grade 미선택 시</td>
            </tr>
          </tbody>
        </table>

        <h4 style="color:#1e3c72;margin-top:30px;margin-bottom:15px">🔍 검색 및 필터 기능</h4>

        <div class="info-box">
          <h3>3가지 필터링 방식</h3>
          <table style="margin-top:10px">
            <thead>
              <tr>
                <th>방식</th>
                <th>설명</th>
                <th>사용 예시</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>키워드 검색</strong></td>
                <td>비고란 텍스트 실시간 검색</td>
                <td>"플래시", "불량", "정상"</td>
              </tr>
              <tr>
                <td><strong>날짜 범위</strong></td>
                <td>시작일 ~ 종료일 범위 선택</td>
                <td>2025-10-01 ~ 2025-10-31</td>
              </tr>
              <tr>
                <td><strong>복합 필터</strong></td>
                <td>키워드 + 날짜 동시 적용</td>
                <td>"플래시" + 10월 데이터</td>
              </tr>
            </tbody>
          </table>
          <p style="margin-top:10px"><strong>특징:</strong> 클라이언트 사이드 처리 (빠른 응답) | 실시간 필터링 | "필터 초기화" 버튼으로 전체 복원</p>
        </div>

        <h4 style="color:#1e3c72;margin-top:30px;margin-bottom:15px">📸 사진 첨부 기능</h4>

        <div class="info-box">
          <h3>IndexedDB 기반 사진 저장</h3>
          <p><strong>지원 형식:</strong> JPEG, PNG, GIF, WebP | <strong>최대 크기:</strong> 5MB per file | <strong>다중 업로드:</strong> 한 번에 여러 장 첨부 가능</p>
          <p style="margin-top:10px"><strong>사용 방법:</strong></p>
          <ol style="margin-left:20px;margin-top:5px">
            <li>로그 테이블의 "사진" 열에서 "📷 첨부" 버튼 클릭</li>
            <li>파일 선택 다이얼로그에서 이미지 선택 (Ctrl+클릭으로 다중 선택)</li>
            <li>업로드 완료 후 "📷 사진 (N개)" 형태로 표시</li>
            <li>클릭하여 첨부된 사진 확인</li>
          </ol>
        </div>

        <div class="warning-box" style="margin-top:15px">
          <h3>⚠️ 사진 저장 주의사항</h3>
          <ul style="margin-left:20px;margin-top:10px">
            <li>IndexedDB는 브라우저별 저장 용량 제한이 있습니다 (일반적으로 50MB+)</li>
            <li>브라우저 캐시 삭제 시 사진도 함께 삭제됩니다</li>
            <li>중요 사진은 별도 백업을 권장합니다</li>
            <li>5MB 초과 파일은 리사이즈 툴 사용 (TinyPNG, ImageOptim 등)</li>
          </ul>
        </div>

        <h4 style="color:#1e3c72;margin-top:30px;margin-bottom:15px">📋 템플릿 시스템</h4>

        <div class="success-box">
          <h3>자주 사용하는 공정 조건 저장 및 재사용</h3>
          <p><strong>저장 항목:</strong> 실린더 온도, 금형 온도, 사출속도, 사출압력, 보압, 보압시간, 냉각시간, 저장 일시</p>
          <p style="margin-top:10px"><strong>사용 사례:</strong></p>
          <ul style="margin-left:20px;margin-top:5px">
            <li>표준 공정 조건 템플릿 (예: "표준_CA1180P")</li>
            <li>계절별 조건 템플릿 (예: "여름용_저온", "겨울용_고온")</li>
            <li>제품별 조건 템플릿 (예: "제품A_최적조건")</li>
          </ul>
          <p style="margin-top:10px"><strong>기능:</strong></p>
          <ul style="margin-left:20px;margin-top:5px">
            <li><strong>💾 템플릿 저장:</strong> 현재 최신 로그의 조건을 템플릿으로 저장</li>
            <li><strong>📥 템플릿 불러오기:</strong> 저장된 템플릿 목록에서 선택하여 로그에 적용</li>
            <li><strong>🗑️ 템플릿 관리:</strong> 저장된 템플릿 목록 확인 및 삭제</li>
          </ul>
        </div>

        <h4 style="color:#1e3c72;margin-top:30px;margin-bottom:15px">❓ 자주 묻는 질문 (FAQ)</h4>

        <div class="warning-box">
          <h3>Q1: 로그 데이터가 사라졌어요</h3>
          <p><strong>원인:</strong> 브라우저 캐시/쿠키 삭제, 시크릿 모드 사용, 브라우저 설정에서 "사이트 데이터 삭제" 실행</p>
          <p><strong>해결:</strong></p>
          <ul style="margin-left:20px;margin-top:5px">
            <li>정기적으로 "CSV 다운로드" 버튼으로 백업</li>
            <li>중요 데이터는 외부 저장소에 보관</li>
            <li>시크릿 모드 사용 자제</li>
          </ul>
          <p><strong>예방:</strong> 주 1회 CSV 백업 실행, 브라우저 설정에서 localStorage 보존 설정</p>
        </div>

        <div class="warning-box" style="margin-top:15px">
          <h3>Q2: 차트가 표시되지 않아요</h3>
          <p><strong>원인:</strong> Chart.js CDN 로딩 실패, 인터넷 연결 문제, 브라우저 Canvas API 미지원</p>
          <p><strong>해결:</strong></p>
          <ul style="margin-left:20px;margin-top:5px">
            <li>네트워크 연결 확인</li>
            <li>F12 → Network 탭에서 Chart.js CDN 로딩 확인</li>
            <li>브라우저 캐시 삭제 후 새로고침 (Ctrl + Shift + R)</li>
          </ul>
        </div>

        <div class="warning-box" style="margin-top:15px">
          <h3>Q3: CSV 다운로드 시 한글이 깨져요</h3>
          <p><strong>원인:</strong> 엑셀의 기본 인코딩(ANSI)과 CSV 인코딩(UTF-8) 불일치</p>
          <p><strong>해결:</strong> 이 앱은 <strong>UTF-8 BOM</strong>을 자동 추가하여 엑셀에서 한글 정상 표시됩니다</p>
          <p><strong>그래도 깨질 경우:</strong></p>
          <ol style="margin-left:20px;margin-top:5px">
            <li>메모장에서 CSV 열기</li>
            <li>"다른 이름으로 저장" → 인코딩: UTF-8</li>
            <li>엑셀에서 "데이터 → 텍스트 파일 가져오기"</li>
          </ol>
        </div>

        <div class="warning-box" style="margin-top:15px">
          <h3>Q4: 오프라인에서 사용 가능한가요?</h3>
          <p><strong>부분 가능:</strong> 일단 페이지를 로드하면 대부분 기능 사용 가능</p>
          <p><strong>제약:</strong> Chart.js CDN은 오프라인에서 미작동 (차트 기능만 제한)</p>
          <p><strong>완전 오프라인 사용:</strong> Chart.js를 로컬에 복사하여 `&lt;script src="./chart.min.js"&gt;`로 변경 필요</p>
        </div>

        <div class="warning-box" style="margin-top:15px">
          <h3>Q5: 여러 사람이 동시에 사용할 수 있나요?</h3>
          <p><strong>불가능:</strong> localStorage는 브라우저별로 독립적</p>
          <p><strong>대안:</strong></p>
          <ul style="margin-left:20px;margin-top:5px">
            <li>각 사용자가 CSV로 내보내기 → 공유 폴더에 저장</li>
            <li>Google Sheets 등 클라우드 도구와 병행 사용</li>
            <li>서버 기반 백엔드 추가 (향후 개선 사항)</li>
          </ul>
        </div>

        <h4 style="color:#1e3c72;margin-top:30px;margin-bottom:15px">🌐 브라우저 호환성</h4>

        <table>
          <thead>
            <tr>
              <th>플랫폼</th>
              <th>지원 브라우저</th>
              <th>최소 버전</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>데스크톱</strong></td>
              <td>Chrome, Edge, Firefox, Safari</td>
              <td>Chrome 90+, Edge 90+, Firefox 88+, Safari 14+</td>
            </tr>
            <tr>
              <td><strong>모바일</strong></td>
              <td>Chrome Android, Safari iOS, Samsung Internet</td>
              <td>Chrome 90+, Safari iOS 14+, Samsung 14+</td>
            </tr>
            <tr>
              <td><strong>미지원</strong></td>
              <td>Internet Explorer 11</td>
              <td>ES6 미지원으로 인한 호환성 부족</td>
            </tr>
          </tbody>
        </table>

        <h4 style="color:#1e3c72;margin-top:30px;margin-bottom:15px">📄 기술 스택</h4>

        <div class="info-box">
          <h3>핵심 기술</h3>
          <p><strong>프론트엔드:</strong> HTML5, CSS3 (Flexbox, Grid), JavaScript ES6+</p>
          <p><strong>라이브러리:</strong> Chart.js 4.4.0 (CDN)</p>
          <p><strong>브라우저 API:</strong> localStorage (영구 저장), IndexedDB (사진 저장), FileReader API, Blob API</p>
          <p><strong>배포:</strong> Netlify (자동 배포) | <strong>빌드:</strong> Node.js + build.js</p>
          <p><strong>특징:</strong> 완전 정적 웹사이트 (서버 불필요) | 반응형 디자인 (모바일 최적화)</p>
        </div>

        <div class="success-box" style="margin-top:30px">
          <h3>📞 추가 지원 및 상세 문서</h3>
          <p>이 애플리케이션의 전체 기술 문서, API 레퍼런스, 트러블슈팅 가이드는 프로젝트 루트의 <strong>README.md</strong> 파일을 참조하세요.</p>
          <p style="margin-top:10px"><strong>버전:</strong> 1.0.0 | <strong>최종 업데이트:</strong> 2025-11-01 | <strong>빌드:</strong> production</p>
        </div>
      </div>
    </section>
  </div>
</div>

<button class="fab" title="Quick Save" onclick="saveEntry()">💾</button>

<!-- Simple modal for reco editor -->
<div id="modal" style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:9999">
  <div style="background:#fff;max-width:720px;width:92%;border-radius:12px;box-shadow:var(--shadow);padding:16px">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3>권장 가이드 수정</h3>
      <button class="btn secondary" onclick="closeModal()">닫기</button>
    </div>
    <div id="modalBody" class="grid" style="margin-top:8px"></div>
    <div class="row" style="margin-top:8px">
      <button class="btn primary" onclick="saveRecoOverrides()">저장</button>
      <button class="btn secondary" onclick="resetOverridesCurrent()">현재 공정 초기화</button>
      <button class="btn secondary" onclick="resetOverridesAll()">전체 초기화</button>
    </div>
  </div>
</div>

<script>
/* ========= i18n ========= */
const I18N = {
  ko:{title:"PHA 공정 최적화 도구",tab_proc:"공정 조건",tab_ts:"트러블슈팅",tab_hist:"이력 관리",tab_ana:"데이터 분석",tab_calc:"계산기",tab_props:"물성 DB",tab_photos:"사진",tab_flash:"플래시 제어",
      series:"샘플 시리즈",process:"가공 유형",notes:"📝 특이사항 메모",save:"저장 및 분석",export:"데이터 내보내기",reset:"초기화",
      param:"파라미터",current:"현재값",range:"권장 범위",status:"상태",ok:"정상",warn:"주의",crit:"위험",when:"날짜/시간",h_grade:"샘플",h_proc:"공정",h_key:"주요 파라미터",h_result:"결과",h_note:"메모",
      ana_head:"데이터 분석",saved:"데이터가 저장되었습니다.",last:"마지막 업데이트",resetQ:"모든 입력을 초기화할까요?",
      photos_head:"사진 관리"
  },
  en:{title:"PHA Process Optimizer",tab_proc:"Process Conditions",tab_ts:"Troubleshooting",tab_hist:"History",tab_ana:"Data Analysis",tab_calc:"Calculators",tab_props:"Materials DB",tab_photos:"Photos",tab_flash:"Flash Control",
      series:"Sample Series",process:"Process Type",notes:"📝 Process Notes",save:"Save & Analyze",export:"Export Data",reset:"Reset",
      param:"Parameter",current:"Current",range:"Recommended",status:"Status",ok:"Normal",warn:"Warning",crit:"Critical",when:"Date/Time",h_grade:"Sample",h_proc:"Process",h_key:"Main Parameters",h_result:"Result",h_note:"Memo",
      ana_head:"Data Analysis",saved:"Saved successfully.",last:"Last Update",resetQ:"Reset all inputs?",
      photos_head:"Photo Manager"
  }
};
let LANG = 'ko';

/* ========= Base profiles ========= */
const BASE={PHA_SEMI:'PHA_SEMI',PHA_AMOR:'PHA_AMOR',PLA:'PLA',PBAT:'PBAT',PBS:'PBS',PBSA:'PBSA',PHA_PLA:'PHA_PLA',PHA_PBS:'PHA_PBS',PHA_PBAT:'PHA_PBAT'};

/* ========= Grade list ========= */
const GRADES=[
  {value:'S1000P',label:'S1000P (Semi-crystalline, 2–5% 4HB)',profile:BASE.PHA_SEMI},
  {value:'A1000P',label:'A1000P (Amorphous, 30% 4HB)',profile:BASE.PHA_AMOR},
  {value:'CB0400A',label:'CB0400A (P34HB series) – 내부가이드',profile:BASE.PHA_SEMI},
  {value:'CB0104A',label:'CB0104A (P34HB series) – 내부가이드',profile:BASE.PHA_AMOR},
  /* PLA/aPHA family (from website TDS list mentioned) */
  {value:'CA1180P',label:'CA1180P (PLA/aPHA – Injection)',profile:BASE.PHA_PLA},
  {value:'CA1170A',label:'CA1170A (PLA/aPHA – Injection)',profile:BASE.PHA_PLA},
  {value:'CA1165A',label:'CA1165A (PLA/aPHA – Injection)',profile:BASE.PHA_PLA},
  {value:'CA1670P',label:'CA1670P (PLA/aPHA – Sheet/Blow Molding)',profile:BASE.PHA_PLA},
  {value:'CA1680', label:'CA1680 (PLA/aPHA – Sheet/Blow Molding)',profile:BASE.PHA_PLA},
  {value:'CA1270P',label:'CA1270P (PLA/aPHA – Sheet)',profile:BASE.PHA_PLA},
  /* blends + commodity */
  {value:'PLA_aPHA_90_10',label:'PLA/aPHA (A1000P 10%)',profile:BASE.PHA_PLA},
  {value:'PLA_aPHA_80_20',label:'PLA/aPHA (A1000P 20%)',profile:BASE.PHA_PLA},
  {value:'PHA_PBSA_70_30',label:'PHA/PBSA (70/30)',profile:BASE.PBSA},
  {value:'PHA_PBSA_50_50',label:'PHA/PBSA (50/50)',profile:BASE.PBSA},
  {value:'PHA_PBS_70_30',label:'PHA/PBS (70/30)',profile:BASE.PHA_PBS},
  {value:'PHA_PBS_50_50',label:'PHA/PBS (50/50)',profile:BASE.PHA_PBS},
  {value:'PHA_PBAT_70_30',label:'PHA/PBAT (70/30)',profile:BASE.PHA_PBAT},
  {value:'PHA_PBAT_50_50',label:'PHA/PBAT (50/50)',profile:BASE.PHA_PBAT},
  {value:'PLA',label:'PLA',profile:BASE.PLA},
  {value:'PBAT',label:'PBAT',profile:BASE.PBAT},
  {value:'PBS',label:'PBS',profile:BASE.PBS},
  {value:'PBSA',label:'PBSA',profile:BASE.PBSA},
];

/* ========= Recommended ranges ========= */
const GRADE_JSON={"CA1180P":"data/grades/CA1180P_talc10_wax0p3.json"};
const RECO={
  [BASE.PHA_SEMI]:{
    extrusion:{zone1:[140,155],zone2:[150,165],zone3:[160,170],zone4:[165,175],die:[165,180],screwRPM:[40,90],meltPressBar:[60,150],coolingRoll:[15,25],lineSpeed:[5,30]},
    sheet:{zone1:[140,155],zone2:[150,165],zone3:[160,170],zone4:[165,175],zone5:[165,180],die:[170,180],chillTop:[15,25],chillMid:[15,25],chillBot:[15,25],rollRPM:[10,40],lineSpeed:[5,30],targetThickness:[200,2000],meltPressBar:[60,150]},
    injection:{barrel1:[150,160],barrel2:[155,165],barrel3:[160,170],nozzle:[165,175],mold:[25,45],injSpeed:[30,120],injPressMPa:[60,120],packPressMPa:[30,70],packTime:[5,20],coolTime:[10,40],backPressBar:[30,80],screwRPM:[30,100],hold1P:[30,60],hold1T:[2,10],hold2P:[20,50],hold2T:[2,10]},
    blownfilm:{zone1:[145,155],zone2:[155,165],zone3:[160,170],zone4:[165,175],die:[165,175],bur:[1.8,3.0],flh:[200,600],takeup:[10,60],dieGap:[0.8,1.5],meltPressBar:[80,180],airTemp:[15,25]},
    blowmolding:{zone1:[150,160],zone2:[155,165],zone3:[160,170],head:[165,175],die:[165,175],accHead:[165,175],blowPressBar:[6,12],preBlowBar:[2,6],mold:[20,35],coolTime:[20,80]},
    castfilm:{zone1:[150,160],zone2:[155,165],zone3:[160,170],die:[170,180],chillTop:[10,18],lineSpeed:[10,50],targetThickness:[20,200],meltPressBar:[60,150]}
  },
  [BASE.PHA_AMOR]:{
    extrusion:{zone1:[130,145],zone2:[140,155],zone3:[150,165],zone4:[155,170],die:[160,170],screwRPM:[40,90],meltPressBar:[50,130],coolingRoll:[15,25],lineSpeed:[5,30]},
    sheet:{zone1:[130,145],zone2:[140,155],zone3:[150,160],zone4:[155,165],zone5:[155,170],die:[160,170],chillTop:[15,25],chillMid:[15,25],chillBot:[15,25],rollRPM:[10,35],lineSpeed:[5,30],targetThickness:[200,2000],meltPressBar:[50,130]},
    injection:{barrel1:[140,155],barrel2:[150,160],barrel3:[155,165],nozzle:[160,170],mold:[20,40],injSpeed:[30,120],injPressMPa:[50,100],packPressMPa:[25,60],packTime:[5,20],coolTime:[8,35],backPressBar:[20,60],screwRPM:[30,90],hold1P:[25,55],hold1T:[2,10],hold2P:[15,45],hold2T:[2,10]},
    blownfilm:{zone1:[135,145],zone2:[145,155],zone3:[150,160],zone4:[155,165],die:[160,165],bur:[1.8,3.0],flh:[200,600],takeup:[10,60],dieGap:[0.8,1.5],meltPressBar:[70,160],airTemp:[15,25]},
    blowmolding:{zone1:[140,150],zone2:[150,160],zone3:[155,165],head:[160,170],die:[160,170],accHead:[160,170],blowPressBar:[6,12],preBlowBar:[2,6],mold:[20,35],coolTime:[20,70]},
    castfilm:{zone1:[140,150],zone2:[145,155],zone3:[150,160],die:[160,170],chillTop:[10,18],lineSpeed:[10,50],targetThickness:[20,200],meltPressBar:[50,130]}
  },
  [BASE.PLA]:{
    extrusion:{zone1:[170,180],zone2:[180,190],zone3:[190,200],zone4:[195,205],die:[195,210],screwRPM:[40,80],meltPressBar:[70,150],coolingRoll:[15,25],lineSpeed:[5,30]},
    sheet:{zone1:[170,180],zone2:[180,190],zone3:[190,200],zone4:[195,205],zone5:[195,210],die:[200,210],chillTop:[15,25],chillMid:[15,25],chillBot:[15,25],rollRPM:[10,35],lineSpeed:[5,25],targetThickness:[200,2000],meltPressBar:[70,150]},
    injection:{barrel1:[180,190],barrel2:[190,200],barrel3:[195,205],nozzle:[200,210],mold:[20,35],injSpeed:[30,120],injPressMPa:[70,130],packPressMPa:[40,80],packTime:[5,20],coolTime:[10,40],backPressBar:[30,90],screwRPM:[30,90],hold1P:[40,80],hold1T:[2,10],hold2P:[30,70],hold2T:[2,10]},
    blownfilm:{zone1:[175,185],zone2:[185,195],zone3:[190,200],zone4:[195,205],die:[200,210],bur:[1.8,3.0],flh:[200,600],takeup:[10,60],dieGap:[0.8,1.5],meltPressBar:[80,180],airTemp:[15,25]},
    blowmolding:{zone1:[175,185],zone2:[185,195],zone3:[190,200],head:[200,210],die:[200,210],accHead:[200,210],blowPressBar:[6,12],preBlowBar:[2,6],mold:[15,25],coolTime:[20,80]},
    castfilm:{zone1:[180,190],zone2:[190,200],zone3:[195,205],die:[200,210],chillTop:[10,18],lineSpeed:[10,40],targetThickness:[20,200],meltPressBar:[70,150]}
  },
  [BASE.PBAT]:{
    extrusion:{zone1:[110,125],zone2:[120,135],zone3:[130,145],zone4:[135,150],die:[135,150],screwRPM:[40,90],meltPressBar:[50,120],coolingRoll:[15,25],lineSpeed:[5,30]},
    sheet:{zone1:[110,125],zone2:[120,135],zone3:[130,145],zone4:[135,150],zone5:[135,150],die:[135,150],chillTop:[15,25],chillMid:[15,25],chillBot:[15,25],rollRPM:[10,35],lineSpeed:[5,30],targetThickness:[200,2000],meltPressBar:[50,120]},
    injection:{barrel1:[120,130],barrel2:[130,140],barrel3:[135,145],nozzle:[140,150],mold:[20,35],injSpeed:[30,120],injPressMPa:[50,100],packPressMPa:[25,60],packTime:[5,18],coolTime:[8,30],backPressBar:[20,60],screwRPM:[30,90],hold1P:[25,60],hold1T:[2,10],hold2P:[15,45],hold2T:[2,10]},
    blownfilm:{zone1:[115,125],zone2:[125,135],zone3:[135,145],zone4:[140,150],die:[140,150],bur:[1.8,3.0],flh:[200,600],takeup:[10,60],dieGap:[0.8,1.5],meltPressBar:[70,150],airTemp:[15,25]},
    blowmolding:{zone1:[120,130],zone2:[130,140],zone3:[135,145],head:[140,150],die:[140,150],accHead:[140,150],blowPressBar:[5,10],preBlowBar:[2,5],mold:[20,30],coolTime:[20,60]},
    castfilm:{zone1:[120,130],zone2:[130,140],zone3:[135,145],die:[140,150],chillTop:[10,18],lineSpeed:[10,40],targetThickness:[20,200],meltPressBar:[50,120]}
  },
  [BASE.PBS]:{
    extrusion:{zone1:[140,150],zone2:[150,160],zone3:[155,165],zone4:[160,170],die:[160,170],screwRPM:[40,80],meltPressBar:[60,130],coolingRoll:[15,25],lineSpeed:[5,30]},
    sheet:{zone1:[140,150],zone2:[150,160],zone3:[155,165],zone4:[160,170],zone5:[160,170],die:[165,170],chillTop:[15,25],chillMid:[15,25],chillBot:[15,25],rollRPM:[10,35],lineSpeed:[5,30],targetThickness:[200,2000],meltPressBar:[60,130]},
    injection:{barrel1:[150,160],barrel2:[155,165],barrel3:[160,170],nozzle:[165,170],mold:[20,35],injSpeed:[30,120],injPressMPa:[60,110],packPressMPa:[30,70],packTime:[5,18],coolTime:[8,35],backPressBar:[20,60],screwRPM:[30,90],hold1P:[35,70],hold1T:[2,10],hold2P:[25,60],hold2T:[2,10]},
    blownfilm:{zone1:[145,155],zone2:[150,160],zone3:[155,165],zone4:[160,170],die:[165,170],bur:[1.8,3.0],flh:[200,600],takeup:[10,60],dieGap:[0.8,1.5],meltPressBar:[70,150],airTemp:[15,25]},
    blowmolding:{zone1:[150,160],zone2:[155,165],zone3:[160,170],head:[165,170],die:[165,170],accHead:[165,170],blowPressBar:[6,12],preBlowBar:[2,6],mold:[20,30],coolTime:[20,70]},
    castfilm:{zone1:[150,160],zone2:[155,165],zone3:[160,170],die:[165,170],chillTop:[10,18],lineSpeed:[10,40],targetThickness:[20,200],meltPressBar:[60,130]}
  },
  [BASE.PBSA]:{
    extrusion:{zone1:[125,135],zone2:[135,145],zone3:[140,150],zone4:[145,155],die:[150,160],screwRPM:[40,80],meltPressBar:[50,120],coolingRoll:[15,25],lineSpeed:[5,30]},
    sheet:{zone1:[125,135],zone2:[135,145],zone3:[140,150],zone4:[145,155],zone5:[145,160],die:[150,160],chillTop:[15,25],chillMid:[15,25],chillBot:[15,25],rollRPM:[10,35],lineSpeed:[5,30],targetThickness:[200,2000],meltPressBar:[50,120]},
    injection:{barrel1:[135,145],barrel2:[140,150],barrel3:[145,155],nozzle:[150,160],mold:[20,35],injSpeed:[30,120],injPressMPa:[50,90],packPressMPa:[25,60],packTime:[5,18],coolTime:[8,30],backPressBar:[20,60],screwRPM:[30,90],hold1P:[25,55],hold1T:[2,10],hold2P:[15,45],hold2T:[2,10]},
    blownfilm:{zone1:[130,140],zone2:[140,150],zone3:[145,155],zone4:[150,160],die:[150,160],bur:[1.8,3.0],flh:[200,600],takeup:[10,60],dieGap:[0.8,1.5],meltPressBar:[60,140],airTemp:[15,25]},
    blowmolding:{zone1:[135,145],zone2:[140,150],zone3:[145,155],head:[150,160],die:[150,160],accHead:[150,160],blowPressBar:[5,10],preBlowBar:[2,5],mold:[20,30],coolTime:[20,60]},
    castfilm:{zone1:[135,145],zone2:[140,150],zone3:[145,155],die:[150,160],chillTop:[10,18],lineSpeed:[10,40],targetThickness:[20,200],meltPressBar:[50,120]}
  },
  [BASE.PHA_PLA]:{},[BASE.PHA_PBS]:{},[BASE.PHA_PBAT]:{}
};

/* ========= Schemas ========= */
function f(id,ko,en,unit){return {id,ko,en,unit};}
const SCHEMAS={
  extrusion:[f('zone1','Zone 1 온도','Zone 1 Temp','°C'),f('zone2','Zone 2 온도','°C'),
             f('zone3','Zone 3 온도','°C'),f('zone4','Zone 4 온도','°C'),f('die','다이 온도','°C'),
             f('screwRPM','스크류 속도','RPM'),f('meltPressBar','용융 압력','bar'),
             f('coolingRoll','쿨링롤 온도','°C'),f('lineSpeed','라인 속도','m/min')],
  sheet:[f('zone1','Zone 1 온도','°C'),f('zone2','Zone 2 온도','°C'),f('zone3','Zone 3 온도','°C'),
         f('zone4','Zone 4 온도','°C'),f('zone5','Zone 5 온도','°C'),f('die','다이 온도','°C'),
         f('chillTop','칠롤 상단','°C'),f('chillMid','칠롤 중단','°C'),f('chillBot','칠롤 하단','°C'),
         f('rollRPM','롤 회전수','RPM'),f('lineSpeed','라인 속도','m/min'),f('targetThickness','목표 두께','µm'),f('meltPressBar','용융 압력','bar')],
  injection:[f('barrel1','배럴 1','°C'),f('barrel2','배럴 2','°C'),f('barrel3','배럴 3','°C'),f('nozzle','노즐','°C'),
             f('mold','금형 온도','°C'),f('injSpeed','사출 속도','mm/s'),f('injPressMPa','사출 압력','MPa'),f('packPressMPa','보압','MPa'),
             f('packTime','보압 시간','s'),f('coolTime','냉각 시간','s'),f('backPressBar','백프레셔','bar'),f('screwRPM','스크류 회전수','RPM'),
             f('hold1P','보압1 압력','MPa'),f('hold1T','보압1 시간','s'),f('hold2P','보압2 압력','MPa'),f('hold2T','보압2 시간','s')],
  blownfilm:[f('zone1','Zone 1 온도','°C'),f('zone2','Zone 2 온도','°C'),f('zone3','Zone 3 온도','°C'),f('zone4','Zone 4 온도','°C'),
             f('die','다이 온도','°C'),f('bur','BUR','–'),f('flh','FLH','mm'),f('takeup','테이크업 속도','m/min'),
             f('dieGap','다이 갭','mm'),f('meltPressBar','용융 압력','bar'),f('airTemp','냉각 공기 온도','°C')],
  blowmolding:[f('zone1','Zone 1 온도','°C'),f('zone2','Zone 2 온도','°C'),f('zone3','Zone 3 온도','°C'),
               f('head','헤드 온도','°C'),f('die','다이 온도','°C'),f('accHead','어큐뮬레이터 헤드','°C'),
               f('blowPressBar','블로우 압력','bar'),f('preBlowBar','프리블로우 압력','bar'),f('mold','금형 온도','°C'),f('coolTime','냉각 시간','s')],
  castfilm:[f('zone1','Zone 1 온도','°C'),f('zone2','Zone 2 온도','°C'),f('zone3','Zone 3 온도','°C'),
            f('die','다이 온도','°C'),f('chillTop','칠롤 온도','°C'),f('lineSpeed','라인 속도','m/min'),f('targetThickness','목표 두께','µm'),f('meltPressBar','용융 압력','bar')]
};

/* ========= Troubleshooting content ========= */
const TS={
  ko:[{title:"🔴 표면 결함",items:[["샤크스킨","다이 온도 +5~10°C, 압력 낮춤, 가공조제 검토"],["멜트 프랙처","전단속도 낮춤, 온도 프로파일 최적화, 다이 갭 조정"],["다이 라인","다이 청소/온도 균일화, 압력 안정화"]]},
      {title:"🟡 기계적 물성 저하",items:[["인장강도 부족","분자량 저하 확인, 가공온도↓, 체류시간↓"],["신율 감소","가소제/블렌드 비율 조정, 냉각 속도 최적화"],["충격 저하","상용화제, 어닐링"]]},
      {title:"🔵 가공성 문제",items:[["토출 불안정","스크류 속도 안정화, 건조/공급 확인, 온도 균일화"],["압력 변동","스크류/필터 점검, 건조/수분관리"],["색상 불균일","MB 분산 개선, 혼합 시간 증가, 온도 재조정"]]},
      {title:"🟢 열적 특성 이슈",items:[["열변형 낮음","결정화도↑, 핵제, 어닐링 최적화"],["용융 거동 이상","DSC, 블렌드 균일성 확인, 이력 검토"],["열안정성 부족","AO 패키지 보강, 온도/체류 최소화"]]}],
  en:[{title:"🔴 Surface Defects",items:[["Sharkskin","Raise die temp +5–10°C, reduce pressure, processing aid"],["Melt Fracture","Lower shear rate, optimize temp profile, adjust die gap"],["Die Lines","Clean die / improve temperature uniformity / stabilize pressure"]]},
      {title:"🟡 Mechanical",items:[["Low Tensile","Check MW degradation; lower temp; shorten residence"],["Low Elongation","Tune plasticizer/blend; optimize cooling"],["Low Impact","Compatibilizer; anneal"]]},
      {title:"🔵 Processability",items:[["Output Instability","Stabilize screw speed; dry feed; improve uniformity"],["Pressure Variation","Inspect screw/filter; drying & moisture control"],["Color Inconsistency","Improve MB dispersion; longer mixing; retune"]]},
      {title:"🟢 Thermal",items:[["Low HDT","Increase crystallinity; nucleating agent; anneal"],["Abnormal Melting","DSC; blend uniformity; history review"],["Poor Thermal Stability","Reinforce AO; minimize temp/residence"]]}
]};

/* ========= Materials DB (editable, import/export) ========= */
const MAT_DEFAULT={
  "S1000P":{"density_g_cm3":1.24,"MFR_g_10min_190_2_16":null,"Tg_C":null,"Tm_C":170,"Tc_C":null,"tensile_MPa":null,"elongation_%":null,"izod_kJ_m2":null,"HDT_C":null},
  "A1000P":{"density_g_cm3":1.18,"MFR_g_10min_190_2_16":null,"Tg_C":null,"Tm_C":160,"Tc_C":null,"tensile_MPa":null,"elongation_%":null,"izod_kJ_m2":null,"HDT_C":null},
  "CB0400A":{},"CB0104A":{},
  "CA1180P":{"density_g_cm3":1.26,"MFR_g_10min_190_2_16":7,"Tg_C":-15,"Tm_C":162,"tensile_MPa":52,"elongation_%":23,"izod_kJ_m2":63,"HDT_C":51},"CA1170A":{},"CA1165A":{},"CA1670P":{},"CA1680":{},"CA1270P":{}
};
const MAT_KEY_ORDER=[
  ["density_g_cm3","밀도","g/cm³"],["MFR_g_10min_190_2_16","MFR","g/10min @190°C/2.16kg"],
  ["Tg_C","Tg","°C"],["Tm_C","Tm","°C"],["Tc_C","Tc","°C"],
  ["tensile_MPa","인장강도","MPa"],["elongation_%","신율","%"],["izod_kJ_m2","아이조드","kJ/m²"],["HDT_C","HDT","°C"]
];

/* ========= Utilities ========= */
function $(id){return document.getElementById(id)}; function allSel(s){return Array.from(document.querySelectorAll(s))};
function setView(v){document.querySelector('.container').style.maxWidth=(v==='mobile'?'100%':'1400px');$('btnDesktop').classList.toggle('active',v==='desktop');$('btnMobile').classList.toggle('active',v==='mobile')}
function i18nApply(){allSel('[data-i18n]').forEach(el=>{const k=el.dataset.i18n; if(I18N[LANG][k]) el.textContent=I18N[LANG][k];});
  $('notes').placeholder=(LANG==='ko'?'가공 중 특이사항/개선 아이디어 기록':'Record anomalies or ideas');
  $('tsHint').textContent=(LANG==='ko'?I18N.ko.last:I18N.en.last)+': '+new Date().toLocaleString(LANG==='ko'?'ko-KR':'en-US'); renderTS(); renderHistory(); refreshParamTable(); renderMat()}
function renderTS(){
  const cont = $('tsContainer');
  cont.innerHTML = '';
  // Use dynamic troubleshooting data if available
  if (window.tsData && Array.isArray(window.tsData)) {
    const groups = {};
    window.tsData.forEach(item => {
      const proc = item.process || 'general';
      if (!groups[proc]) groups[proc] = [];
      groups[proc].push(item);
    });
    Object.keys(groups).forEach(proc => {
      const card = document.createElement('div');
      card.className = 'card';
      const procName = proc.charAt(0).toUpperCase() + proc.slice(1);
      let html = `<h3 style="margin-bottom:8px">${procName}</h3>`;
      groups[proc].forEach(item => {
        html += `<h4 style="margin-top:12px">${item.symptom}</h4>`;
        if (item.likely_causes && item.likely_causes.length) {
          html += `<strong>Likely causes:</strong><ul>` + item.likely_causes.map(x => `<li>${x}</li>`).join('') + `</ul>`;
        }
        if (item.diagnostics) {
          html += `<strong>Diagnostics:</strong><p>${item.diagnostics}</p>`;
        }
        if (item.quick_fixes && item.quick_fixes.length) {
          html += `<strong>Quick fixes:</strong><ul>` + item.quick_fixes.map(x => `<li>${x}</li>`).join('') + `</ul>`;
        }
        if (item.root_fixes && item.root_fixes.length) {
          html += `<strong>Root fixes:</strong><ul>` + item.root_fixes.map(x => `<li>${x}</li>`).join('') + `</ul>`;
        }
        if (item.control_knobs && item.control_knobs.length) {
          html += `<strong>Control knobs:</strong><p>${item.control_knobs.join(', ')}</p>`;
        }
        if (item.notes) {
          html += `<p><em>${item.notes}</em></p>`;
        }
      });
      card.innerHTML = html;
      cont.appendChild(card);
    });
    return;
  }
  // fallback to legacy categories if no dynamic data
  for (const b of TS[LANG]) {
    const d = document.createElement('div');
    d.className = 'card';
    let html = `<h3 style="margin-bottom:8px">${b.title}</h3><ul style="list-style:none;padding-left:0">`;
    for (const [n, s] of b.items) {
      html += `<li style="margin:6px 0"><b>${n}:</b> ${s}</li>`;
    }
    html += '</ul>';
    d.innerHTML = html;
    cont.appendChild(d);
  }
}

/* ========= Grade & profile helpers ========= */
function buildGradeOptions(){const sel=$('grade'); sel.innerHTML=''; GRADES.forEach(g=>{const o=document.createElement('option');o.value=g.value;o.textContent=g.label;sel.appendChild(o)});
  const msel=$('mat_grade'); msel.innerHTML=''; GRADES.forEach(g=>{const o=document.createElement('option');o.value=g.value;o.textContent=g.value;msel.appendChild(o)});}
function profileOf(grade){const g=GRADES.find(x=>x.value===grade); return g?g.profile:BASE.PHA_SEMI}
function mixReco(a,b,alpha){const out={}; for(const k of Object.keys(a)){if(!b[k]){out[k]=a[k];continue} out[k]=[ Math.round(a[k][0]*(1-alpha)+b[k][0]*alpha), Math.round(a[k][1]*(1-alpha)+b[k][1]*alpha) ];} return out}
function getReco(profile,proc){
  // overrides
  const ov = JSON.parse(localStorage.getItem('reco_overrides')||'{}');
  let base;
  if(RECO[profile] && RECO[profile][proc]) base=RECO[profile][proc];
  else if(profile===BASE.PHA_PLA) base=mixReco(RECO[BASE.PHA_AMOR][proc],RECO[BASE.PLA][proc],.5);
  else if(profile===BASE.PHA_PBS) base=mixReco(RECO[BASE.PHA_SEMI][proc],RECO[BASE.PBS][proc],.5);
  else if(profile===BASE.PHA_PBAT) base=mixReco(RECO[BASE.PHA_AMOR][proc],RECO[BASE.PBAT][proc],.5);
  else base=RECO[BASE.PHA_SEMI][proc];
  // apply overrides
  const key=profile+'__'+proc; if(ov[key]){base={...base,...ov[key]}}
  return base;
}

/* ========= Dynamic form ========= */
function rebuildForm(){
  const proc=$('process').value, grade=$('grade').value, profile=profileOf(grade), schema=SCHEMAS[proc], rec=getReco(profile,proc);
  const wrap=$('dynamicFields'); wrap.innerHTML='';
  for(const fld of schema){
    const id='f_'+fld.id, label = fld.ko + (fld.unit?` (${fld.unit})`:''); const div=document.createElement('div'); div.className='group';
    div.innerHTML=`<label for="${id}">${label}</label><input id="${id}" type="number" inputmode="decimal" placeholder="${rec[fld.id]?rec[fld.id][0]+'-'+rec[fld.id][1]:''}">`;
    wrap.appendChild(div);
  }
  refreshParamTable();
}

/* ========= Table/status ========= */
function statusOf(v,r){if(v===''||v==null||isNaN(v)) return 'warn'; const x=parseFloat(v); if(x>=r[0]&&x<=r[1])return'ok'; if(x<r[0]-10||x>r[1]+10)return'crit'; return'warn'}
function refreshParamTable(){
  const proc=$('process').value, grade=$('grade').value, profile=profileOf(grade), schema=SCHEMAS[proc], rec=getReco(profile,proc);
  const tb=$('paramTable'); tb.innerHTML='';
  schema.forEach(f=>{const val=$('f_'+f.id)?.value||''; const range=rec[f.id]||['-','-']; const s=statusOf(val,range);
    const cls=s==='ok'?'ok':(s==='crit'?'crit':'warn'); const sText=(LANG==='ko'?(s==='ok'?'정상':s==='crit'?'위험':'주의'):(s==='ok'?'Normal':s==='crit'?'Critical':'Warning'));
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${f.ko}${f.unit?' ('+f.unit+')':''}</td><td>${val||'-'}</td><td>${range[0]}-${range[1]}</td><td><span class="badge ${cls}">${sText}</span></td>`; tb.appendChild(tr);
  });
}

/* ========= Save/History/Import/Export ========= */
function collectEntry(){const proc=$('process').value, grade=$('grade').value, schema=SCHEMAS[proc]; const data={ts:new Date().toISOString(),proc,grade,params:{},notes:$('notes').value};
  schema.forEach(f=> data.params[f.id]=$('f_'+f.id)?.value||''); return data;}
function saveEntry(){const data=collectEntry(); const hist=JSON.parse(localStorage.getItem('pha_hist')||'[]'); hist.push(data); localStorage.setItem('pha_hist',JSON.stringify(hist)); alert(I18N[LANG].saved); renderHistory(); analyze();}
function exportHistory(){const hist=JSON.parse(localStorage.getItem('pha_hist')||'[]'); const blob=new Blob([JSON.stringify(hist,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`pha_history_${new Date().toISOString().slice(0,10)}.json`; a.click();}
function renderHistory(){const hist=JSON.parse(localStorage.getItem('pha_hist')||'[]').slice().reverse(); const tb=$('histBody'); tb.innerHTML='';
  hist.slice(0,200).forEach(r=>{const k=Object.entries(r.params).filter(([,v])=>v).slice(0,4).map(([k,v])=>k+':'+v).join(', ');
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${new Date(r.ts).toLocaleString(LANG==='ko'?'ko-KR':'en-US')}</td><td>${r.grade}</td><td>${r.proc}</td><td>${k}</td><td><span class="badge ok">${LANG==='ko'?'완료':'Complete'}</span></td><td>${r.notes||'-'}</td>`; tb.appendChild(tr);});}
function triggerImport(type){(type==='csv'?$('importCSV'):$('importJSON')).click();}
$('importCSV').addEventListener('change', e=>{const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>importCSV(r.result); r.readAsText(f,'utf-8'); e.target.value='';});
$('importJSON').addEventListener('change', e=>{const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{try{const arr=JSON.parse(r.result); if(Array.isArray(arr)){ const hist=JSON.parse(localStorage.getItem('pha_hist')||'[]'); hist.push(...arr); localStorage.setItem('pha_hist',JSON.stringify(hist)); renderHistory(); alert('JSON import 완료'); } else alert('JSON 형식 오류'); }catch(err){alert('JSON 파싱 실패')}}; r.readAsText(f,'utf-8'); e.target.value='';});
function importCSV(text){const lines=text.trim().split(/\r?\n/); const head=lines[0].split(',').map(s=>s.trim()); const hist=JSON.parse(localStorage.getItem('pha_hist')||'[]');
  for(let i=1;i<lines.length;i++){const cols=lines[i].split(','); if(cols.length<3) continue; const obj={ts:cols[head.indexOf('ts')]||new Date().toISOString(),grade:cols[head.indexOf('grade')]||'S1000P',proc:cols[head.indexOf('proc')]||'extrusion',params:{},notes:cols[head.indexOf('notes')]||''};
    head.forEach((h,idx)=>{if(!['ts','grade','proc','notes'].includes(h)) obj.params[h]=cols[idx]}); hist.push(obj);}
  localStorage.setItem('pha_hist',JSON.stringify(hist)); renderHistory(); alert('CSV import 완료')}

/* ========= Reco editor (overrides) ========= */
function openRecoEditor(){const proc=$('process').value, grade=$('grade').value, profile=profileOf(grade), rec=getReco(profile,proc), schema=SCHEMAS[proc];
  const body=$('modalBody'); body.innerHTML=''; schema.forEach(f=>{const r=rec[f.id]||['','']; const div=document.createElement('div'); div.className='group';
    div.innerHTML=`<label>${f.ko}${f.unit?' ('+f.unit+')':''}</label><div class="row"><input id="ov_${f.id}_min" type="number" placeholder="min" value="${r[0]}"><input id="ov_${f.id}_max" type="number" placeholder="max" value="${r[1]}"></div>`; body.appendChild(div);});
  $('modal').style.display='flex';}
function closeModal(){$('modal').style.display='none'}
function saveRecoOverrides(){const proc=$('process').value, profile=profileOf($('grade').value), schema=SCHEMAS[proc]; const key=profile+'__'+proc;
  const ov=JSON.parse(localStorage.getItem('reco_overrides')||'{}'); ov[key]=ov[key]||{}; schema.forEach(f=>{const min=parseFloat($('ov_'+f.id+'_min').value); const max=parseFloat($('ov_'+f.id+'_max').value); if(!isNaN(min)&&!isNaN(max)) ov[key][f.id]=[min,max];}); localStorage.setItem('reco_overrides',JSON.stringify(ov)); closeModal(); rebuildForm();}
function resetOverridesCurrent(){const proc=$('process').value, profile=profileOf($('grade').value); const key=profile+'__'+proc; const ov=JSON.parse(localStorage.getItem('reco_overrides')||'{}'); delete ov[key]; localStorage.setItem('reco_overrides',JSON.stringify(ov)); rebuildForm(); alert('현재 공정의 수정값을 초기화했습니다.')}
function resetOverridesAll(){localStorage.removeItem('reco_overrides'); rebuildForm(); alert('모든 수정값 초기화 완료')}

/* ========= Calculators ========= */
function calcResidence(){const rho=parseFloat($('kpi_rho').value||'0'); const vL=parseFloat($('kpi_holdVol').value||'0'); let m=parseFloat($('kpi_holdMass').value||'0'); const rate=parseFloat($('kpi_rate').value||'0');
  if(!m && rho && vL){m=rho*(vL/1000)} if(!m||!rate){$('kpi_res_out').textContent='입력 부족'; return} const t_min=60*m/rate; $('kpi_res_out').textContent=`체류시간 ≈ ${t_min.toFixed(2)} 분`}
function calcCooling(){const t=parseFloat($('cool_t').value||'0'); const a=parseFloat($('cool_alpha').value||'0'); const Tm=parseFloat($('cool_Tm').value||'0'); const Tmold=parseFloat($('cool_Tmold').value||'0'); const Te=parseFloat($('cool_Te').value||'0');
  if(!t||!a||!Tm||!Tmold||!Te){$('cool_out').textContent='입력 부족'; return} const num=Math.max( (Tm-Tmold)/(Te-Tmold), 1.0001); const tc=( (t*t)/(Math.PI*Math.PI*a) ) * Math.log(num); $('cool_out').textContent=`냉각시간 ≈ ${tc.toFixed(1)} s`}
function calcBlownFilm(){const Q=parseFloat($('bf_Q').value||'0'); const rho=parseFloat($('bf_rho').value||'0'); const Dmm=parseFloat($('bf_D').value||'0'); const BUR=parseFloat($('bf_BUR').value||'0'); const v=parseFloat($('bf_v').value||'0'); const gap=parseFloat($('bf_gap').value||'0');
  if(!Q||!rho||!Dmm||!BUR||!v){$('bf_out').textContent='입력 부족'; return} const Qm3s=(Q/rho)/3600; const D=Dmm/1000; const vs=v/60; const t_m=Qm3s/(Math.PI*D*BUR*vs); const t_um=t_m*1e6;
  let txt=`평균 두께 ≈ ${t_um.toFixed(1)} µm`; if(gap){const t0=gap/2/1000; const A= Math.PI*D*(gap/1000); const v_exit=Qm3s/A; const DDR=vs/v_exit; const t2_um=(t0/(BUR*DDR))*1e6; txt += ` / 갭-기반 추정 ≈ ${t2_um.toFixed(1)} µm (DDR=${DDR.toFixed(2)})`;} $('bf_out').textContent=txt}

/* ========= Materials DB ========= */
function getMatDB(){const raw=localStorage.getItem('mat_db'); if(raw) return JSON.parse(raw); return JSON.parse(JSON.stringify(MAT_DEFAULT));}
function setMatDB(db){localStorage.setItem('mat_db',JSON.stringify(db))}
function renderMat(){const db=getMatDB(); const g=$('mat_grade').value||'S1000P'; const rec=db[g]||{}; const tb=$('mat_tbody'); tb.innerHTML='';
  MAT_KEY_ORDER.forEach(([k,nm,unit])=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${nm}</td><td>${rec[k]??''}</td><td class="muted">${unit}</td>`; tb.appendChild(tr);});}
$('mat_grade').addEventListener('change',renderMat);
function importMatJSON(){const inp=$('mat_file'); inp.onchange=(e)=>{const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{try{const obj=JSON.parse(r.result); const db=getMatDB(); Object.assign(db,obj); setMatDB(db); renderMat(); alert('물성 DB import 완료');}catch(err){alert('JSON 파싱 실패')}}; r.readAsText(f,'utf-8'); inp.value='';}; inp.click();}
function exportMatJSON(){const blob=new Blob([JSON.stringify(getMatDB(),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='materials_db.json'; a.click();}
function editMat(){const db=getMatDB(); const g=$('mat_grade').value||'S1000P'; const rec=Object.assign({},db[g]||{}); const vals={}; let html='<div class="grid">';
  MAT_KEY_ORDER.forEach(([k,nm])=>{const v=rec[k]??''; html+=`<div class="group"><label>${nm}</label><input id="mat_${k}" type="number" step="any" value="${v}"></div>`}); html+='</div>';
  const body=$('modalBody'); body.innerHTML=html; $('modal').style.display='flex';
  // Replace modal buttons temporarily
  const save=window.saveRecoOverrides; const resetC=window.resetOverridesCurrent; const resetA=window.resetOverridesAll;
  window.saveRecoOverrides=function(){const rec2={}; MAT_KEY_ORDER.forEach(([k])=>{const v=$('mat_'+k).value; if(v!=='') rec2[k]=parseFloat(v)}); db[g]=rec2; setMatDB(db); renderMat(); alert('저장 완료'); closeModal(); window.saveRecoOverrides=save; window.resetOverridesCurrent=resetC; window.resetOverridesAll=resetA;};
  window.resetOverridesCurrent=function(){db[g]={}; setMatDB(db); renderMat(); alert('초기화 완료')};
  window.resetOverridesAll=function(){localStorage.removeItem('mat_db'); renderMat(); alert('전체 초기화 완료')};
}

/* ========= Tabs & events ========= */
allSel('.tab').forEach(btn=> btn.addEventListener('click', e=>{const to=e.currentTarget.dataset.tab; allSel('.tab').forEach(b=>b.classList.remove('active')); e.currentTarget.classList.add('active'); allSel('.tabpage').forEach(p=>p.classList.remove('active')); $(to).classList.add('active');}));
document.addEventListener('input', e=>{ if(e.target && e.target.id && e.target.id.startsWith('f_')) refreshParamTable(); });
$('language').addEventListener('change',e=>{LANG=e.target.value; i18nApply();});

/* ========= Init ========= */
(function init(){
  buildGradeOptions();
  $('grade').value='S1000P'; $('process').value='extrusion'; rebuildForm(); i18nApply(); renderHistory(); analyze(); renderMat();
})();
function analyze(){const hist=JSON.parse(localStorage.getItem('pha_hist')||'[]'); const n=hist.length; const t=(n? (LANG==='ko'?'최근 저장: ':'Last: ')+new Date(hist[n-1].ts).toLocaleString(LANG==='ko'?'ko-KR':'en-US')+' · '+hist[n-1].grade+' · '+hist[n-1].proc : (LANG==='ko'?'데이터가 없습니다.':'No data yet.')); $('anaText').textContent=t;}
function resetForm(){if(!confirm(I18N[LANG].resetQ)) return; $('notes').value=''; rebuildForm();}

/* ========= Flash Control Functions ========= */
function showFlashTab(index) {
  const tabs = document.querySelectorAll('.flash-tab');
  const contents = document.querySelectorAll('.flash-content');
  tabs.forEach((tab, i) => {
    if (i === index) {
      tab.classList.add('active');
    } else {
      tab.classList.remove('active');
    }
  });
  contents.forEach((content, i) => {
    if (i === index) {
      content.classList.add('active');
    } else {
      content.classList.remove('active');
    }
  });
}

function calculateFlashClampTonnage() {
  const pAvg = parseFloat($('flash-p-avg').value);
  const aProj = parseFloat($('flash-a-proj').value);
  if (isNaN(pAvg) || isNaN(aProj)) {
    alert('모든 값을 입력해주세요.');
    return;
  }
  const tonnage = (pAvg * aProj) / 1000;
  const recommended = tonnage * 1.2;
  $('flash-clamp-result').style.display = 'block';
  $('flash-clamp-value').textContent = tonnage.toFixed(1) + ' tf';
  $('flash-clamp-recommendation').innerHTML =
    `<strong>권장 클램프 톤수 (20% 여유):</strong> ${recommended.toFixed(1)} tf<br>` +
    `현재 기계의 클램프 톤수가 ${recommended.toFixed(1)} tf 이상인지 확인하세요.`;
}

function calculateFlashPressureLimit() {
  const fClamp = parseFloat($('flash-f-clamp').value);
  const aProj = parseFloat($('flash-a-proj-2').value);
  const safetyFactor = parseFloat($('flash-safety-factor').value);
  if (isNaN(fClamp) || isNaN(aProj) || isNaN(safetyFactor)) {
    alert('모든 값을 입력해주세요.');
    return;
  }
  const pressureLimit = (safetyFactor * fClamp * 1000) / aProj;
  $('flash-pressure-result').style.display = 'block';
  $('flash-pressure-value').textContent = pressureLimit.toFixed(1) + ' bar';
  $('flash-pressure-recommendation').innerHTML =
    `<strong>V0 단계에서 이 값을 압력 리밋으로 설정하세요.</strong><br>` +
    `이 값은 클램프 한계의 ${(safetyFactor * 100).toFixed(0)}%로 계산되어 스프루 플래시를 방지합니다.`;
}

function calculateFlashShearRate() {
  const Q = parseFloat($('flash-flow-rate').value);
  const R = parseFloat($('flash-runner-radius').value);
  if (isNaN(Q) || isNaN(R)) {
    alert('모든 값을 입력해주세요.');
    return;
  }
  const shearRate = (4 * Q) / (Math.PI * Math.pow(R, 3));
  let recommendation = '';
  if (shearRate > 50000) {
    recommendation = '⚠️ <strong>경고:</strong> 전단률이 매우 높습니다 (>50,000 s⁻¹). V0 속도를 낮추거나 러너 직경을 증대하세요.';
  } else if (shearRate > 20000) {
    recommendation = '⚡ <strong>주의:</strong> 전단률이 높은 편입니다 (>20,000 s⁻¹). 모니터링이 필요합니다.';
  } else {
    recommendation = '✅ <strong>양호:</strong> 전단률이 적정 범위입니다.';
  }
  $('flash-shear-result').style.display = 'block';
  $('flash-shear-value').textContent = shearRate.toFixed(0) + ' s⁻¹';
  $('flash-shear-recommendation').innerHTML = recommendation;
}

function calculateFlashPackingPressure() {
  const pInjPeak = parseFloat($('flash-p-inj-peak').value);
  if (isNaN(pInjPeak)) {
    alert('최대 사출압을 입력해주세요.');
    return;
  }
  const p1Min = pInjPeak * 0.30;
  const p1Max = pInjPeak * 0.45;
  const p2Min = pInjPeak * 0.15;
  const p2Max = pInjPeak * 0.30;
  $('flash-packing-result').style.display = 'block';
  $('flash-packing-value').innerHTML =
    `P1: ${p1Min.toFixed(0)} - ${p1Max.toFixed(0)} bar<br>` +
    `P2: ${p2Min.toFixed(0)} - ${p2Max.toFixed(0)} bar`;
  $('flash-packing-recommendation').innerHTML =
    `<strong>P1 단계:</strong> ${p1Min.toFixed(0)}-${p1Max.toFixed(0)} bar를 0.1-0.3초간 유지합니다.<br>` +
    `<strong>P2 단계:</strong> ${p2Min.toFixed(0)}-${p2Max.toFixed(0)} bar를 게이트 동결까지 유지합니다.<br>` +
    `게이트 시일 시험으로 정확한 종료 시점을 결정하세요.`;
}

function clearFlashInputs(type) {
  if (type === 'clamp') {
    $('flash-p-avg').value = '';
    $('flash-a-proj').value = '';
    $('flash-clamp-result').style.display = 'none';
  } else if (type === 'pressure') {
    $('flash-f-clamp').value = '';
    $('flash-a-proj-2').value = '';
    $('flash-safety-factor').value = '0.8';
    $('flash-pressure-result').style.display = 'none';
  } else if (type === 'shear') {
    $('flash-flow-rate').value = '';
    $('flash-runner-radius').value = '';
    $('flash-shear-result').style.display = 'none';
  } else if (type === 'packing') {
    $('flash-p-inj-peak').value = '';
    $('flash-packing-result').style.display = 'none';
  }
}
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(console.error);
  });
}
</script>

<script>
(function(){
  function ensureCA1180PMat(){
    try{
      const raw=localStorage.getItem('mat_db'); const db = raw? JSON.parse(raw): {};
      if(!db['CA1180P'] || Object.keys(db['CA1180P']).length===0){
        db['CA1180P']={"density_g_cm3":1.26,"MFR_g_10min_190_2_16":7,"Tg_C":-15,"Tm_C":162,"tensile_MPa":52,"elongation_%":23,"izod_kJ_m2":63,"HDT_C":51};
        localStorage.setItem('mat_db', JSON.stringify(db));
      }
    }catch(e){console.warn(e);}
  }
  async function applyCA1180P(){
    ensureCA1180PMat();
    const url = (window.GRADE_JSON && GRADE_JSON['CA1180P']) || 'data/grades/CA1180P_talc10_wax0p3.json';
    try{
      const res = await fetch(url + '?v=' + Date.now());
      if(!res.ok) return;
      const prof = await res.json();
      const ov = JSON.parse(localStorage.getItem('reco_overrides')||'{}');
      const key = 'PHA_PLA__injection';
      ov[key]=ov[key]||{};
      const t=prof.processing?.temps_c||{};
      function setR(name,obj){ if(!obj) return; ov[key][name]=[Number(obj.min), Number(obj.max)]; }
      setR('barrel1', t.zone1); setR('barrel2', t.zone2); setR('barrel3', t.zone3||t.zone3_meter); setR('nozzle', t.nozzle);
      const mold=prof.processing?.mold_temp_c?.lowHDT; if(mold){ ov[key]['mold']=[mold.min, mold.max]; }
      const inj=prof.processing?.injection?.speed_mm_s; if(inj){ const a=Math.min(inj.stage1||inj.stage2, inj.stage2||inj.stage1); const b=Math.max(inj.stage1||inj.stage2, inj.stage2||inj.stage1); ov[key]['injSpeed']=[a,b]; }
      const hold=prof.processing?.holding_profile||[];
      if(hold[0]?.pressure_bar!=null){ const p=hold[0].pressure_bar*0.1; ov[key]['hold1P']=[p*0.9,p*1.1]; ov[key]['hold1T']=[hold[0].time_s,hold[0].time_s]; }
      if(hold[1]?.pressure_bar!=null){ const p=hold[1].pressure_bar*0.1; ov[key]['hold2P']=[p*0.9,p*1.1]; ov[key]['hold2T']=[hold[1].time_s,hold[1].time_s]; }
      const screw=prof.processing?.screw||{};
      if(screw.back_pressure_bar!=null){ ov[key]['backPressBar']=[Math.max(1,screw.back_pressure_bar-2), screw.back_pressure_bar+2]; }
      if(screw.rpm!=null){ ov[key]['screwRPM']=[Math.max(20,screw.rpm-20), screw.rpm+20]; }
      localStorage.setItem('reco_overrides', JSON.stringify(ov));
      console.log('CA1180P profile applied');
      if(window.rebuildForm) rebuildForm();
    }catch(e){ console.warn('CA1180P load failed', e); }
  }
  window.addEventListener('load', ()=>{
    const g=$('grade'); if(g){ g.value='CA1180P'; }
    const p=$('process'); if(p){ p.value='injection'; }
    applyCA1180P();
    loadProcessLog();
  });
})();

// Process Log Functions
let processLogData = [];

function loadProcessLog() {
  const saved = localStorage.getItem('processLog');
  if (saved) {
    try {
      processLogData = JSON.parse(saved);
      renderProcessLog();
    } catch (e) {
      console.warn('Failed to load process log:', e);
      processLogData = [];
    }
  }
}

function saveProcessLog() {
  localStorage.setItem('processLog', JSON.stringify(processLogData));
}

function renderProcessLog() {
  const tbody = document.getElementById('processLogBody');
  if (!tbody) return;

  if (processLogData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="10" class="log-empty">로그가 없습니다. "➕ 로그 추가" 버튼을 눌러 첫 기록을 시작하세요.</td></tr>';
    return;
  }

  tbody.innerHTML = processLogData.map((entry, index) => `
    <tr>
      <td>
        <div class="log-timestamp">${entry.timestamp}</div>
      </td>
      <td>${createNumberInput(index, 'cylinderTemp', entry.cylinderTemp, 1)}</td>
      <td>${createNumberInput(index, 'moldTemp', entry.moldTemp, 1)}</td>
      <td>${createNumberInput(index, 'injectionSpeed', entry.injectionSpeed, 1)}</td>
      <td>${createNumberInput(index, 'injectionPressure', entry.injectionPressure, 5)}</td>
      <td>${createNumberInput(index, 'holdingPressure', entry.holdingPressure, 5)}</td>
      <td>${createNumberInput(index, 'holdingTime', entry.holdingTime, 0.1)}</td>
      <td>${createNumberInput(index, 'coolingTime', entry.coolingTime, 0.5)}</td>
      <td>
        <textarea class="log-note-input"
                  onchange="updateProcessLogNote(${index}, this.value)"
                  placeholder="현상, 불량, 특이사항 기록...">${entry.note || ''}</textarea>
      </td>
      <td>
        <button class="btn-delete-log" onclick="deleteProcessLogEntry(${index})" title="삭제">🗑️</button>
      </td>
    </tr>
  `).join('');
}

function createNumberInput(entryIndex, field, value, step) {
  const val = value || 0;
  return `
    <div class="number-input-group">
      <button class="btn-increment" onclick="adjustProcessLogValue(${entryIndex}, '${field}', ${-step})">−</button>
      <input type="number"
             step="${step}"
             value="${val}"
             onchange="updateProcessLogValue(${entryIndex}, '${field}', this.value)"
             onclick="this.select()">
      <button class="btn-increment" onclick="adjustProcessLogValue(${entryIndex}, '${field}', ${step})">+</button>
    </div>
  `;
}

function addProcessLogEntry() {
  const now = new Date();
  const timestamp = now.toLocaleString('ko-KR', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  });

  const newEntry = {
    timestamp: timestamp,
    cylinderTemp: 0,
    moldTemp: 0,
    injectionSpeed: 0,
    injectionPressure: 0,
    holdingPressure: 0,
    holdingTime: 0,
    coolingTime: 0,
    note: ''
  };

  processLogData.unshift(newEntry);
  saveProcessLog();
  renderProcessLog();
}

function updateProcessLogValue(index, field, value) {
  if (processLogData[index]) {
    processLogData[index][field] = parseFloat(value) || 0;
    saveProcessLog();
    // Trigger flash recommendations if modifying the first (latest) log
    if (index === 0) {
      generateFlashRecommendations();
    }
    updateCharts();
  }
}

function adjustProcessLogValue(index, field, delta) {
  if (processLogData[index]) {
    const currentValue = processLogData[index][field] || 0;
    processLogData[index][field] = Math.max(0, currentValue + delta);
    saveProcessLog();
    renderProcessLog();
    // Trigger flash recommendations if modifying the first (latest) log
    if (index === 0) {
      generateFlashRecommendations();
    }
    updateCharts();
  }
}

function updateProcessLogNote(index, value) {
  if (processLogData[index]) {
    processLogData[index].note = value;
    saveProcessLog();
  }
}

function deleteProcessLogEntry(index) {
  if (confirm('이 로그 항목을 삭제하시겠습니까?')) {
    processLogData.splice(index, 1);
    saveProcessLog();
    renderProcessLog();
  }
}

function clearProcessLog() {
  if (confirm('모든 로그 데이터를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.')) {
    if (confirm('정말로 삭제하시겠습니까? CSV로 백업하셨나요?')) {
      processLogData = [];
      saveProcessLog();
      renderProcessLog();
    }
  }
}

function exportProcessLog() {
  if (processLogData.length === 0) {
    alert('내보낼 로그 데이터가 없습니다.');
    return;
  }

  // CSV 헤더
  const headers = [
    '일시',
    '실린더 온도 (°C)',
    '금형 온도 (°C)',
    '사출속도 (mm/s)',
    '사출압력 (bar)',
    '보압 (bar)',
    '보압시간 (s)',
    '냉각시간 (s)',
    '제품 무게 (g)',
    '러너 무게 (g)',
    '총 무게 (g)',
    '비고/현상'
  ];

  // CSV 데이터 생성
  let csv = '\uFEFF'; // UTF-8 BOM for Excel
  csv += headers.join(',') + '\n';

  processLogData.forEach(entry => {
    const row = [
      entry.timestamp,
      entry.cylinderTemp,
      entry.moldTemp,
      entry.injectionSpeed,
      entry.injectionPressure,
      entry.holdingPressure,
      entry.holdingTime,
      entry.coolingTime,
      entry.partWeight || 0,
      entry.runnerWeight || 0,
      entry.totalWeight || 0,
      '"' + (entry.note || '').replace(/"/g, '""') + '"'
    ];
    csv += row.join(',') + '\n';
  });

  // 파일 다운로드
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  const timestamp = new Date().toISOString().slice(0, 10);
  link.setAttribute('href', url);
  link.setAttribute('download', `PHA_공정로그_${timestamp}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Updated functions to support weight fields
function addProcessLogEntry() {
  const now = new Date();
  const timestamp = now.toLocaleString('ko-KR', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  });

  const newEntry = {
    timestamp: timestamp,
    cylinderTemp: 0,
    moldTemp: 0,
    injectionSpeed: 0,
    injectionPressure: 0,
    holdingPressure: 0,
    holdingTime: 0,
    coolingTime: 0,
    partWeight: 0,
    runnerWeight: 0,
    totalWeight: 0,
    note: '',
    photos: []
  };

  processLogData.unshift(newEntry);
  saveProcessLog();
  renderProcessLog();
  updateCharts();

  // Show flash recommendations area (will be populated when values are entered)
  document.getElementById('flashRecommendations').style.display = 'none';
}

function renderProcessLog() {
  const tbody = document.getElementById('processLogBody');
  if (!tbody) return;

  let displayData = filteredLogData.length > 0 ? filteredLogData : processLogData;

  if (displayData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="14" class="log-empty">로그가 없습니다. "➕ 로그 추가" 버튼을 눌러 첫 기록을 시작하세요.</td></tr>';
    return;
  }

  tbody.innerHTML = displayData.map((entry, index) => {
    const realIndex = processLogData.indexOf(entry);
    return `
    <tr>
      <td><div class="log-timestamp">${entry.timestamp}</div></td>
      <td>${createNumberInput(realIndex, 'cylinderTemp', entry.cylinderTemp, 1)}</td>
      <td>${createNumberInput(realIndex, 'moldTemp', entry.moldTemp, 1)}</td>
      <td>${createNumberInput(realIndex, 'injectionSpeed', entry.injectionSpeed, 1)}</td>
      <td>${createNumberInput(realIndex, 'injectionPressure', entry.injectionPressure, 5)}</td>
      <td>${createNumberInput(realIndex, 'holdingPressure', entry.holdingPressure, 5)}</td>
      <td>${createNumberInput(realIndex, 'holdingTime', entry.holdingTime, 0.1)}</td>
      <td>${createNumberInput(realIndex, 'coolingTime', entry.coolingTime, 0.5)}</td>
      <td>${createNumberInput(realIndex, 'partWeight', entry.partWeight, 0.01)}</td>
      <td>${createNumberInput(realIndex, 'runnerWeight', entry.runnerWeight, 0.01)}</td>
      <td>${createNumberInput(realIndex, 'totalWeight', entry.totalWeight, 0.01)}</td>
      <td>
        <textarea class="log-note-input"
                  onchange="updateProcessLogNote(${realIndex}, this.value)"
                  placeholder="현상, 불량, 특이사항 기록...">${entry.note || ''}</textarea>
      </td>
      <td>
        <button class="btn-template" style="font-size:11px;padding:4px 8px" onclick="attachPhoto(${realIndex})">📷 추가</button>
        ${(entry.photos && entry.photos.length > 0) ? `<div style="font-size:11px;color:#6b7280;margin-top:4px">${entry.photos.length}장</div>` : ''}
      </td>
      <td>
        <button class="btn-delete-log" onclick="deleteProcessLogEntry(${realIndex})" title="삭제">🗑️</button>
      </td>
    </tr>
  `}).join('');
}

// Search and Filter Functions
let filteredLogData = [];

function filterProcessLog() {
  const keyword = document.getElementById('filterKeyword').value.toLowerCase();
  const dateFrom = document.getElementById('filterDateFrom').value;
  const dateTo = document.getElementById('filterDateTo').value;

  filteredLogData = processLogData.filter(entry => {
    // Keyword filter
    if (keyword && !entry.note.toLowerCase().includes(keyword)) {
      return false;
    }

    // Date filter
    if (dateFrom || dateTo) {
      const entryDate = new Date(entry.timestamp).toISOString().slice(0, 10);
      if (dateFrom && entryDate < dateFrom) return false;
      if (dateTo && entryDate > dateTo) return false;
    }

    return true;
  });

  renderProcessLog();
}

function clearFilter() {
  document.getElementById('filterKeyword').value = '';
  document.getElementById('filterDateFrom').value = '';
  document.getElementById('filterDateTo').value = '';
  filteredLogData = [];
  renderProcessLog();
}

// Template Management Functions
let processTemplates = [];

function loadTemplatesFromStorage() {
  const saved = localStorage.getItem('processTemplates');
  if (saved) {
    try {
      processTemplates = JSON.parse(saved);
    } catch (e) {
      processTemplates = [];
    }
  }
}

function saveTemplatesToStorage() {
  localStorage.setItem('processTemplates', JSON.stringify(processTemplates));
}

function saveTemplate() {
  const templateName = prompt('템플릿 이름을 입력하세요:');
  if (!templateName) return;

  if (processLogData.length === 0) {
    alert('저장할 로그 데이터가 없습니다.');
    return;
  }

  const latestEntry = processLogData[0];
  const template = {
    name: templateName,
    cylinderTemp: latestEntry.cylinderTemp,
    moldTemp: latestEntry.moldTemp,
    injectionSpeed: latestEntry.injectionSpeed,
    injectionPressure: latestEntry.injectionPressure,
    holdingPressure: latestEntry.holdingPressure,
    holdingTime: latestEntry.holdingTime,
    coolingTime: latestEntry.coolingTime,
    savedAt: new Date().toLocaleString('ko-KR')
  };

  processTemplates.push(template);
  saveTemplatesToStorage();
  alert(`템플릿 "${templateName}"이(가) 저장되었습니다.`);
}

function loadTemplate() {
  loadTemplatesFromStorage();

  if (processTemplates.length === 0) {
    alert('저장된 템플릿이 없습니다.');
    return;
  }

  const options = processTemplates.map((t, i) => `${i + 1}. ${t.name} (${t.savedAt})`).join('\n');
  const selection = prompt(`불러올 템플릿 번호를 입력하세요:\n\n${options}`);

  if (!selection) return;

  const index = parseInt(selection) - 1;
  if (index >= 0 && index < processTemplates.length) {
    const template = processTemplates[index];
    const newEntry = {
      timestamp: new Date().toLocaleString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      }),
      cylinderTemp: template.cylinderTemp,
      moldTemp: template.moldTemp,
      injectionSpeed: template.injectionSpeed,
      injectionPressure: template.injectionPressure,
      holdingPressure: template.holdingPressure,
      holdingTime: template.holdingTime,
      coolingTime: template.coolingTime,
      partWeight: 0,
      runnerWeight: 0,
      totalWeight: 0,
      note: `템플릿 "${template.name}" 적용`,
      photos: []
    };

    processLogData.unshift(newEntry);
    saveProcessLog();
    renderProcessLog();
    alert(`템플릿 "${template.name}"이(가) 적용되었습니다.`);
  } else {
    alert('올바른 번호를 입력하세요.');
  }
}

function manageTemplates() {
  loadTemplatesFromStorage();

  if (processTemplates.length === 0) {
    alert('저장된 템플릿이 없습니다.');
    return;
  }

  const options = processTemplates.map((t, i) => `${i + 1}. ${t.name} (${t.savedAt})`).join('\n');
  const selection = prompt(`삭제할 템플릿 번호를 입력하세요 (취소: 빈칸):\n\n${options}`);

  if (!selection) return;

  const index = parseInt(selection) - 1;
  if (index >= 0 && index < processTemplates.length) {
    const templateName = processTemplates[index].name;
    if (confirm(`"${templateName}" 템플릿을 삭제하시겠습니까?`)) {
      processTemplates.splice(index, 1);
      saveTemplatesToStorage();
      alert('템플릿이 삭제되었습니다.');
    }
  }
}

// Weight Calculation Functions
function calculateShotWeight() {
  const partWeight = parseFloat(document.getElementById('partWeight').value) || 0;
  const runnerWeight = parseFloat(document.getElementById('runnerWeight').value) || 0;
  const cavityCount = parseInt(document.getElementById('cavityCount').value) || 36;
  const density = parseFloat(document.getElementById('materialDensity').value) || 1.25;

  const totalWeight = (partWeight * cavityCount) + runnerWeight;
  const volume = totalWeight / density;

  document.getElementById('totalShotWeight').textContent = totalWeight.toFixed(2);
  document.getElementById('shotVolume').textContent = volume.toFixed(2);
  document.getElementById('shotWeightResult').style.display = 'block';

  // Trigger flash reduction recommendations if we have log data
  if (processLogData.length > 0) {
    generateFlashRecommendations();
  }
}

function applyWeightToLog() {
  if (processLogData.length === 0) {
    alert('먼저 로그를 추가해주세요.');
    return;
  }

  const partWeight = parseFloat(document.getElementById('partWeight').value) || 0;
  const runnerWeight = parseFloat(document.getElementById('runnerWeight').value) || 0;
  const cavityCount = parseInt(document.getElementById('cavityCount').value) || 36;
  const totalWeight = (partWeight * cavityCount) + runnerWeight;

  // Apply to the latest log (index 0)
  processLogData[0].partWeight = partWeight;
  processLogData[0].runnerWeight = runnerWeight;
  processLogData[0].totalWeight = totalWeight;

  saveProcessLog();
  renderProcessLog();
  generateFlashRecommendations();
  updateCharts();

  alert('무게 데이터가 최신 로그에 적용되었습니다!');
}

function loadDensityFromGrade() {
  // PHA density database
  const densityDB = {
    'CA1180P': 1.25,
    'S1000P': 1.24,
    'A1000P': 1.23,
    'P3HB': 1.25,
    'P3HB4HB': 1.22,
    'PHB': 1.26,
    'default': 1.25
  };

  const gradeSelect = document.getElementById('grade');
  let density = densityDB.default;

  if (gradeSelect && gradeSelect.value) {
    const grade = gradeSelect.value;
    density = densityDB[grade] || densityDB.default;
  }

  document.getElementById('materialDensity').value = density;
  calculateShotWeight();
}

// Flash Reduction Recommendation Engine
function generateFlashRecommendations() {
  if (processLogData.length === 0) return;

  const latest = processLogData[0];
  const recommendations = [];

  // Analyze conditions and generate recommendations
  if (latest.injectionPressure > 900) {
    recommendations.push({
      type: 'warning',
      title: '사출압력 과다',
      message: `현재 사출압력이 ${latest.injectionPressure} bar로 높습니다.`,
      solution: `사출압력을 ${(latest.injectionPressure - 50).toFixed(0)} bar로 감소시키세요. (약 -50 bar)`
    });
  }

  if (latest.cylinderTemp > 185) {
    recommendations.push({
      type: 'caution',
      title: '실린더 온도 과다',
      message: `현재 실린더 온도가 ${latest.cylinderTemp}°C로 높습니다.`,
      solution: `실린더 온도를 ${(latest.cylinderTemp - 5).toFixed(0)}°C로 감소시키세요. (약 -5°C, 점도 증가로 플래시 감소)`
    });
  }

  if (latest.injectionSpeed > 180) {
    recommendations.push({
      type: 'caution',
      title: '사출속도 과다',
      message: `현재 사출속도가 ${latest.injectionSpeed} mm/s로 높습니다.`,
      solution: `사출속도를 ${(latest.injectionSpeed - 20).toFixed(0)} mm/s로 감소시키세요. (약 -20 mm/s, 피크 압력 감소)`
    });
  }

  if (latest.holdingPressure > 700) {
    recommendations.push({
      type: 'caution',
      title: '보압 과다',
      message: `현재 보압이 ${latest.holdingPressure} bar로 높습니다.`,
      solution: `보압을 ${(latest.holdingPressure - 50).toFixed(0)} bar로 감소시키세요. (약 -50 bar)`
    });
  }

  if (latest.coolingTime < 12) {
    recommendations.push({
      type: 'normal',
      title: '냉각시간 부족',
      message: `현재 냉각시간이 ${latest.coolingTime}초로 짧을 수 있습니다.`,
      solution: `냉각시간을 ${(latest.coolingTime + 2).toFixed(1)}초로 증가시켜 성형 안정성을 높이세요. (약 +2s)`
    });
  }

  // Display recommendations
  if (recommendations.length > 0) {
    const html = recommendations.map(rec => `
      <div class="recommendation-item ${rec.type}">
        <h5 style="margin:0 0 8px 0;color:#1e3c72">${rec.title}</h5>
        <p style="margin:0 0 8px 0;font-size:14px">${rec.message}</p>
        <p style="margin:0;font-weight:bold;color:#059669">💡 ${rec.solution}</p>
      </div>
    `).join('');

    document.getElementById('recommendationContent').innerHTML = html;
    document.getElementById('flashRecommendations').style.display = 'block';
  } else {
    document.getElementById('recommendationContent').innerHTML = `
      <div class="recommendation-item normal">
        <h5 style="margin:0 0 8px 0;color:#1e3c72">✅ 공정 조건 양호</h5>
        <p style="margin:0;font-size:14px">현재 공정 조건은 플래시 발생 위험이 낮은 범위에 있습니다. 계속 모니터링하세요.</p>
      </div>
    `;
    document.getElementById('flashRecommendations').style.display = 'block';
  }
}

// Photo Attachment (using IndexedDB)
let photoDB;

function initPhotoStorage() {
  const request = indexedDB.open('ProcessLogPhotos', 1);

  request.onerror = () => {
    console.warn('IndexedDB not available, photo storage disabled');
  };

  request.onsuccess = (event) => {
    photoDB = event.target.result;
  };

  request.onupgradeneeded = (event) => {
    const db = event.target.result;
    if (!db.objectStoreNames.contains('photos')) {
      db.createObjectStore('photos', { keyPath: 'id', autoIncrement: true });
    }
  };
}

function attachPhoto(logIndex) {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.multiple = true;

  input.onchange = (e) => {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;

    files.forEach(file => {
      if (file.size > 5 * 1024 * 1024) {
        alert(`파일 ${file.name}이(가) 너무 큽니다 (최대 5MB)`);
        return;
      }

      const reader = new FileReader();
      reader.onload = (event) => {
        const photoData = {
          logIndex: logIndex,
          data: event.target.result,
          name: file.name,
          timestamp: new Date().toISOString()
        };

        if (photoDB) {
          const transaction = photoDB.transaction(['photos'], 'readwrite');
          const store = transaction.objectStore('photos');
          store.add(photoData);

          transaction.oncomplete = () => {
            if (!processLogData[logIndex].photos) {
              processLogData[logIndex].photos = [];
            }
            processLogData[logIndex].photos.push(photoData.name);
            saveProcessLog();
            renderProcessLog();
            alert('사진이 추가되었습니다.');
          };
        }
      };

      reader.readAsDataURL(file);
    });
  };

  input.click();
}

// Chart Visualization
let processChart;
let currentChartType = 'temp';

function initChart() {
  const ctx = document.getElementById('processChart');
  if (!ctx) return;

  processChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: []
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top'
        },
        tooltip: {
          mode: 'index',
          intersect: false
        }
      },
      scales: {
        x: {
          display: true,
          title: {
            display: true,
            text: '시간'
          }
        },
        y: {
          display: true,
          title: {
            display: true,
            text: '값'
          }
        }
      }
    }
  });

  updateCharts();
}

function showChart(type) {
  currentChartType = type;

  // Update button states
  document.querySelectorAll('.chart-toggle-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(`chartBtn${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('active');

  updateCharts();
}

function updateCharts() {
  if (!processChart) return;

  const data = processLogData.slice(0, 20).reverse();
  const labels = data.map(entry => {
    const date = new Date(entry.timestamp);
    return date.toLocaleDateString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
  });

  let datasets = [];

  switch (currentChartType) {
    case 'temp':
      datasets = [
        {
          label: '실린더 온도 (°C)',
          data: data.map(e => e.cylinderTemp),
          borderColor: '#ef4444',
          backgroundColor: 'rgba(239, 68, 68, 0.1)',
          tension: 0.3
        },
        {
          label: '금형 온도 (°C)',
          data: data.map(e => e.moldTemp),
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          tension: 0.3
        }
      ];
      break;

    case 'pressure':
      datasets = [
        {
          label: '사출압력 (bar)',
          data: data.map(e => e.injectionPressure),
          borderColor: '#8b5cf6',
          backgroundColor: 'rgba(139, 92, 246, 0.1)',
          tension: 0.3
        },
        {
          label: '보압 (bar)',
          data: data.map(e => e.holdingPressure),
          borderColor: '#10b981',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          tension: 0.3
        }
      ];
      break;

    case 'weight':
      datasets = [
        {
          label: '제품 무게 (g)',
          data: data.map(e => e.partWeight || 0),
          borderColor: '#f59e0b',
          backgroundColor: 'rgba(245, 158, 11, 0.1)',
          tension: 0.3
        },
        {
          label: '러너 무게 (g)',
          data: data.map(e => e.runnerWeight || 0),
          borderColor: '#6366f1',
          backgroundColor: 'rgba(99, 102, 241, 0.1)',
          tension: 0.3
        },
        {
          label: '총 무게 (g)',
          data: data.map(e => e.totalWeight || 0),
          borderColor: '#ec4899',
          backgroundColor: 'rgba(236, 72, 153, 0.1)',
          tension: 0.3
        }
      ];
      break;

    case 'time':
      datasets = [
        {
          label: '보압시간 (s)',
          data: data.map(e => e.holdingTime),
          borderColor: '#14b8a6',
          backgroundColor: 'rgba(20, 184, 166, 0.1)',
          tension: 0.3
        },
        {
          label: '냉각시간 (s)',
          data: data.map(e => e.coolingTime),
          borderColor: '#0ea5e9',
          backgroundColor: 'rgba(14, 165, 233, 0.1)',
          tension: 0.3
        }
      ];
      break;
  }

  processChart.data.labels = labels;
  processChart.data.datasets = datasets;
  processChart.update();
}

// Initialize on load
window.addEventListener('load', () => {
  loadTemplatesFromStorage();
  initPhotoStorage();
  if (typeof Chart !== 'undefined') {
    initChart();
  }
});
</script>

<!-- Additional scripts for dynamic material loading, troubleshooting, and photo gallery -->
<!-- See custom.js for implementation -->

  <!-- Load external script containing material/troubleshooting/photo logic -->
  <script src="custom.js"></script>

</body>
</html>
