
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PHA Process Optimizer â€“ Pro v2</title>
<style>
  :root{
    --primary:#2563eb;--primary-dark:#1e40af;--secondary:#10b981;--danger:#ef4444;--warning:#f59e0b;
    --dark:#1f2937;--light:#f9fafb;--border:#e5e7eb;--radius:12px;--shadow:0 20px 25px -5px rgba(0,0,0,.1)
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,system-ui,sans-serif;
       background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#111827;-webkit-text-size-adjust:100%}
  .container{max-width:1400px;margin:0 auto;background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;background:#111827;color:#fff;padding:18px}
  .header h1{font-size:20px;font-weight:700}
  .header-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  select#language{padding:8px 12px;border-radius:6px;border:1px solid rgba(255,255,255,.35);background:rgba(255,255,255,.12);color:#fff}
  .view-toggle{display:flex;gap:8px;background:rgba(255,255,255,.12);padding:4px;border-radius:8px}
  .view-toggle button{border:0;background:transparent;color:#fff;padding:8px 14px;border-radius:6px;cursor:pointer;font-weight:600}
  .view-toggle button.active{background:var(--primary);box-shadow:0 2px 8px rgba(37,99,235,.3)}
  .main{padding:24px}
  .tabs{display:flex;gap:8px;border-bottom:2px solid var(--border);overflow-x:auto;padding-bottom:8px}
  .tab{border:0;background:transparent;padding:10px 16px;font-weight:600;color:#374151;border-bottom:3px solid transparent;cursor:pointer;white-space:nowrap}
  .tab.active{color:var(--primary);border-bottom-color:var(--primary)}
  .tabpage{display:none;animation:fade .25s}.tabpage.active{display:block}
  @keyframes fade{from{opacity:.0;transform:translateY(6px)} to{opacity:1;transform:none}}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin:16px 0 24px}
  .group label{display:block;font-weight:700;margin:0 0 6px;color:#111827;font-size:14px}
  .group input,.group select,.group textarea{width:100%;padding:12px;border:2px solid var(--border);border-radius:8px;background:#fff;font-size:15px;transition:.2s}
  .group input:focus,.group select:focus,.group textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.15)}
  .group textarea{min-height:100px;resize:vertical}
  .hint{color:#6b7280;font-size:12px;margin-top:4px}
  .tablewrap{overflow:auto;border:1px solid var(--border);border-radius:8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
  th{background:var(--light);position:sticky;top:0}
  tr:hover{background:#f5f7ff}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;font-size:12px}
  .ok{background:#d1fae5;color:#065f46}.warn{background:#fee7c2;color:#92400e}.crit{background:#ffe1e1;color:#9b1c1c}
  .card{background:#f9fafb;border:1px solid var(--border);border-left:4px solid var(--warning);border-radius:10px;padding:16px;margin:12px 0}
  .photos{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
  .photo{position:relative;border-radius:8px;overflow:hidden;aspect-ratio:1;background:#eef2ff}
  .photo img{width:100%;height:100%;object-fit:cover}
  .photo button{position:absolute;top:6px;right:6px;width:28px;height:28px;border-radius:50%;border:0;background:var(--danger);color:#fff;font-weight:900;cursor:pointer}
  .btn{border:0;padding:12px 18px;border-radius:8px;font-weight:800;cursor:pointer}
  .btn.primary{background:var(--primary);color:#fff}.btn.secondary{background:#f3f4f6;border:2px solid var(--border)}
  .actions{display:flex;gap:12px;flex-wrap:wrap}
  .fab{position:fixed;right:18px;bottom:18px;width:56px;height:56px;border-radius:50%;border:0;background:var(--primary);color:#fff;font-size:22px;display:flex;align-items:center;justify-content:center;box-shadow:0 12px 25px rgba(37,99,235,.35);cursor:pointer}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .row .group{flex:1 1 220px}
  .muted{color:#6b7280}
  @media (max-width:768px){body{padding:0}.container{border-radius:0}.main{padding:16px}.group input,.group select,.group textarea{font-size:16px;min-height:44px}}
</style>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="icons/icon-192.png">
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ”¬ <span data-i18n="title">PHA Process Optimizer</span></h1>
    <div class="header-controls">
      <select id="language"><option value="ko">í•œêµ­ì–´</option><option value="en">English</option></select>
      <div class="view-toggle"><button id="btnDesktop" class="active" onclick="setView('desktop')">PC</button><button id="btnMobile" onclick="setView('mobile')">ğŸ“±</button></div>
    </div>
  </div>

  <div class="main">
    <div class="tabs">
      <button class="tab active" data-tab="proc" data-i18n="tab_proc">ê³µì • ì¡°ê±´</button>
      <button class="tab" data-tab="ts" data-i18n="tab_ts">íŠ¸ëŸ¬ë¸”ìŠˆíŒ…</button>
      <button class="tab" data-tab="hist" data-i18n="tab_hist">ì´ë ¥ ê´€ë¦¬</button>
      <button class="tab" data-tab="ana" data-i18n="tab_ana">ë°ì´í„° ë¶„ì„</button>
      <button class="tab" data-tab="calc" data-i18n="tab_calc">ê³„ì‚°ê¸°</button>
      <button class="tab" data-tab="props" data-i18n="tab_props">ë¬¼ì„± DB</button>
      <button class="tab" data-tab="photos" data-i18n="tab_photos">ì‚¬ì§„</button>
    </div>

    <!-- Process Conditions -->
    <section id="proc" class="tabpage active">
      <div class="grid">
        <div class="group">
          <label data-i18n="series">ìƒ˜í”Œ ì‹œë¦¬ì¦ˆ</label>
          <select id="grade" onchange="rebuildForm()"></select>
        </div>
        <div class="group">
          <label data-i18n="process">ê°€ê³µ ìœ í˜•</label>
          <select id="process" onchange="rebuildForm()">
            <option value="sheet">ì‹œíŠ¸ ì••ì¶œ (Sheet)</option>
            <option value="extrusion">í”„ë¡œíŒŒì¼/ì¼ë°˜ ì••ì¶œ (Extrusion)</option>
            <option value="injection">ì‚¬ì¶œ ì„±í˜• (Injection)</option>
            <option value="blownfilm">ë¸”ë¡œìš´ í•„ë¦„ (Blown Film)</option>
            <option value="blowmolding">ë¸”ë¡œìš° ëª°ë”© (Blow Molding)</option>
            <option value="castfilm">ìºìŠ¤íŠ¸ í•„ë¦„ (Cast Film)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="group">
          <button class="btn secondary" onclick="openRecoEditor()">ğŸ›  ê¶Œì¥ ê°€ì´ë“œ ìˆ˜ì •</button>
          <div class="hint">í˜„ì¬ ì„ íƒí•œ <b>í”„ë¡œíŒŒì¼Ã—ê³µì •</b>ì— í•œí•´ min/maxë¥¼ í¸ì§‘í•©ë‹ˆë‹¤. â€˜ì´ˆê¸°í™”â€™ë¡œ ì›ë³µ ê°€ëŠ¥.</div>
        </div>
      </div>

      <div id="dynamicFields" class="grid"></div>

      <div class="group">
        <label data-i18n="notes">ğŸ“ íŠ¹ì´ì‚¬í•­ ë©”ëª¨</label>
        <textarea id="notes" placeholder=""></textarea>
        <div class="hint" id="tsHint"></div>
      </div>

      <div class="row">
        <input id="importCSV" type="file" accept=".csv" style="display:none" />
        <input id="importJSON" type="file" accept=".json,application/json" style="display:none" />
        <button class="btn primary" onclick="saveEntry()" data-i18n="save">ì €ì¥ ë° ë¶„ì„</button>
        <button class="btn secondary" onclick="exportHistory()" data-i18n="export">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn secondary" onclick="triggerImport('csv')">CSV ê°€ì ¸ì˜¤ê¸°</button>
        <button class="btn secondary" onclick="triggerImport('json')">JSON ê°€ì ¸ì˜¤ê¸°</button>
        <button class="btn secondary" onclick="resetForm()" data-i18n="reset">ì´ˆê¸°í™”</button>
      </div>

      <div class="tablewrap" style="margin-top:18px">
        <table>
          <thead><tr>
            <th data-i18n="param">íŒŒë¼ë¯¸í„°</th><th data-i18n="current">í˜„ì¬ê°’</th>
            <th data-i18n="range">ê¶Œì¥ ë²”ìœ„</th><th data-i18n="status">ìƒíƒœ</th>
          </tr></thead>
          <tbody id="paramTable"></tbody>
        </table>
      </div>
    </section>

    <!-- Troubleshooting -->
    <section id="ts" class="tabpage">
      <div id="tsContainer"></div>
    </section>

    <!-- History -->
    <section id="hist" class="tabpage">
      <div class="tablewrap">
        <table>
          <thead><tr>
            <th data-i18n="when">ë‚ ì§œ/ì‹œê°„</th><th data-i18n="h_grade">ìƒ˜í”Œ</th><th data-i18n="h_proc">ê³µì •</th>
            <th data-i18n="h_key">ì£¼ìš” íŒŒë¼ë¯¸í„°</th><th data-i18n="h_result">ê²°ê³¼</th><th data-i18n="h_note">ë©”ëª¨</th>
          </tr></thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Analysis -->
    <section id="ana" class="tabpage" style="text-align:center">
      <div style="margin:24px 0"><h3>ğŸ“Š <span data-i18n="ana_head">ë°ì´í„° ë¶„ì„</span></h3></div>
      <div class="card" id="anaCard"><div id="anaText" class="hint">ë¶„ì„ ë°ì´í„° ë¡œë”© ì¤‘...</div></div>
    </section>

    <!-- Calculators -->
    <section id="calc" class="tabpage">
      <h3 style="margin:8px 0">ğŸ§® ê³µì • KPI ê³„ì‚°ê¸°</h3>
      <div class="card">
        <h4>â‘  ì²´ë¥˜ì‹œê°„ (Residence Time)</h4>
        <div class="row">
          <div class="group"><label>ì¬ë£Œ ë°€ë„ (ìš©ìœµ, kg/mÂ³)</label><input id="kpi_rho" type="number" placeholder="900~1250"></div>
          <div class="group"><label>í™€ë“œì—… ìš©ì  (L)</label><input id="kpi_holdVol" type="number" placeholder="ì˜ˆ: 2.5"></div>
          <div class="group"><label>í™€ë“œì—… ì§ˆëŸ‰ (kg)</label><input id="kpi_holdMass" type="number" placeholder="ë¯¸ì…ë ¥ ì‹œ ë°€ë„Ã—ìš©ì ìœ¼ë¡œ ê³„ì‚°"></div>
          <div class="group"><label>ìŠ¤ë£¨í’‹ (kg/h)</label><input id="kpi_rate" type="number" placeholder="ì˜ˆ: 15"></div>
        </div>
        <div class="hint">â€» í™€ë“œì—… ì§ˆëŸ‰ ë¯¸ì…ë ¥ ì‹œ <b>ì§ˆëŸ‰ = ë°€ë„Ã—ìš©ì /1000</b>ë¡œ ì¶”ì •.</div>
        <div class="row"><div class="group"><button class="btn primary" onclick="calcResidence()">ê³„ì‚°</button></div><div class="group"><div id="kpi_res_out" class="muted">ê²°ê³¼: -</div></div></div>
      </div>

      <div class="card">
        <h4>â‘¡ ì‚¬ì¶œí’ˆ ëƒ‰ê°ì‹œê°„ ì˜ˆì¸¡</h4>
        <div class="row">
          <div class="group"><label>ë‘ê»˜ t (mm)</label><input id="cool_t" type="number" placeholder="ì˜ˆ: 2.0"></div>
          <div class="group"><label>ì—´í™•ì‚°ìœ¨ Î± (mmÂ²/s)</label><input id="cool_alpha" type="number" placeholder="ì˜ˆ: 0.12"></div>
          <div class="group"><label>ìš©ìœµì˜¨ë„ Tm (Â°C)</label><input id="cool_Tm" type="number" placeholder="ì˜ˆ: 170"></div>
          <div class="group"><label>ê¸ˆí˜•ì˜¨ë„ Tmold (Â°C)</label><input id="cool_Tmold" type="number" placeholder="ì˜ˆ: 30"></div>
          <div class="group"><label>ì´ì ì˜¨ë„ Teject (Â°C)</label><input id="cool_Te" type="number" placeholder="ì˜ˆ: 60"></div>
        </div>
        <div class="hint">ëª¨ë¸: 1D í‰íŒ ëƒ‰ê° ê·¼ì‚¬ì¹˜ <code>t_c â‰ˆ (tÂ²/(Ï€Â²Î±))Â·ln[(T_mâˆ’T_mold)/(T_eâˆ’T_mold)]</code></div>
        <div class="row"><div class="group"><button class="btn primary" onclick="calcCooling()">ê³„ì‚°</button></div><div class="group"><div id="cool_out" class="muted">ê²°ê³¼: -</div></div></div>
      </div>

      <div class="card">
        <h4>â‘¢ ë¸”ë¡œìš´ í•„ë¦„ ë‘ê»˜</h4>
        <div class="row">
          <div class="group"><label>í† ì¶œëŸ‰ Q (kg/h)</label><input id="bf_Q" type="number" placeholder="ì˜ˆ: 20"></div>
          <div class="group"><label>ìš©ìœµ ë°€ë„ Ï (kg/mÂ³)</label><input id="bf_rho" type="number" placeholder="ì˜ˆ: 950"></div>
          <div class="group"><label>ê¸ˆí˜• ì§ê²½ D_die (mm)</label><input id="bf_D" type="number" placeholder="ì˜ˆ: 80"></div>
          <div class="group"><label>BUR</label><input id="bf_BUR" type="number" step="0.1" placeholder="ì˜ˆ: 2.5"></div>
          <div class="group"><label>í…Œì´í¬ì—… ì†ë„ v (m/min)</label><input id="bf_v" type="number" placeholder="ì˜ˆ: 30"></div>
          <div class="group"><label>ë‹¤ì´ ê°­ g (mm, ì„ íƒ)</label><input id="bf_gap" type="number" placeholder="ì˜ˆ: 1.0"></div>
        </div>
        <div class="hint">ê¸°ë³¸ì‹: <code>t â‰ˆ (Q/Ï) / (Ï€Â·D_dieÂ·BURÂ·v)</code> (Âµm ë³€í™˜ í¬í•¨). ì„ íƒì ìœ¼ë¡œ ê°­ ê¸°ë°˜ <code>t0=g/2</code>, <code>DDR=v / v_exit</code> ì‚¬ìš©.</div>
        <div class="row"><div class="group"><button class="btn primary" onclick="calcBlownFilm()">ê³„ì‚°</button></div><div class="group"><div id="bf_out" class="muted">ê²°ê³¼: -</div></div></div>
      </div>
    </section>

    <!-- Materials DB -->
    <section id="props" class="tabpage">
      <div class="row">
        <div class="group">
          <label>Grade</label>
          <select id="mat_grade"></select>
        </div>
        <div class="group">
          <label>ë™ì‘</label>
          <div class="row">
            <button class="btn secondary" onclick="importMatJSON()">JSON ê°€ì ¸ì˜¤ê¸°</button>
            <button class="btn secondary" onclick="exportMatJSON()">JSON ë‚´ë³´ë‚´ê¸°</button>
            <button class="btn secondary" onclick="editMat()">í¸ì§‘</button>
          </div>
        </div>
      </div>
      <div class="tablewrap">
        <table>
          <thead><tr><th>í•­ëª©</th><th>ê°’</th><th>ë‹¨ìœ„/ì¡°ê±´</th></tr></thead>
          <tbody id="mat_tbody"></tbody>
        </table>
      </div>
      <div class="hint">â€» ì›¹ì—ì„œ ì§ì ‘ TDS URLì„ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ CORS ì œì•½ì´ ìˆì–´, ê°„ë‹¨í•œ ë¡œì»¬ ì„œë²„ ì‚¬ìš© ë˜ëŠ” JSON ì—…ë¡œë“œ ë°©ì‹ ê¶Œì¥.</div>
      <input id="mat_file" type="file" accept="application/json,.json" style="display:none">
    </section>

    <!-- Photos Tab -->
    <section id="photos" class="tabpage">
      <h3 style="margin:8px 0">ğŸ“· <span data-i18n="photos_head">Photo Manager</span></h3>
      <div class="group">
        <button class="btn primary" onclick="triggerPhotoUpload()">ì‚¬ì§„ ì—…ë¡œë“œ</button>
        <input id="photoUpload" type="file" accept="image/*" multiple style="display:none">
      </div>
      <div id="photoGrid" class="photos"></div>
    </section>
  </div>
</div>

<button class="fab" title="Quick Save" onclick="saveEntry()">ğŸ’¾</button>

<!-- Simple modal for reco editor -->
<div id="modal" style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:9999">
  <div style="background:#fff;max-width:720px;width:92%;border-radius:12px;box-shadow:var(--shadow);padding:16px">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3>ê¶Œì¥ ê°€ì´ë“œ ìˆ˜ì •</h3>
      <button class="btn secondary" onclick="closeModal()">ë‹«ê¸°</button>
    </div>
    <div id="modalBody" class="grid" style="margin-top:8px"></div>
    <div class="row" style="margin-top:8px">
      <button class="btn primary" onclick="saveRecoOverrides()">ì €ì¥</button>
      <button class="btn secondary" onclick="resetOverridesCurrent()">í˜„ì¬ ê³µì • ì´ˆê¸°í™”</button>
      <button class="btn secondary" onclick="resetOverridesAll()">ì „ì²´ ì´ˆê¸°í™”</button>
    </div>
  </div>
</div>

<script>
/* ========= i18n ========= */
const I18N = {
  ko:{title:"PHA ê³µì • ìµœì í™” ë„êµ¬",tab_proc:"ê³µì • ì¡°ê±´",tab_ts:"íŠ¸ëŸ¬ë¸”ìŠˆíŒ…",tab_hist:"ì´ë ¥ ê´€ë¦¬",tab_ana:"ë°ì´í„° ë¶„ì„",tab_calc:"ê³„ì‚°ê¸°",tab_props:"ë¬¼ì„± DB",tab_photos:"ì‚¬ì§„",
      series:"ìƒ˜í”Œ ì‹œë¦¬ì¦ˆ",process:"ê°€ê³µ ìœ í˜•",notes:"ğŸ“ íŠ¹ì´ì‚¬í•­ ë©”ëª¨",save:"ì €ì¥ ë° ë¶„ì„",export:"ë°ì´í„° ë‚´ë³´ë‚´ê¸°",reset:"ì´ˆê¸°í™”",
      param:"íŒŒë¼ë¯¸í„°",current:"í˜„ì¬ê°’",range:"ê¶Œì¥ ë²”ìœ„",status:"ìƒíƒœ",ok:"ì •ìƒ",warn:"ì£¼ì˜",crit:"ìœ„í—˜",when:"ë‚ ì§œ/ì‹œê°„",h_grade:"ìƒ˜í”Œ",h_proc:"ê³µì •",h_key:"ì£¼ìš” íŒŒë¼ë¯¸í„°",h_result:"ê²°ê³¼",h_note:"ë©”ëª¨",
      ana_head:"ë°ì´í„° ë¶„ì„",saved:"ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.",last:"ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸",resetQ:"ëª¨ë“  ì…ë ¥ì„ ì´ˆê¸°í™”í• ê¹Œìš”?",
      photos_head:"ì‚¬ì§„ ê´€ë¦¬"
  },
  en:{title:"PHA Process Optimizer",tab_proc:"Process Conditions",tab_ts:"Troubleshooting",tab_hist:"History",tab_ana:"Data Analysis",tab_calc:"Calculators",tab_props:"Materials DB",tab_photos:"Photos",
      series:"Sample Series",process:"Process Type",notes:"ğŸ“ Process Notes",save:"Save & Analyze",export:"Export Data",reset:"Reset",
      param:"Parameter",current:"Current",range:"Recommended",status:"Status",ok:"Normal",warn:"Warning",crit:"Critical",when:"Date/Time",h_grade:"Sample",h_proc:"Process",h_key:"Main Parameters",h_result:"Result",h_note:"Memo",
      ana_head:"Data Analysis",saved:"Saved successfully.",last:"Last Update",resetQ:"Reset all inputs?",
      photos_head:"Photo Manager"
  }
};
let LANG = 'ko';

/* ========= Base profiles ========= */
const BASE={PHA_SEMI:'PHA_SEMI',PHA_AMOR:'PHA_AMOR',PLA:'PLA',PBAT:'PBAT',PBS:'PBS',PBSA:'PBSA',PHA_PLA:'PHA_PLA',PHA_PBS:'PHA_PBS',PHA_PBAT:'PHA_PBAT'};

/* ========= Grade list ========= */
const GRADES=[
  {value:'S1000P',label:'S1000P (Semi-crystalline, 2â€“5% 4HB)',profile:BASE.PHA_SEMI},
  {value:'A1000P',label:'A1000P (Amorphous, 30% 4HB)',profile:BASE.PHA_AMOR},
  {value:'CB0400A',label:'CB0400A (P34HB series) â€“ ë‚´ë¶€ê°€ì´ë“œ',profile:BASE.PHA_SEMI},
  {value:'CB0104A',label:'CB0104A (P34HB series) â€“ ë‚´ë¶€ê°€ì´ë“œ',profile:BASE.PHA_AMOR},
  /* PLA/aPHA family (from website TDS list mentioned) */
  {value:'CA1180P',label:'CA1180P (PLA/aPHA â€“ Injection)',profile:BASE.PHA_PLA},
  {value:'CA1170A',label:'CA1170A (PLA/aPHA â€“ Injection)',profile:BASE.PHA_PLA},
  {value:'CA1165A',label:'CA1165A (PLA/aPHA â€“ Injection)',profile:BASE.PHA_PLA},
  {value:'CA1670P',label:'CA1670P (PLA/aPHA â€“ Sheet/Blow Molding)',profile:BASE.PHA_PLA},
  {value:'CA1680', label:'CA1680 (PLA/aPHA â€“ Sheet/Blow Molding)',profile:BASE.PHA_PLA},
  {value:'CA1270P',label:'CA1270P (PLA/aPHA â€“ Sheet)',profile:BASE.PHA_PLA},
  /* blends + commodity */
  {value:'PLA_aPHA_90_10',label:'PLA/aPHA (A1000P 10%)',profile:BASE.PHA_PLA},
  {value:'PLA_aPHA_80_20',label:'PLA/aPHA (A1000P 20%)',profile:BASE.PHA_PLA},
  {value:'PHA_PBSA_70_30',label:'PHA/PBSA (70/30)',profile:BASE.PBSA},
  {value:'PHA_PBSA_50_50',label:'PHA/PBSA (50/50)',profile:BASE.PBSA},
  {value:'PHA_PBS_70_30',label:'PHA/PBS (70/30)',profile:BASE.PHA_PBS},
  {value:'PHA_PBS_50_50',label:'PHA/PBS (50/50)',profile:BASE.PHA_PBS},
  {value:'PHA_PBAT_70_30',label:'PHA/PBAT (70/30)',profile:BASE.PHA_PBAT},
  {value:'PHA_PBAT_50_50',label:'PHA/PBAT (50/50)',profile:BASE.PHA_PBAT},
  {value:'PLA',label:'PLA',profile:BASE.PLA},
  {value:'PBAT',label:'PBAT',profile:BASE.PBAT},
  {value:'PBS',label:'PBS',profile:BASE.PBS},
  {value:'PBSA',label:'PBSA',profile:BASE.PBSA},
];

/* ========= Recommended ranges ========= */
const GRADE_JSON={"CA1180P":"data/grades/CA1180P_talc10_wax0p3.json"};
const RECO={
  [BASE.PHA_SEMI]:{
    extrusion:{zone1:[140,155],zone2:[150,165],zone3:[160,170],zone4:[165,175],die:[165,180],screwRPM:[40,90],meltPressBar:[60,150],coolingRoll:[15,25],lineSpeed:[5,30]},
    sheet:{zone1:[140,155],zone2:[150,165],zone3:[160,170],zone4:[165,175],zone5:[165,180],die:[170,180],chillTop:[15,25],chillMid:[15,25],chillBot:[15,25],rollRPM:[10,40],lineSpeed:[5,30],targetThickness:[200,2000],meltPressBar:[60,150]},
    injection:{barrel1:[150,160],barrel2:[155,165],barrel3:[160,170],nozzle:[165,175],mold:[25,45],injSpeed:[30,120],injPressMPa:[60,120],packPressMPa:[30,70],packTime:[5,20],coolTime:[10,40],backPressBar:[30,80],screwRPM:[30,100],hold1P:[30,60],hold1T:[2,10],hold2P:[20,50],hold2T:[2,10]},
    blownfilm:{zone1:[145,155],zone2:[155,165],zone3:[160,170],zone4:[165,175],die:[165,175],bur:[1.8,3.0],flh:[200,600],takeup:[10,60],dieGap:[0.8,1.5],meltPressBar:[80,180],airTemp:[15,25]},
    blowmolding:{zone1:[150,160],zone2:[155,165],zone3:[160,170],head:[165,175],die:[165,175],accHead:[165,175],blowPressBar:[6,12],preBlowBar:[2,6],mold:[20,35],coolTime:[20,80]},
    castfilm:{zone1:[150,160],zone2:[155,165],zone3:[160,170],die:[170,180],chillTop:[10,18],lineSpeed:[10,50],targetThickness:[20,200],meltPressBar:[60,150]}
  },
  [BASE.PHA_AMOR]:{
    extrusion:{zone1:[130,145],zone2:[140,155],zone3:[150,165],zone4:[155,170],die:[160,170],screwRPM:[40,90],meltPressBar:[50,130],coolingRoll:[15,25],lineSpeed:[5,30]},
    sheet:{zone1:[130,145],zone2:[140,155],zone3:[150,160],zone4:[155,165],zone5:[155,170],die:[160,170],chillTop:[15,25],chillMid:[15,25],chillBot:[15,25],rollRPM:[10,35],lineSpeed:[5,30],targetThickness:[200,2000],meltPressBar:[50,130]},
    injection:{barrel1:[140,155],barrel2:[150,160],barrel3:[155,165],nozzle:[160,170],mold:[20,40],injSpeed:[30,120],injPressMPa:[50,100],packPressMPa:[25,60],packTime:[5,20],coolTime:[8,35],backPressBar:[20,60],screwRPM:[30,90],hold1P:[25,55],hold1T:[2,10],hold2P:[15,45],hold2T:[2,10]},
    blownfilm:{zone1:[135,145],zone2:[145,155],zone3:[150,160],zone4:[155,165],die:[160,165],bur:[1.8,3.0],flh:[200,600],takeup:[10,60],dieGap:[0.8,1.5],meltPressBar:[70,160],airTemp:[15,25]},
    blowmolding:{zone1:[140,150],zone2:[150,160],zone3:[155,165],head:[160,170],die:[160,170],accHead:[160,170],blowPressBar:[6,12],preBlowBar:[2,6],mold:[20,35],coolTime:[20,70]},
    castfilm:{zone1:[140,150],zone2:[145,155],zone3:[150,160],die:[160,170],chillTop:[10,18],lineSpeed:[10,50],targetThickness:[20,200],meltPressBar:[50,130]}
  },
  [BASE.PLA]:{
    extrusion:{zone1:[170,180],zone2:[180,190],zone3:[190,200],zone4:[195,205],die:[195,210],screwRPM:[40,80],meltPressBar:[70,150],coolingRoll:[15,25],lineSpeed:[5,30]},
    sheet:{zone1:[170,180],zone2:[180,190],zone3:[190,200],zone4:[195,205],zone5:[195,210],die:[200,210],chillTop:[15,25],chillMid:[15,25],chillBot:[15,25],rollRPM:[10,35],lineSpeed:[5,25],targetThickness:[200,2000],meltPressBar:[70,150]},
    injection:{barrel1:[180,190],barrel2:[190,200],barrel3:[195,205],nozzle:[200,210],mold:[20,35],injSpeed:[30,120],injPressMPa:[70,130],packPressMPa:[40,80],packTime:[5,20],coolTime:[10,40],backPressBar:[30,90],screwRPM:[30,90],hold1P:[40,80],hold1T:[2,10],hold2P:[30,70],hold2T:[2,10]},
    blownfilm:{zone1:[175,185],zone2:[185,195],zone3:[190,200],zone4:[195,205],die:[200,210],bur:[1.8,3.0],flh:[200,600],takeup:[10,60],dieGap:[0.8,1.5],meltPressBar:[80,180],airTemp:[15,25]},
    blowmolding:{zone1:[175,185],zone2:[185,195],zone3:[190,200],head:[200,210],die:[200,210],accHead:[200,210],blowPressBar:[6,12],preBlowBar:[2,6],mold:[15,25],coolTime:[20,80]},
    castfilm:{zone1:[180,190],zone2:[190,200],zone3:[195,205],die:[200,210],chillTop:[10,18],lineSpeed:[10,40],targetThickness:[20,200],meltPressBar:[70,150]}
  },
  [BASE.PBAT]:{
    extrusion:{zone1:[110,125],zone2:[120,135],zone3:[130,145],zone4:[135,150],die:[135,150],screwRPM:[40,90],meltPressBar:[50,120],coolingRoll:[15,25],lineSpeed:[5,30]},
    sheet:{zone1:[110,125],zone2:[120,135],zone3:[130,145],zone4:[135,150],zone5:[135,150],die:[135,150],chillTop:[15,25],chillMid:[15,25],chillBot:[15,25],rollRPM:[10,35],lineSpeed:[5,30],targetThickness:[200,2000],meltPressBar:[50,120]},
    injection:{barrel1:[120,130],barrel2:[130,140],barrel3:[135,145],nozzle:[140,150],mold:[20,35],injSpeed:[30,120],injPressMPa:[50,100],packPressMPa:[25,60],packTime:[5,18],coolTime:[8,30],backPressBar:[20,60],screwRPM:[30,90],hold1P:[25,60],hold1T:[2,10],hold2P:[15,45],hold2T:[2,10]},
    blownfilm:{zone1:[115,125],zone2:[125,135],zone3:[135,145],zone4:[140,150],die:[140,150],bur:[1.8,3.0],flh:[200,600],takeup:[10,60],dieGap:[0.8,1.5],meltPressBar:[70,150],airTemp:[15,25]},
    blowmolding:{zone1:[120,130],zone2:[130,140],zone3:[135,145],head:[140,150],die:[140,150],accHead:[140,150],blowPressBar:[5,10],preBlowBar:[2,5],mold:[20,30],coolTime:[20,60]},
    castfilm:{zone1:[120,130],zone2:[130,140],zone3:[135,145],die:[140,150],chillTop:[10,18],lineSpeed:[10,40],targetThickness:[20,200],meltPressBar:[50,120]}
  },
  [BASE.PBS]:{
    extrusion:{zone1:[140,150],zone2:[150,160],zone3:[155,165],zone4:[160,170],die:[160,170],screwRPM:[40,80],meltPressBar:[60,130],coolingRoll:[15,25],lineSpeed:[5,30]},
    sheet:{zone1:[140,150],zone2:[150,160],zone3:[155,165],zone4:[160,170],zone5:[160,170],die:[165,170],chillTop:[15,25],chillMid:[15,25],chillBot:[15,25],rollRPM:[10,35],lineSpeed:[5,30],targetThickness:[200,2000],meltPressBar:[60,130]},
    injection:{barrel1:[150,160],barrel2:[155,165],barrel3:[160,170],nozzle:[165,170],mold:[20,35],injSpeed:[30,120],injPressMPa:[60,110],packPressMPa:[30,70],packTime:[5,18],coolTime:[8,35],backPressBar:[20,60],screwRPM:[30,90],hold1P:[35,70],hold1T:[2,10],hold2P:[25,60],hold2T:[2,10]},
    blownfilm:{zone1:[145,155],zone2:[150,160],zone3:[155,165],zone4:[160,170],die:[165,170],bur:[1.8,3.0],flh:[200,600],takeup:[10,60],dieGap:[0.8,1.5],meltPressBar:[70,150],airTemp:[15,25]},
    blowmolding:{zone1:[150,160],zone2:[155,165],zone3:[160,170],head:[165,170],die:[165,170],accHead:[165,170],blowPressBar:[6,12],preBlowBar:[2,6],mold:[20,30],coolTime:[20,70]},
    castfilm:{zone1:[150,160],zone2:[155,165],zone3:[160,170],die:[165,170],chillTop:[10,18],lineSpeed:[10,40],targetThickness:[20,200],meltPressBar:[60,130]}
  },
  [BASE.PBSA]:{
    extrusion:{zone1:[125,135],zone2:[135,145],zone3:[140,150],zone4:[145,155],die:[150,160],screwRPM:[40,80],meltPressBar:[50,120],coolingRoll:[15,25],lineSpeed:[5,30]},
    sheet:{zone1:[125,135],zone2:[135,145],zone3:[140,150],zone4:[145,155],zone5:[145,160],die:[150,160],chillTop:[15,25],chillMid:[15,25],chillBot:[15,25],rollRPM:[10,35],lineSpeed:[5,30],targetThickness:[200,2000],meltPressBar:[50,120]},
    injection:{barrel1:[135,145],barrel2:[140,150],barrel3:[145,155],nozzle:[150,160],mold:[20,35],injSpeed:[30,120],injPressMPa:[50,90],packPressMPa:[25,60],packTime:[5,18],coolTime:[8,30],backPressBar:[20,60],screwRPM:[30,90],hold1P:[25,55],hold1T:[2,10],hold2P:[15,45],hold2T:[2,10]},
    blownfilm:{zone1:[130,140],zone2:[140,150],zone3:[145,155],zone4:[150,160],die:[150,160],bur:[1.8,3.0],flh:[200,600],takeup:[10,60],dieGap:[0.8,1.5],meltPressBar:[60,140],airTemp:[15,25]},
    blowmolding:{zone1:[135,145],zone2:[140,150],zone3:[145,155],head:[150,160],die:[150,160],accHead:[150,160],blowPressBar:[5,10],preBlowBar:[2,5],mold:[20,30],coolTime:[20,60]},
    castfilm:{zone1:[135,145],zone2:[140,150],zone3:[145,155],die:[150,160],chillTop:[10,18],lineSpeed:[10,40],targetThickness:[20,200],meltPressBar:[50,120]}
  },
  [BASE.PHA_PLA]:{},[BASE.PHA_PBS]:{},[BASE.PHA_PBAT]:{}
};

/* ========= Schemas ========= */
function f(id,ko,en,unit){return {id,ko,en,unit};}
const SCHEMAS={
  extrusion:[f('zone1','Zone 1 ì˜¨ë„','Zone 1 Temp','Â°C'),f('zone2','Zone 2 ì˜¨ë„','Â°C'),
             f('zone3','Zone 3 ì˜¨ë„','Â°C'),f('zone4','Zone 4 ì˜¨ë„','Â°C'),f('die','ë‹¤ì´ ì˜¨ë„','Â°C'),
             f('screwRPM','ìŠ¤í¬ë¥˜ ì†ë„','RPM'),f('meltPressBar','ìš©ìœµ ì••ë ¥','bar'),
             f('coolingRoll','ì¿¨ë§ë¡¤ ì˜¨ë„','Â°C'),f('lineSpeed','ë¼ì¸ ì†ë„','m/min')],
  sheet:[f('zone1','Zone 1 ì˜¨ë„','Â°C'),f('zone2','Zone 2 ì˜¨ë„','Â°C'),f('zone3','Zone 3 ì˜¨ë„','Â°C'),
         f('zone4','Zone 4 ì˜¨ë„','Â°C'),f('zone5','Zone 5 ì˜¨ë„','Â°C'),f('die','ë‹¤ì´ ì˜¨ë„','Â°C'),
         f('chillTop','ì¹ ë¡¤ ìƒë‹¨','Â°C'),f('chillMid','ì¹ ë¡¤ ì¤‘ë‹¨','Â°C'),f('chillBot','ì¹ ë¡¤ í•˜ë‹¨','Â°C'),
         f('rollRPM','ë¡¤ íšŒì „ìˆ˜','RPM'),f('lineSpeed','ë¼ì¸ ì†ë„','m/min'),f('targetThickness','ëª©í‘œ ë‘ê»˜','Âµm'),f('meltPressBar','ìš©ìœµ ì••ë ¥','bar')],
  injection:[f('barrel1','ë°°ëŸ´ 1','Â°C'),f('barrel2','ë°°ëŸ´ 2','Â°C'),f('barrel3','ë°°ëŸ´ 3','Â°C'),f('nozzle','ë…¸ì¦','Â°C'),
             f('mold','ê¸ˆí˜• ì˜¨ë„','Â°C'),f('injSpeed','ì‚¬ì¶œ ì†ë„','mm/s'),f('injPressMPa','ì‚¬ì¶œ ì••ë ¥','MPa'),f('packPressMPa','ë³´ì••','MPa'),
             f('packTime','ë³´ì•• ì‹œê°„','s'),f('coolTime','ëƒ‰ê° ì‹œê°„','s'),f('backPressBar','ë°±í”„ë ˆì…”','bar'),f('screwRPM','ìŠ¤í¬ë¥˜ íšŒì „ìˆ˜','RPM'),
             f('hold1P','ë³´ì••1 ì••ë ¥','MPa'),f('hold1T','ë³´ì••1 ì‹œê°„','s'),f('hold2P','ë³´ì••2 ì••ë ¥','MPa'),f('hold2T','ë³´ì••2 ì‹œê°„','s')],
  blownfilm:[f('zone1','Zone 1 ì˜¨ë„','Â°C'),f('zone2','Zone 2 ì˜¨ë„','Â°C'),f('zone3','Zone 3 ì˜¨ë„','Â°C'),f('zone4','Zone 4 ì˜¨ë„','Â°C'),
             f('die','ë‹¤ì´ ì˜¨ë„','Â°C'),f('bur','BUR','â€“'),f('flh','FLH','mm'),f('takeup','í…Œì´í¬ì—… ì†ë„','m/min'),
             f('dieGap','ë‹¤ì´ ê°­','mm'),f('meltPressBar','ìš©ìœµ ì••ë ¥','bar'),f('airTemp','ëƒ‰ê° ê³µê¸° ì˜¨ë„','Â°C')],
  blowmolding:[f('zone1','Zone 1 ì˜¨ë„','Â°C'),f('zone2','Zone 2 ì˜¨ë„','Â°C'),f('zone3','Zone 3 ì˜¨ë„','Â°C'),
               f('head','í—¤ë“œ ì˜¨ë„','Â°C'),f('die','ë‹¤ì´ ì˜¨ë„','Â°C'),f('accHead','ì–´íë®¬ë ˆì´í„° í—¤ë“œ','Â°C'),
               f('blowPressBar','ë¸”ë¡œìš° ì••ë ¥','bar'),f('preBlowBar','í”„ë¦¬ë¸”ë¡œìš° ì••ë ¥','bar'),f('mold','ê¸ˆí˜• ì˜¨ë„','Â°C'),f('coolTime','ëƒ‰ê° ì‹œê°„','s')],
  castfilm:[f('zone1','Zone 1 ì˜¨ë„','Â°C'),f('zone2','Zone 2 ì˜¨ë„','Â°C'),f('zone3','Zone 3 ì˜¨ë„','Â°C'),
            f('die','ë‹¤ì´ ì˜¨ë„','Â°C'),f('chillTop','ì¹ ë¡¤ ì˜¨ë„','Â°C'),f('lineSpeed','ë¼ì¸ ì†ë„','m/min'),f('targetThickness','ëª©í‘œ ë‘ê»˜','Âµm'),f('meltPressBar','ìš©ìœµ ì••ë ¥','bar')]
};

/* ========= Troubleshooting content ========= */
const TS={
  ko:[{title:"ğŸ”´ í‘œë©´ ê²°í•¨",items:[["ìƒ¤í¬ìŠ¤í‚¨","ë‹¤ì´ ì˜¨ë„ +5~10Â°C, ì••ë ¥ ë‚®ì¶¤, ê°€ê³µì¡°ì œ ê²€í† "],["ë©œíŠ¸ í”„ë™ì²˜","ì „ë‹¨ì†ë„ ë‚®ì¶¤, ì˜¨ë„ í”„ë¡œíŒŒì¼ ìµœì í™”, ë‹¤ì´ ê°­ ì¡°ì •"],["ë‹¤ì´ ë¼ì¸","ë‹¤ì´ ì²­ì†Œ/ì˜¨ë„ ê· ì¼í™”, ì••ë ¥ ì•ˆì •í™”"]]},
      {title:"ğŸŸ¡ ê¸°ê³„ì  ë¬¼ì„± ì €í•˜",items:[["ì¸ì¥ê°•ë„ ë¶€ì¡±","ë¶„ìëŸ‰ ì €í•˜ í™•ì¸, ê°€ê³µì˜¨ë„â†“, ì²´ë¥˜ì‹œê°„â†“"],["ì‹ ìœ¨ ê°ì†Œ","ê°€ì†Œì œ/ë¸”ë Œë“œ ë¹„ìœ¨ ì¡°ì •, ëƒ‰ê° ì†ë„ ìµœì í™”"],["ì¶©ê²© ì €í•˜","ìƒìš©í™”ì œ, ì–´ë‹ë§"]]},
      {title:"ğŸ”µ ê°€ê³µì„± ë¬¸ì œ",items:[["í† ì¶œ ë¶ˆì•ˆì •","ìŠ¤í¬ë¥˜ ì†ë„ ì•ˆì •í™”, ê±´ì¡°/ê³µê¸‰ í™•ì¸, ì˜¨ë„ ê· ì¼í™”"],["ì••ë ¥ ë³€ë™","ìŠ¤í¬ë¥˜/í•„í„° ì ê²€, ê±´ì¡°/ìˆ˜ë¶„ê´€ë¦¬"],["ìƒ‰ìƒ ë¶ˆê· ì¼","MB ë¶„ì‚° ê°œì„ , í˜¼í•© ì‹œê°„ ì¦ê°€, ì˜¨ë„ ì¬ì¡°ì •"]]},
      {title:"ğŸŸ¢ ì—´ì  íŠ¹ì„± ì´ìŠˆ",items:[["ì—´ë³€í˜• ë‚®ìŒ","ê²°ì •í™”ë„â†‘, í•µì œ, ì–´ë‹ë§ ìµœì í™”"],["ìš©ìœµ ê±°ë™ ì´ìƒ","DSC, ë¸”ë Œë“œ ê· ì¼ì„± í™•ì¸, ì´ë ¥ ê²€í† "],["ì—´ì•ˆì •ì„± ë¶€ì¡±","AO íŒ¨í‚¤ì§€ ë³´ê°•, ì˜¨ë„/ì²´ë¥˜ ìµœì†Œí™”"]]}],
  en:[{title:"ğŸ”´ Surface Defects",items:[["Sharkskin","Raise die temp +5â€“10Â°C, reduce pressure, processing aid"],["Melt Fracture","Lower shear rate, optimize temp profile, adjust die gap"],["Die Lines","Clean die / improve temperature uniformity / stabilize pressure"]]},
      {title:"ğŸŸ¡ Mechanical",items:[["Low Tensile","Check MW degradation; lower temp; shorten residence"],["Low Elongation","Tune plasticizer/blend; optimize cooling"],["Low Impact","Compatibilizer; anneal"]]},
      {title:"ğŸ”µ Processability",items:[["Output Instability","Stabilize screw speed; dry feed; improve uniformity"],["Pressure Variation","Inspect screw/filter; drying & moisture control"],["Color Inconsistency","Improve MB dispersion; longer mixing; retune"]]},
      {title:"ğŸŸ¢ Thermal",items:[["Low HDT","Increase crystallinity; nucleating agent; anneal"],["Abnormal Melting","DSC; blend uniformity; history review"],["Poor Thermal Stability","Reinforce AO; minimize temp/residence"]]}
]};

/* ========= Materials DB (editable, import/export) ========= */
const MAT_DEFAULT={
  "S1000P":{"density_g_cm3":1.24,"MFR_g_10min_190_2_16":null,"Tg_C":null,"Tm_C":170,"Tc_C":null,"tensile_MPa":null,"elongation_%":null,"izod_kJ_m2":null,"HDT_C":null},
  "A1000P":{"density_g_cm3":1.18,"MFR_g_10min_190_2_16":null,"Tg_C":null,"Tm_C":160,"Tc_C":null,"tensile_MPa":null,"elongation_%":null,"izod_kJ_m2":null,"HDT_C":null},
  "CB0400A":{},"CB0104A":{},
  "CA1180P":{"density_g_cm3":1.26,"MFR_g_10min_190_2_16":7,"Tg_C":-15,"Tm_C":162,"tensile_MPa":52,"elongation_%":23,"izod_kJ_m2":63,"HDT_C":51},"CA1170A":{},"CA1165A":{},"CA1670P":{},"CA1680":{},"CA1270P":{}
};
const MAT_KEY_ORDER=[
  ["density_g_cm3","ë°€ë„","g/cmÂ³"],["MFR_g_10min_190_2_16","MFR","g/10min @190Â°C/2.16kg"],
  ["Tg_C","Tg","Â°C"],["Tm_C","Tm","Â°C"],["Tc_C","Tc","Â°C"],
  ["tensile_MPa","ì¸ì¥ê°•ë„","MPa"],["elongation_%","ì‹ ìœ¨","%"],["izod_kJ_m2","ì•„ì´ì¡°ë“œ","kJ/mÂ²"],["HDT_C","HDT","Â°C"]
];

/* ========= Utilities ========= */
function $(id){return document.getElementById(id)}; function allSel(s){return Array.from(document.querySelectorAll(s))};
function setView(v){document.querySelector('.container').style.maxWidth=(v==='mobile'?'100%':'1400px');$('btnDesktop').classList.toggle('active',v==='desktop');$('btnMobile').classList.toggle('active',v==='mobile')}
function i18nApply(){allSel('[data-i18n]').forEach(el=>{const k=el.dataset.i18n; if(I18N[LANG][k]) el.textContent=I18N[LANG][k];});
  $('notes').placeholder=(LANG==='ko'?'ê°€ê³µ ì¤‘ íŠ¹ì´ì‚¬í•­/ê°œì„  ì•„ì´ë””ì–´ ê¸°ë¡':'Record anomalies or ideas');
  $('tsHint').textContent=(LANG==='ko'?I18N.ko.last:I18N.en.last)+': '+new Date().toLocaleString(LANG==='ko'?'ko-KR':'en-US'); renderTS(); renderHistory(); refreshParamTable(); renderMat()}
function renderTS(){
  const cont = $('tsContainer');
  cont.innerHTML = '';
  // Use dynamic troubleshooting data if available
  if (window.tsData && Array.isArray(window.tsData)) {
    const groups = {};
    window.tsData.forEach(item => {
      const proc = item.process || 'general';
      if (!groups[proc]) groups[proc] = [];
      groups[proc].push(item);
    });
    Object.keys(groups).forEach(proc => {
      const card = document.createElement('div');
      card.className = 'card';
      const procName = proc.charAt(0).toUpperCase() + proc.slice(1);
      let html = `<h3 style="margin-bottom:8px">${procName}</h3>`;
      groups[proc].forEach(item => {
        html += `<h4 style="margin-top:12px">${item.symptom}</h4>`;
        if (item.likely_causes && item.likely_causes.length) {
          html += `<strong>Likely causes:</strong><ul>` + item.likely_causes.map(x => `<li>${x}</li>`).join('') + `</ul>`;
        }
        if (item.diagnostics) {
          html += `<strong>Diagnostics:</strong><p>${item.diagnostics}</p>`;
        }
        if (item.quick_fixes && item.quick_fixes.length) {
          html += `<strong>Quick fixes:</strong><ul>` + item.quick_fixes.map(x => `<li>${x}</li>`).join('') + `</ul>`;
        }
        if (item.root_fixes && item.root_fixes.length) {
          html += `<strong>Root fixes:</strong><ul>` + item.root_fixes.map(x => `<li>${x}</li>`).join('') + `</ul>`;
        }
        if (item.control_knobs && item.control_knobs.length) {
          html += `<strong>Control knobs:</strong><p>${item.control_knobs.join(', ')}</p>`;
        }
        if (item.notes) {
          html += `<p><em>${item.notes}</em></p>`;
        }
      });
      card.innerHTML = html;
      cont.appendChild(card);
    });
    return;
  }
  // fallback to legacy categories if no dynamic data
  for (const b of TS[LANG]) {
    const d = document.createElement('div');
    d.className = 'card';
    let html = `<h3 style="margin-bottom:8px">${b.title}</h3><ul style="list-style:none;padding-left:0">`;
    for (const [n, s] of b.items) {
      html += `<li style="margin:6px 0"><b>${n}:</b> ${s}</li>`;
    }
    html += '</ul>';
    d.innerHTML = html;
    cont.appendChild(d);
  }
}

/* ========= Grade & profile helpers ========= */
function buildGradeOptions(){const sel=$('grade'); sel.innerHTML=''; GRADES.forEach(g=>{const o=document.createElement('option');o.value=g.value;o.textContent=g.label;sel.appendChild(o)});
  const msel=$('mat_grade'); msel.innerHTML=''; GRADES.forEach(g=>{const o=document.createElement('option');o.value=g.value;o.textContent=g.value;msel.appendChild(o)});}
function profileOf(grade){const g=GRADES.find(x=>x.value===grade); return g?g.profile:BASE.PHA_SEMI}
function mixReco(a,b,alpha){const out={}; for(const k of Object.keys(a)){if(!b[k]){out[k]=a[k];continue} out[k]=[ Math.round(a[k][0]*(1-alpha)+b[k][0]*alpha), Math.round(a[k][1]*(1-alpha)+b[k][1]*alpha) ];} return out}
function getReco(profile,proc){
  // overrides
  const ov = JSON.parse(localStorage.getItem('reco_overrides')||'{}');
  let base;
  if(RECO[profile] && RECO[profile][proc]) base=RECO[profile][proc];
  else if(profile===BASE.PHA_PLA) base=mixReco(RECO[BASE.PHA_AMOR][proc],RECO[BASE.PLA][proc],.5);
  else if(profile===BASE.PHA_PBS) base=mixReco(RECO[BASE.PHA_SEMI][proc],RECO[BASE.PBS][proc],.5);
  else if(profile===BASE.PHA_PBAT) base=mixReco(RECO[BASE.PHA_AMOR][proc],RECO[BASE.PBAT][proc],.5);
  else base=RECO[BASE.PHA_SEMI][proc];
  // apply overrides
  const key=profile+'__'+proc; if(ov[key]){base={...base,...ov[key]}}
  return base;
}

/* ========= Dynamic form ========= */
function rebuildForm(){
  const proc=$('process').value, grade=$('grade').value, profile=profileOf(grade), schema=SCHEMAS[proc], rec=getReco(profile,proc);
  const wrap=$('dynamicFields'); wrap.innerHTML='';
  for(const fld of schema){
    const id='f_'+fld.id, label = fld.ko + (fld.unit?` (${fld.unit})`:''); const div=document.createElement('div'); div.className='group';
    div.innerHTML=`<label for="${id}">${label}</label><input id="${id}" type="number" inputmode="decimal" placeholder="${rec[fld.id]?rec[fld.id][0]+'-'+rec[fld.id][1]:''}">`;
    wrap.appendChild(div);
  }
  refreshParamTable();
}

/* ========= Table/status ========= */
function statusOf(v,r){if(v===''||v==null||isNaN(v)) return 'warn'; const x=parseFloat(v); if(x>=r[0]&&x<=r[1])return'ok'; if(x<r[0]-10||x>r[1]+10)return'crit'; return'warn'}
function refreshParamTable(){
  const proc=$('process').value, grade=$('grade').value, profile=profileOf(grade), schema=SCHEMAS[proc], rec=getReco(profile,proc);
  const tb=$('paramTable'); tb.innerHTML='';
  schema.forEach(f=>{const val=$('f_'+f.id)?.value||''; const range=rec[f.id]||['-','-']; const s=statusOf(val,range);
    const cls=s==='ok'?'ok':(s==='crit'?'crit':'warn'); const sText=(LANG==='ko'?(s==='ok'?'ì •ìƒ':s==='crit'?'ìœ„í—˜':'ì£¼ì˜'):(s==='ok'?'Normal':s==='crit'?'Critical':'Warning'));
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${f.ko}${f.unit?' ('+f.unit+')':''}</td><td>${val||'-'}</td><td>${range[0]}-${range[1]}</td><td><span class="badge ${cls}">${sText}</span></td>`; tb.appendChild(tr);
  });
}

/* ========= Save/History/Import/Export ========= */
function collectEntry(){const proc=$('process').value, grade=$('grade').value, schema=SCHEMAS[proc]; const data={ts:new Date().toISOString(),proc,grade,params:{},notes:$('notes').value};
  schema.forEach(f=> data.params[f.id]=$('f_'+f.id)?.value||''); return data;}
function saveEntry(){const data=collectEntry(); const hist=JSON.parse(localStorage.getItem('pha_hist')||'[]'); hist.push(data); localStorage.setItem('pha_hist',JSON.stringify(hist)); alert(I18N[LANG].saved); renderHistory(); analyze();}
function exportHistory(){const hist=JSON.parse(localStorage.getItem('pha_hist')||'[]'); const blob=new Blob([JSON.stringify(hist,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`pha_history_${new Date().toISOString().slice(0,10)}.json`; a.click();}
function renderHistory(){const hist=JSON.parse(localStorage.getItem('pha_hist')||'[]').slice().reverse(); const tb=$('histBody'); tb.innerHTML='';
  hist.slice(0,200).forEach(r=>{const k=Object.entries(r.params).filter(([,v])=>v).slice(0,4).map(([k,v])=>k+':'+v).join(', ');
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${new Date(r.ts).toLocaleString(LANG==='ko'?'ko-KR':'en-US')}</td><td>${r.grade}</td><td>${r.proc}</td><td>${k}</td><td><span class="badge ok">${LANG==='ko'?'ì™„ë£Œ':'Complete'}</span></td><td>${r.notes||'-'}</td>`; tb.appendChild(tr);});}
function triggerImport(type){(type==='csv'?$('importCSV'):$('importJSON')).click();}
$('importCSV').addEventListener('change', e=>{const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>importCSV(r.result); r.readAsText(f,'utf-8'); e.target.value='';});
$('importJSON').addEventListener('change', e=>{const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{try{const arr=JSON.parse(r.result); if(Array.isArray(arr)){ const hist=JSON.parse(localStorage.getItem('pha_hist')||'[]'); hist.push(...arr); localStorage.setItem('pha_hist',JSON.stringify(hist)); renderHistory(); alert('JSON import ì™„ë£Œ'); } else alert('JSON í˜•ì‹ ì˜¤ë¥˜'); }catch(err){alert('JSON íŒŒì‹± ì‹¤íŒ¨')}}; r.readAsText(f,'utf-8'); e.target.value='';});
function importCSV(text){const lines=text.trim().split(/\r?\n/); const head=lines[0].split(',').map(s=>s.trim()); const hist=JSON.parse(localStorage.getItem('pha_hist')||'[]');
  for(let i=1;i<lines.length;i++){const cols=lines[i].split(','); if(cols.length<3) continue; const obj={ts:cols[head.indexOf('ts')]||new Date().toISOString(),grade:cols[head.indexOf('grade')]||'S1000P',proc:cols[head.indexOf('proc')]||'extrusion',params:{},notes:cols[head.indexOf('notes')]||''};
    head.forEach((h,idx)=>{if(!['ts','grade','proc','notes'].includes(h)) obj.params[h]=cols[idx]}); hist.push(obj);}
  localStorage.setItem('pha_hist',JSON.stringify(hist)); renderHistory(); alert('CSV import ì™„ë£Œ')}

/* ========= Reco editor (overrides) ========= */
function openRecoEditor(){const proc=$('process').value, grade=$('grade').value, profile=profileOf(grade), rec=getReco(profile,proc), schema=SCHEMAS[proc];
  const body=$('modalBody'); body.innerHTML=''; schema.forEach(f=>{const r=rec[f.id]||['','']; const div=document.createElement('div'); div.className='group';
    div.innerHTML=`<label>${f.ko}${f.unit?' ('+f.unit+')':''}</label><div class="row"><input id="ov_${f.id}_min" type="number" placeholder="min" value="${r[0]}"><input id="ov_${f.id}_max" type="number" placeholder="max" value="${r[1]}"></div>`; body.appendChild(div);});
  $('modal').style.display='flex';}
function closeModal(){$('modal').style.display='none'}
function saveRecoOverrides(){const proc=$('process').value, profile=profileOf($('grade').value), schema=SCHEMAS[proc]; const key=profile+'__'+proc;
  const ov=JSON.parse(localStorage.getItem('reco_overrides')||'{}'); ov[key]=ov[key]||{}; schema.forEach(f=>{const min=parseFloat($('ov_'+f.id+'_min').value); const max=parseFloat($('ov_'+f.id+'_max').value); if(!isNaN(min)&&!isNaN(max)) ov[key][f.id]=[min,max];}); localStorage.setItem('reco_overrides',JSON.stringify(ov)); closeModal(); rebuildForm();}
function resetOverridesCurrent(){const proc=$('process').value, profile=profileOf($('grade').value); const key=profile+'__'+proc; const ov=JSON.parse(localStorage.getItem('reco_overrides')||'{}'); delete ov[key]; localStorage.setItem('reco_overrides',JSON.stringify(ov)); rebuildForm(); alert('í˜„ì¬ ê³µì •ì˜ ìˆ˜ì •ê°’ì„ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.')}
function resetOverridesAll(){localStorage.removeItem('reco_overrides'); rebuildForm(); alert('ëª¨ë“  ìˆ˜ì •ê°’ ì´ˆê¸°í™” ì™„ë£Œ')}

/* ========= Calculators ========= */
function calcResidence(){const rho=parseFloat($('kpi_rho').value||'0'); const vL=parseFloat($('kpi_holdVol').value||'0'); let m=parseFloat($('kpi_holdMass').value||'0'); const rate=parseFloat($('kpi_rate').value||'0');
  if(!m && rho && vL){m=rho*(vL/1000)} if(!m||!rate){$('kpi_res_out').textContent='ì…ë ¥ ë¶€ì¡±'; return} const t_min=60*m/rate; $('kpi_res_out').textContent=`ì²´ë¥˜ì‹œê°„ â‰ˆ ${t_min.toFixed(2)} ë¶„`}
function calcCooling(){const t=parseFloat($('cool_t').value||'0'); const a=parseFloat($('cool_alpha').value||'0'); const Tm=parseFloat($('cool_Tm').value||'0'); const Tmold=parseFloat($('cool_Tmold').value||'0'); const Te=parseFloat($('cool_Te').value||'0');
  if(!t||!a||!Tm||!Tmold||!Te){$('cool_out').textContent='ì…ë ¥ ë¶€ì¡±'; return} const num=Math.max( (Tm-Tmold)/(Te-Tmold), 1.0001); const tc=( (t*t)/(Math.PI*Math.PI*a) ) * Math.log(num); $('cool_out').textContent=`ëƒ‰ê°ì‹œê°„ â‰ˆ ${tc.toFixed(1)} s`}
function calcBlownFilm(){const Q=parseFloat($('bf_Q').value||'0'); const rho=parseFloat($('bf_rho').value||'0'); const Dmm=parseFloat($('bf_D').value||'0'); const BUR=parseFloat($('bf_BUR').value||'0'); const v=parseFloat($('bf_v').value||'0'); const gap=parseFloat($('bf_gap').value||'0');
  if(!Q||!rho||!Dmm||!BUR||!v){$('bf_out').textContent='ì…ë ¥ ë¶€ì¡±'; return} const Qm3s=(Q/rho)/3600; const D=Dmm/1000; const vs=v/60; const t_m=Qm3s/(Math.PI*D*BUR*vs); const t_um=t_m*1e6;
  let txt=`í‰ê·  ë‘ê»˜ â‰ˆ ${t_um.toFixed(1)} Âµm`; if(gap){const t0=gap/2/1000; const A= Math.PI*D*(gap/1000); const v_exit=Qm3s/A; const DDR=vs/v_exit; const t2_um=(t0/(BUR*DDR))*1e6; txt += ` / ê°­-ê¸°ë°˜ ì¶”ì • â‰ˆ ${t2_um.toFixed(1)} Âµm (DDR=${DDR.toFixed(2)})`;} $('bf_out').textContent=txt}

/* ========= Materials DB ========= */
function getMatDB(){const raw=localStorage.getItem('mat_db'); if(raw) return JSON.parse(raw); return JSON.parse(JSON.stringify(MAT_DEFAULT));}
function setMatDB(db){localStorage.setItem('mat_db',JSON.stringify(db))}
function renderMat(){const db=getMatDB(); const g=$('mat_grade').value||'S1000P'; const rec=db[g]||{}; const tb=$('mat_tbody'); tb.innerHTML='';
  MAT_KEY_ORDER.forEach(([k,nm,unit])=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${nm}</td><td>${rec[k]??''}</td><td class="muted">${unit}</td>`; tb.appendChild(tr);});}
$('mat_grade').addEventListener('change',renderMat);
function importMatJSON(){const inp=$('mat_file'); inp.onchange=(e)=>{const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{try{const obj=JSON.parse(r.result); const db=getMatDB(); Object.assign(db,obj); setMatDB(db); renderMat(); alert('ë¬¼ì„± DB import ì™„ë£Œ');}catch(err){alert('JSON íŒŒì‹± ì‹¤íŒ¨')}}; r.readAsText(f,'utf-8'); inp.value='';}; inp.click();}
function exportMatJSON(){const blob=new Blob([JSON.stringify(getMatDB(),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='materials_db.json'; a.click();}
function editMat(){const db=getMatDB(); const g=$('mat_grade').value||'S1000P'; const rec=Object.assign({},db[g]||{}); const vals={}; let html='<div class="grid">';
  MAT_KEY_ORDER.forEach(([k,nm])=>{const v=rec[k]??''; html+=`<div class="group"><label>${nm}</label><input id="mat_${k}" type="number" step="any" value="${v}"></div>`}); html+='</div>';
  const body=$('modalBody'); body.innerHTML=html; $('modal').style.display='flex';
  // Replace modal buttons temporarily
  const save=window.saveRecoOverrides; const resetC=window.resetOverridesCurrent; const resetA=window.resetOverridesAll;
  window.saveRecoOverrides=function(){const rec2={}; MAT_KEY_ORDER.forEach(([k])=>{const v=$('mat_'+k).value; if(v!=='') rec2[k]=parseFloat(v)}); db[g]=rec2; setMatDB(db); renderMat(); alert('ì €ì¥ ì™„ë£Œ'); closeModal(); window.saveRecoOverrides=save; window.resetOverridesCurrent=resetC; window.resetOverridesAll=resetA;};
  window.resetOverridesCurrent=function(){db[g]={}; setMatDB(db); renderMat(); alert('ì´ˆê¸°í™” ì™„ë£Œ')};
  window.resetOverridesAll=function(){localStorage.removeItem('mat_db'); renderMat(); alert('ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ')};
}

/* ========= Tabs & events ========= */
allSel('.tab').forEach(btn=> btn.addEventListener('click', e=>{const to=e.currentTarget.dataset.tab; allSel('.tab').forEach(b=>b.classList.remove('active')); e.currentTarget.classList.add('active'); allSel('.tabpage').forEach(p=>p.classList.remove('active')); $(to).classList.add('active');}));
document.addEventListener('input', e=>{ if(e.target && e.target.id && e.target.id.startsWith('f_')) refreshParamTable(); });
$('language').addEventListener('change',e=>{LANG=e.target.value; i18nApply();});

/* ========= Init ========= */
(function init(){
  buildGradeOptions();
  $('grade').value='S1000P'; $('process').value='extrusion'; rebuildForm(); i18nApply(); renderHistory(); analyze(); renderMat();
})();
function analyze(){const hist=JSON.parse(localStorage.getItem('pha_hist')||'[]'); const n=hist.length; const t=(n? (LANG==='ko'?'ìµœê·¼ ì €ì¥: ':'Last: ')+new Date(hist[n-1].ts).toLocaleString(LANG==='ko'?'ko-KR':'en-US')+' Â· '+hist[n-1].grade+' Â· '+hist[n-1].proc : (LANG==='ko'?'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.':'No data yet.')); $('anaText').textContent=t;}
function resetForm(){if(!confirm(I18N[LANG].resetQ)) return; $('notes').value=''; rebuildForm();}
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(console.error);
  });
}
</script>

<script>
(function(){
  function ensureCA1180PMat(){
    try{
      const raw=localStorage.getItem('mat_db'); const db = raw? JSON.parse(raw): {};
      if(!db['CA1180P'] || Object.keys(db['CA1180P']).length===0){
        db['CA1180P']={"density_g_cm3":1.26,"MFR_g_10min_190_2_16":7,"Tg_C":-15,"Tm_C":162,"tensile_MPa":52,"elongation_%":23,"izod_kJ_m2":63,"HDT_C":51};
        localStorage.setItem('mat_db', JSON.stringify(db));
      }
    }catch(e){console.warn(e);}
  }
  async function applyCA1180P(){
    ensureCA1180PMat();
    const url = (window.GRADE_JSON && GRADE_JSON['CA1180P']) || 'data/grades/CA1180P_talc10_wax0p3.json';
    try{
      const res = await fetch(url + '?v=' + Date.now());
      if(!res.ok) return;
      const prof = await res.json();
      const ov = JSON.parse(localStorage.getItem('reco_overrides')||'{}');
      const key = 'PHA_PLA__injection';
      ov[key]=ov[key]||{};
      const t=prof.processing?.temps_c||{};
      function setR(name,obj){ if(!obj) return; ov[key][name]=[Number(obj.min), Number(obj.max)]; }
      setR('barrel1', t.zone1); setR('barrel2', t.zone2); setR('barrel3', t.zone3||t.zone3_meter); setR('nozzle', t.nozzle);
      const mold=prof.processing?.mold_temp_c?.lowHDT; if(mold){ ov[key]['mold']=[mold.min, mold.max]; }
      const inj=prof.processing?.injection?.speed_mm_s; if(inj){ const a=Math.min(inj.stage1||inj.stage2, inj.stage2||inj.stage1); const b=Math.max(inj.stage1||inj.stage2, inj.stage2||inj.stage1); ov[key]['injSpeed']=[a,b]; }
      const hold=prof.processing?.holding_profile||[];
      if(hold[0]?.pressure_bar!=null){ const p=hold[0].pressure_bar*0.1; ov[key]['hold1P']=[p*0.9,p*1.1]; ov[key]['hold1T']=[hold[0].time_s,hold[0].time_s]; }
      if(hold[1]?.pressure_bar!=null){ const p=hold[1].pressure_bar*0.1; ov[key]['hold2P']=[p*0.9,p*1.1]; ov[key]['hold2T']=[hold[1].time_s,hold[1].time_s]; }
      const screw=prof.processing?.screw||{};
      if(screw.back_pressure_bar!=null){ ov[key]['backPressBar']=[Math.max(1,screw.back_pressure_bar-2), screw.back_pressure_bar+2]; }
      if(screw.rpm!=null){ ov[key]['screwRPM']=[Math.max(20,screw.rpm-20), screw.rpm+20]; }
      localStorage.setItem('reco_overrides', JSON.stringify(ov));
      console.log('CA1180P profile applied');
      if(window.rebuildForm) rebuildForm();
    }catch(e){ console.warn('CA1180P load failed', e); }
  }
  window.addEventListener('load', ()=>{
    const g=$('grade'); if(g){ g.value='CA1180P'; }
    const p=$('process'); if(p){ p.value='injection'; }
    applyCA1180P();
  });
})();
</script>

<!-- Additional scripts for dynamic material loading, troubleshooting, and photo gallery -->
<!-- See custom.js for implementation -->

  <!-- Load external script containing material/troubleshooting/photo logic -->
  <script src="custom.js"></script>

</body>
</html>
